# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/arm_authorizer_server/arm_authorizer_server.proto)

"""
Use arm authorization.
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====
class RejectionReason(IntEnum):
    """The rejection reason"""

    GENERIC = 0
    NONE = 1
    INVALID_WAYPOINT = 2
    TIMEOUT = 3
    AIRSPACE_IN_USE = 4
    BAD_WEATHER = 5


# ===== Result Enums =====
class ArmAuthorizerServerResult(IntEnum):
    """The result"""

    UNKNOWN = 0
    SUCCESS = 1
    FAILED = 2


# ===== Internal C Structures =====

# ===== Structures =====


# ===== Plugin =====
class ArmAuthorizerServer:
    """Use arm authorization."""

    def __init__(self, server_component):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if server_component is None:
            raise ValueError("server_component cannot be None")

        component_handle = server_component._handle

        if not component_handle:
            raise ValueError("server_component handle is null")

        self._handle = self._lib.mavsdk_arm_authorizer_server_create(component_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create ArmAuthorizerServer plugin - C function returned null handle"
            )

    def subscribe_arm_authorization(self, callback: Callable, user_data: Any = None):
        """Subscribe to arm authorization request messages. Each request received should respond to using RespondArmAuthorization"""

        def c_callback(c_data, ud):
            try:
                py_data = c_data

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in arm_authorization callback: {e}")

        cb = ArmAuthorizationCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_arm_authorizer_server_subscribe_arm_authorization(
            self._handle, cb, None
        )

    def unsubscribe_arm_authorization(self, handle: ctypes.c_void_p):
        """Unsubscribe from arm_authorization"""
        self._lib.mavsdk_arm_authorizer_server_unsubscribe_arm_authorization(
            self._handle, handle
        )

    def accept_arm_authorization(self, valid_time_s):
        """Get accept_arm_authorization (blocking)"""

        result_code = self._lib.mavsdk_arm_authorizer_server_accept_arm_authorization(
            self._handle,
            valid_time_s,
        )
        result = ArmAuthorizerServerResult(result_code)
        if result != ArmAuthorizerServerResult.SUCCESS:
            raise Exception(f"accept_arm_authorization failed: {result}")

        return result

    def reject_arm_authorization(self, temporarily, reason, extra_info):
        """Get reject_arm_authorization (blocking)"""

        result_code = self._lib.mavsdk_arm_authorizer_server_reject_arm_authorization(
            self._handle,
            temporarily,
            reason,
            extra_info,
        )
        result = ArmAuthorizerServerResult(result_code)
        if result != ArmAuthorizerServerResult.SUCCESS:
            raise Exception(f"reject_arm_authorization failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_arm_authorizer_server_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
ArmAuthorizationCallback = ctypes.CFUNCTYPE(None, ctypes.c_uint32, ctypes.c_void_p)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_arm_authorizer_server_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_arm_authorizer_server_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_arm_authorizer_server_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_arm_authorizer_server_destroy.restype = None


_cmavsdk_lib.mavsdk_arm_authorizer_server_subscribe_arm_authorization.argtypes = [
    ctypes.c_void_p,
    ArmAuthorizationCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_arm_authorizer_server_subscribe_arm_authorization.restype = (
    ctypes.c_void_p
)
# Unsubscribe
_cmavsdk_lib.mavsdk_arm_authorizer_server_unsubscribe_arm_authorization.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_arm_authorizer_server_unsubscribe_arm_authorization.restype = None


_cmavsdk_lib.mavsdk_arm_authorizer_server_accept_arm_authorization.argtypes = [
    ctypes.c_void_p,
    ctypes.c_int32,
]

_cmavsdk_lib.mavsdk_arm_authorizer_server_accept_arm_authorization.restype = (
    ctypes.c_int
)

_cmavsdk_lib.mavsdk_arm_authorizer_server_reject_arm_authorization.argtypes = [
    ctypes.c_void_p,
    ctypes.c_bool,
    ctypes.c_int,
    ctypes.c_int32,
]

_cmavsdk_lib.mavsdk_arm_authorizer_server_reject_arm_authorization.restype = (
    ctypes.c_int
)
