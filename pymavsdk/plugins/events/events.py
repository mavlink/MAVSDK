# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/events/events.proto)

"""
Get event notifications, such as takeoff, or arming checks
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====
class LogLevel(IntEnum):
    """Log level type"""

    EMERGENCY = 0
    ALERT = 1
    CRITICAL = 2
    ERROR = 3
    WARNING = 4
    NOTICE = 5
    INFO = 6
    DEBUG = 7


# ===== Result Enums =====
class EventsResult(IntEnum):
    """Possible results returned"""

    SUCCESS = 0
    NOT_AVAILABLE = 1
    CONNECTION_ERROR = 2
    UNSUPPORTED = 3
    DENIED = 4
    FAILED = 5
    TIMEOUT = 6
    NO_SYSTEM = 7
    UNKNOWN = 8


# ===== Internal C Structures =====
class EventCStruct(ctypes.Structure):
    """
    Internal C structure for Event.
    Used only for C library communication.
    """

    _fields_ = [
        ("compid", ctypes.c_uint32),
        ("message", ctypes.c_char_p),
        ("description", ctypes.c_char_p),
        ("log_level", ctypes.c_int),
        ("event_namespace", ctypes.c_char_p),
        ("event_name", ctypes.c_char_p),
    ]


class HealthAndArmingCheckProblemCStruct(ctypes.Structure):
    """
    Internal C structure for HealthAndArmingCheckProblem.
    Used only for C library communication.
    """

    _fields_ = [
        ("message", ctypes.c_char_p),
        ("description", ctypes.c_char_p),
        ("log_level", ctypes.c_int),
        ("health_component", ctypes.c_char_p),
    ]


class HealthAndArmingCheckModeCStruct(ctypes.Structure):
    """
    Internal C structure for HealthAndArmingCheckMode.
    Used only for C library communication.
    """

    _fields_ = [
        ("mode_name", ctypes.c_char_p),
        ("can_arm_or_run", ctypes.c_bool),
        ("problems", ctypes.POINTER(HealthAndArmingCheckProblemCStruct)),
        ("problems_size", ctypes.c_size_t),
    ]


class HealthComponentReportCStruct(ctypes.Structure):
    """
    Internal C structure for HealthComponentReport.
    Used only for C library communication.
    """

    _fields_ = [
        ("name", ctypes.c_char_p),
        ("label", ctypes.c_char_p),
        ("is_present", ctypes.c_bool),
        ("has_error", ctypes.c_bool),
        ("has_warning", ctypes.c_bool),
    ]


class HealthAndArmingCheckReportCStruct(ctypes.Structure):
    """
    Internal C structure for HealthAndArmingCheckReport.
    Used only for C library communication.
    """

    _fields_ = [
        ("current_mode_intention", HealthAndArmingCheckModeCStruct),
        ("health_components", ctypes.POINTER(HealthComponentReportCStruct)),
        ("health_components_size", ctypes.c_size_t),
        ("all_problems", ctypes.POINTER(HealthAndArmingCheckProblemCStruct)),
        ("all_problems_size", ctypes.c_size_t),
    ]


# ===== Structures =====
class Event:
    """
    Event type
    """

    def __init__(
        self,
        compid=None,
        message=None,
        description=None,
        log_level=None,
        event_namespace=None,
        event_name=None,
    ):
        self.compid = compid
        self.message = message
        self.description = description
        self.log_level = log_level
        self.event_namespace = event_namespace
        self.event_name = event_name

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.compid = c_struct.compid
        instance.message = c_struct.message.decode("utf-8")
        instance.description = c_struct.description.decode("utf-8")
        instance.log_level = LogLevel(c_struct.log_level)
        instance.event_namespace = c_struct.event_namespace.decode("utf-8")
        instance.event_name = c_struct.event_name.decode("utf-8")
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = EventCStruct()
        c_struct.compid = self.compid
        c_struct.message = self.message.encode("utf-8")
        c_struct.description = self.description.encode("utf-8")
        c_struct.log_level = int(self.log_level)
        c_struct.event_namespace = self.event_namespace.encode("utf-8")
        c_struct.event_name = self.event_name.encode("utf-8")
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"compid={self.compid}")
        fields.append(f"message={self.message}")
        fields.append(f"description={self.description}")
        fields.append(f"log_level={self.log_level}")
        fields.append(f"event_namespace={self.event_namespace}")
        fields.append(f"event_name={self.event_name}")
        return f"Event({', '.join(fields)})"


class HealthAndArmingCheckProblem:
    """
    Health and arming check problem type
    """

    def __init__(
        self, message=None, description=None, log_level=None, health_component=None
    ):
        self.message = message
        self.description = description
        self.log_level = log_level
        self.health_component = health_component

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.message = c_struct.message.decode("utf-8")
        instance.description = c_struct.description.decode("utf-8")
        instance.log_level = LogLevel(c_struct.log_level)
        instance.health_component = c_struct.health_component.decode("utf-8")
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = HealthAndArmingCheckProblemCStruct()
        c_struct.message = self.message.encode("utf-8")
        c_struct.description = self.description.encode("utf-8")
        c_struct.log_level = int(self.log_level)
        c_struct.health_component = self.health_component.encode("utf-8")
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"message={self.message}")
        fields.append(f"description={self.description}")
        fields.append(f"log_level={self.log_level}")
        fields.append(f"health_component={self.health_component}")
        return f"HealthAndArmingCheckProblem({', '.join(fields)})"


class HealthAndArmingCheckMode:
    """
    Arming checks for a specific mode
    """

    def __init__(self, mode_name=None, can_arm_or_run=None, problems=None):
        self.mode_name = mode_name
        self.can_arm_or_run = can_arm_or_run
        self.problems = problems or []

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.mode_name = c_struct.mode_name.decode("utf-8")
        instance.can_arm_or_run = c_struct.can_arm_or_run
        if c_struct.problems_size > 0:
            instance.problems = [
                HealthAndArmingCheckProblem.from_c_struct(c_struct.problems[i])
                for i in range(c_struct.problems_size)
            ]
        else:
            instance.problems = []
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = HealthAndArmingCheckModeCStruct()
        c_struct.mode_name = self.mode_name.encode("utf-8")
        c_struct.can_arm_or_run = self.can_arm_or_run
        array_type = HealthAndArmingCheckProblemCStruct * len(self.problems)
        c_array = array_type()
        for i, item in enumerate(self.problems):
            c_array[i] = item.to_c_struct()
        c_struct.problems = ctypes.cast(
            c_array, ctypes.POINTER(HealthAndArmingCheckProblemCStruct)
        )
        c_struct.problems_size = len(self.problems)
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"mode_name={self.mode_name}")
        fields.append(f"can_arm_or_run={self.can_arm_or_run}")
        fields.append(f"problems={self.problems}")
        return f"HealthAndArmingCheckMode({', '.join(fields)})"


class HealthComponentReport:
    """
    Health component report type
    """

    def __init__(
        self, name=None, label=None, is_present=None, has_error=None, has_warning=None
    ):
        self.name = name
        self.label = label
        self.is_present = is_present
        self.has_error = has_error
        self.has_warning = has_warning

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.name = c_struct.name.decode("utf-8")
        instance.label = c_struct.label.decode("utf-8")
        instance.is_present = c_struct.is_present
        instance.has_error = c_struct.has_error
        instance.has_warning = c_struct.has_warning
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = HealthComponentReportCStruct()
        c_struct.name = self.name.encode("utf-8")
        c_struct.label = self.label.encode("utf-8")
        c_struct.is_present = self.is_present
        c_struct.has_error = self.has_error
        c_struct.has_warning = self.has_warning
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"name={self.name}")
        fields.append(f"label={self.label}")
        fields.append(f"is_present={self.is_present}")
        fields.append(f"has_error={self.has_error}")
        fields.append(f"has_warning={self.has_warning}")
        return f"HealthComponentReport({', '.join(fields)})"


class HealthAndArmingCheckReport:
    """
    Health and arming check report type
    """

    def __init__(
        self, current_mode_intention=None, health_components=None, all_problems=None
    ):
        self.current_mode_intention = current_mode_intention
        self.health_components = health_components or []
        self.all_problems = all_problems or []

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.current_mode_intention = HealthAndArmingCheckMode.from_c_struct(
            c_struct.current_mode_intention
        )
        if c_struct.health_components_size > 0:
            instance.health_components = [
                HealthComponentReport.from_c_struct(c_struct.health_components[i])
                for i in range(c_struct.health_components_size)
            ]
        else:
            instance.health_components = []
        if c_struct.all_problems_size > 0:
            instance.all_problems = [
                HealthAndArmingCheckProblem.from_c_struct(c_struct.all_problems[i])
                for i in range(c_struct.all_problems_size)
            ]
        else:
            instance.all_problems = []
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = HealthAndArmingCheckReportCStruct()
        c_struct.current_mode_intention = self.current_mode_intention.to_c_struct()
        array_type = HealthComponentReportCStruct * len(self.health_components)
        c_array = array_type()
        for i, item in enumerate(self.health_components):
            c_array[i] = item.to_c_struct()
        c_struct.health_components = ctypes.cast(
            c_array, ctypes.POINTER(HealthComponentReportCStruct)
        )
        c_struct.health_components_size = len(self.health_components)
        array_type = HealthAndArmingCheckProblemCStruct * len(self.all_problems)
        c_array = array_type()
        for i, item in enumerate(self.all_problems):
            c_array[i] = item.to_c_struct()
        c_struct.all_problems = ctypes.cast(
            c_array, ctypes.POINTER(HealthAndArmingCheckProblemCStruct)
        )
        c_struct.all_problems_size = len(self.all_problems)
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"current_mode_intention={self.current_mode_intention}")
        fields.append(f"health_components={self.health_components}")
        fields.append(f"all_problems={self.all_problems}")
        return f"HealthAndArmingCheckReport({', '.join(fields)})"


# ===== Plugin =====
class Events:
    """Get event notifications, such as takeoff, or arming checks"""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_events_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create Events plugin - C function returned null handle"
            )

    def subscribe_events(self, callback: Callable, user_data: Any = None):
        """Subscribe to event updates."""

        def c_callback(c_data, ud):
            try:
                py_data = Event.from_c_struct(c_data)

                self._lib.mavsdk_events_event_destroy(ctypes.byref(c_data))

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in events callback: {e}")

        cb = EventsCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_events_subscribe_events(self._handle, cb, None)

    def unsubscribe_events(self, handle: ctypes.c_void_p):
        """Unsubscribe from events"""
        self._lib.mavsdk_events_unsubscribe_events(self._handle, handle)

    def subscribe_health_and_arming_checks(
        self, callback: Callable, user_data: Any = None
    ):
        """Subscribe to arming check updates."""

        def c_callback(c_data, ud):
            try:
                py_data = HealthAndArmingCheckReport.from_c_struct(c_data)

                self._lib.mavsdk_events_health_and_arming_check_report_destroy(
                    ctypes.byref(c_data)
                )

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in health_and_arming_checks callback: {e}")

        cb = HealthAndArmingChecksCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_events_subscribe_health_and_arming_checks(
            self._handle, cb, None
        )

    def unsubscribe_health_and_arming_checks(self, handle: ctypes.c_void_p):
        """Unsubscribe from health_and_arming_checks"""
        self._lib.mavsdk_events_unsubscribe_health_and_arming_checks(
            self._handle, handle
        )

    def get_health_and_arming_checks_report(self):
        """Get get_health_and_arming_checks_report (blocking)"""

        result_out = HealthAndArmingCheckReportCStruct()

        result_code = self._lib.mavsdk_events_get_health_and_arming_checks_report(
            self._handle, ctypes.byref(result_out)
        )
        result = EventsResult(result_code)
        if result != EventsResult.SUCCESS:
            raise Exception(f"get_health_and_arming_checks_report failed: {result}")

        py_result = HealthAndArmingCheckReport.from_c_struct(result_out)
        self._lib.mavsdk_events_health_and_arming_check_report_destroy(
            ctypes.byref(result_out)
        )
        return py_result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_events_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
EventsCallback = ctypes.CFUNCTYPE(None, EventCStruct, ctypes.c_void_p)
HealthAndArmingChecksCallback = ctypes.CFUNCTYPE(
    None, HealthAndArmingCheckReportCStruct, ctypes.c_void_p
)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_events_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_events_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_events_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_events_destroy.restype = None

_cmavsdk_lib.mavsdk_events_event_destroy.argtypes = [ctypes.POINTER(EventCStruct)]
_cmavsdk_lib.mavsdk_events_event_destroy.restype = None

_cmavsdk_lib.mavsdk_events_health_and_arming_check_problem_destroy.argtypes = [
    ctypes.POINTER(HealthAndArmingCheckProblemCStruct)
]
_cmavsdk_lib.mavsdk_events_health_and_arming_check_problem_destroy.restype = None

_cmavsdk_lib.mavsdk_events_health_and_arming_check_mode_destroy.argtypes = [
    ctypes.POINTER(HealthAndArmingCheckModeCStruct)
]
_cmavsdk_lib.mavsdk_events_health_and_arming_check_mode_destroy.restype = None

_cmavsdk_lib.mavsdk_events_health_component_report_destroy.argtypes = [
    ctypes.POINTER(HealthComponentReportCStruct)
]
_cmavsdk_lib.mavsdk_events_health_component_report_destroy.restype = None

_cmavsdk_lib.mavsdk_events_health_and_arming_check_report_destroy.argtypes = [
    ctypes.POINTER(HealthAndArmingCheckReportCStruct)
]
_cmavsdk_lib.mavsdk_events_health_and_arming_check_report_destroy.restype = None


_cmavsdk_lib.mavsdk_events_subscribe_events.argtypes = [
    ctypes.c_void_p,
    EventsCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_events_subscribe_events.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_events_unsubscribe_events.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_events_unsubscribe_events.restype = None

_cmavsdk_lib.mavsdk_events_subscribe_health_and_arming_checks.argtypes = [
    ctypes.c_void_p,
    HealthAndArmingChecksCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_events_subscribe_health_and_arming_checks.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_events_unsubscribe_health_and_arming_checks.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_events_unsubscribe_health_and_arming_checks.restype = None


_cmavsdk_lib.mavsdk_events_get_health_and_arming_checks_report.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(HealthAndArmingCheckReportCStruct),
]

_cmavsdk_lib.mavsdk_events_get_health_and_arming_checks_report.restype = ctypes.c_int
