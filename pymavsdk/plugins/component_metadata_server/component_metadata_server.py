# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/component_metadata_server/component_metadata_server.proto)

"""
Provide component metadata json definitions, such as parameters.
"""

import ctypes
from typing import Optional, List, Callable, Any
from enum import IntEnum


# ===== Enums =====
class MetadataType(IntEnum):
    """The metadata type"""
    PARAMETER = 0
    EVENTS = 1
    ACTUATORS = 2


# ===== Result Enums =====

# ===== Internal C Structures =====
class MetadataCStruct(ctypes.Structure):
    """
    Internal C structure for Metadata.
    Used only for C library communication.
    """
    _fields_ = [
        ("type", ctypes.c_int),
        ("json_metadata", ctypes.c_char_p),
    ]


# ===== Structures =====
class Metadata:
    """
    The metadata type and content
    """

    def __init__(self, type=None, json_metadata=None):
        self.type = type
        self.json_metadata = json_metadata

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        # Convert C enum to Python enum
        instance.type = MetadataType(c_struct.type)
        # Convert C string to Python string
        instance.json_metadata = c_struct.json_metadata.decode('utf-8')
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = MetadataCStruct()
        # Check for None values in enum types
        if self.type is None:
            raise ValueError(f"Field 'type' must be set before converting to C struct")
        c_struct.type = int(self.type)
        # Convert Python string to C string (bytes)
        c_struct.json_metadata = self.json_metadata.encode('utf-8')
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"type={self.type}")
        fields.append(f"json_metadata={self.json_metadata}")
        return f"Metadata({', '.join(fields)})"


# ===== Callback Types =====


class ComponentMetadataServer:
    """Provide component metadata json definitions, such as parameters."""

    def __init__(self, lib: ctypes.CDLL, server_component):
        self._lib = lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        self._setup_functions()

        # Validate input parameter
        if server_component is None:
            raise ValueError("server_component cannot be None")

        # Extract handle with validation
        if hasattr(server_component, '_handle'):
            component_handle = server_component._handle
        elif isinstance(server_component, ctypes.c_void_p):
            component_handle = server_component
        else:
            raise ValueError(f"Invalid server_component type: {type(server_component)}. Expected ServerComponent or c_void_p")

        # Validate handle is not null
        if not component_handle or (isinstance(component_handle, int) and component_handle == 0):
            raise ValueError("server_component handle is null")

        self._handle = self._lib.mavsdk_component_metadata_server_create(component_handle)

        # Validate plugin creation succeeded
        if not self._handle:
            raise RuntimeError("Failed to create ComponentMetadataServer plugin - C function returned null handle")

    def _setup_functions(self):
        """Setup C function signatures"""

        # Create/Destroy
        self._lib.mavsdk_component_metadata_server_create.argtypes = [ctypes.c_void_p]
        self._lib.mavsdk_component_metadata_server_create.restype = ctypes.c_void_p

        self._lib.mavsdk_component_metadata_server_destroy.argtypes = [ctypes.c_void_p]
        self._lib.mavsdk_component_metadata_server_destroy.restype = None

        self._lib.mavsdk_component_metadata_server_metadata_destroy.argtypes = [
            ctypes.POINTER(MetadataCStruct)
        ]
        self._lib.mavsdk_component_metadata_server_metadata_destroy.restype = None



        self._lib.mavsdk_component_metadata_server_set_metadata.argtypes = [
            ctypes.c_void_p,
            ctypes.POINTER(MetadataCStruct),
            ctypes.c_size_t,
        ]

        self._lib.mavsdk_component_metadata_server_set_metadata.restype = None



    def set_metadata(self, metadata):
        """Get set_metadata (blocking)"""
        self._lib.mavsdk_component_metadata_server_set_metadata(
            self._handle,
            metadata.to_c_struct()        )


    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_component_metadata_server_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()