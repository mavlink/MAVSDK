# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/follow_me/follow_me.proto)

"""
Allow users to command the vehicle to follow a specific target.
 The target is provided as a GPS coordinate and altitude.
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====


# ===== Result Enums =====
class FollowMeResult(IntEnum):
    """Possible results returned for followme operations"""

    UNKNOWN = 0
    SUCCESS = 1
    NO_SYSTEM = 2
    CONNECTION_ERROR = 3
    BUSY = 4
    COMMAND_DENIED = 5
    TIMEOUT = 6
    NOT_ACTIVE = 7
    SET_CONFIG_FAILED = 8


# ===== Internal C Structures =====
class ConfigCStruct(ctypes.Structure):
    """
    Internal C structure for Config.
    Used only for C library communication.
    """

    _fields_ = [
        ("follow_height_m", ctypes.c_float),
        ("follow_distance_m", ctypes.c_float),
        ("responsiveness", ctypes.c_float),
        ("altitude_mode", ctypes.c_int),
        ("max_tangential_vel_m_s", ctypes.c_float),
        ("follow_angle_deg", ctypes.c_float),
    ]


class TargetLocationCStruct(ctypes.Structure):
    """
    Internal C structure for TargetLocation.
    Used only for C library communication.
    """

    _fields_ = [
        ("latitude_deg", ctypes.c_double),
        ("longitude_deg", ctypes.c_double),
        ("absolute_altitude_m", ctypes.c_float),
        ("velocity_x_m_s", ctypes.c_float),
        ("velocity_y_m_s", ctypes.c_float),
        ("velocity_z_m_s", ctypes.c_float),
    ]


# ===== Structures =====
class Config:
    """
    Configuration type.
    """

    class FollowAltitudeMode(IntEnum):
        """Altitude mode to configure which altitude the follow me will assume the target to be at."""

        CONSTANT = 0
        TERRAIN = 1
        TARGET_GPS = 2

    def __init__(
        self,
        follow_height_m=None,
        follow_distance_m=None,
        responsiveness=None,
        altitude_mode=None,
        max_tangential_vel_m_s=None,
        follow_angle_deg=None,
    ):
        self.follow_height_m = follow_height_m
        self.follow_distance_m = follow_distance_m
        self.responsiveness = responsiveness
        self.altitude_mode = altitude_mode
        self.max_tangential_vel_m_s = max_tangential_vel_m_s
        self.follow_angle_deg = follow_angle_deg

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.follow_height_m = c_struct.follow_height_m
        instance.follow_distance_m = c_struct.follow_distance_m
        instance.responsiveness = c_struct.responsiveness
        instance.altitude_mode = Config.FollowAltitudeMode(c_struct.altitude_mode)
        instance.max_tangential_vel_m_s = c_struct.max_tangential_vel_m_s
        instance.follow_angle_deg = c_struct.follow_angle_deg
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = ConfigCStruct()
        c_struct.follow_height_m = self.follow_height_m
        c_struct.follow_distance_m = self.follow_distance_m
        c_struct.responsiveness = self.responsiveness
        c_struct.altitude_mode = int(self.altitude_mode)
        c_struct.max_tangential_vel_m_s = self.max_tangential_vel_m_s
        c_struct.follow_angle_deg = self.follow_angle_deg
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"follow_height_m={self.follow_height_m}")
        fields.append(f"follow_distance_m={self.follow_distance_m}")
        fields.append(f"responsiveness={self.responsiveness}")
        fields.append(f"altitude_mode={self.altitude_mode}")
        fields.append(f"max_tangential_vel_m_s={self.max_tangential_vel_m_s}")
        fields.append(f"follow_angle_deg={self.follow_angle_deg}")
        return f"Config({', '.join(fields)})"


class TargetLocation:
    """
    Target location for the vehicle to follow
    """

    def __init__(
        self,
        latitude_deg=None,
        longitude_deg=None,
        absolute_altitude_m=None,
        velocity_x_m_s=None,
        velocity_y_m_s=None,
        velocity_z_m_s=None,
    ):
        self.latitude_deg = latitude_deg
        self.longitude_deg = longitude_deg
        self.absolute_altitude_m = absolute_altitude_m
        self.velocity_x_m_s = velocity_x_m_s
        self.velocity_y_m_s = velocity_y_m_s
        self.velocity_z_m_s = velocity_z_m_s

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.latitude_deg = c_struct.latitude_deg
        instance.longitude_deg = c_struct.longitude_deg
        instance.absolute_altitude_m = c_struct.absolute_altitude_m
        instance.velocity_x_m_s = c_struct.velocity_x_m_s
        instance.velocity_y_m_s = c_struct.velocity_y_m_s
        instance.velocity_z_m_s = c_struct.velocity_z_m_s
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = TargetLocationCStruct()
        c_struct.latitude_deg = self.latitude_deg
        c_struct.longitude_deg = self.longitude_deg
        c_struct.absolute_altitude_m = self.absolute_altitude_m
        c_struct.velocity_x_m_s = self.velocity_x_m_s
        c_struct.velocity_y_m_s = self.velocity_y_m_s
        c_struct.velocity_z_m_s = self.velocity_z_m_s
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"latitude_deg={self.latitude_deg}")
        fields.append(f"longitude_deg={self.longitude_deg}")
        fields.append(f"absolute_altitude_m={self.absolute_altitude_m}")
        fields.append(f"velocity_x_m_s={self.velocity_x_m_s}")
        fields.append(f"velocity_y_m_s={self.velocity_y_m_s}")
        fields.append(f"velocity_z_m_s={self.velocity_z_m_s}")
        return f"TargetLocation({', '.join(fields)})"


# ===== Plugin =====
class FollowMe:
    """Allow users to command the vehicle to follow a specific target.
    The target is provided as a GPS coordinate and altitude."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_follow_me_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create FollowMe plugin - C function returned null handle"
            )

    def get_config(self):
        """Get get_config (blocking)"""

        result_out = ConfigCStruct()

        self._lib.mavsdk_follow_me_get_config(self._handle, ctypes.byref(result_out))

        py_result = Config.from_c_struct(result_out)
        self._lib.mavsdk_follow_me_config_destroy(ctypes.byref(result_out))
        return py_result

    def set_config(self, config):
        """Get set_config (blocking)"""

        result_code = self._lib.mavsdk_follow_me_set_config(
            self._handle,
            config.to_c_struct(),
        )
        result = FollowMeResult(result_code)
        if result != FollowMeResult.SUCCESS:
            raise Exception(f"set_config failed: {result}")

        return result

    def is_active(self):
        """Get is_active (blocking)"""

        result_out = ctypes.c_bool()

        self._lib.mavsdk_follow_me_is_active(self._handle, ctypes.byref(result_out))

        return result_out.value

    def set_target_location(self, location):
        """Get set_target_location (blocking)"""

        result_code = self._lib.mavsdk_follow_me_set_target_location(
            self._handle,
            location.to_c_struct(),
        )
        result = FollowMeResult(result_code)
        if result != FollowMeResult.SUCCESS:
            raise Exception(f"set_target_location failed: {result}")

        return result

    def get_last_location(self):
        """Get get_last_location (blocking)"""

        result_out = TargetLocationCStruct()

        self._lib.mavsdk_follow_me_get_last_location(
            self._handle, ctypes.byref(result_out)
        )

        py_result = TargetLocation.from_c_struct(result_out)
        self._lib.mavsdk_follow_me_target_location_destroy(ctypes.byref(result_out))
        return py_result

    def start(self):
        """Get start (blocking)"""

        result_code = self._lib.mavsdk_follow_me_start(
            self._handle,
        )
        result = FollowMeResult(result_code)
        if result != FollowMeResult.SUCCESS:
            raise Exception(f"start failed: {result}")

        return result

    def stop(self):
        """Get stop (blocking)"""

        result_code = self._lib.mavsdk_follow_me_stop(
            self._handle,
        )
        result = FollowMeResult(result_code)
        if result != FollowMeResult.SUCCESS:
            raise Exception(f"stop failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_follow_me_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_follow_me_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_follow_me_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_follow_me_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_follow_me_destroy.restype = None

_cmavsdk_lib.mavsdk_follow_me_config_destroy.argtypes = [ctypes.POINTER(ConfigCStruct)]
_cmavsdk_lib.mavsdk_follow_me_config_destroy.restype = None

_cmavsdk_lib.mavsdk_follow_me_target_location_destroy.argtypes = [
    ctypes.POINTER(TargetLocationCStruct)
]
_cmavsdk_lib.mavsdk_follow_me_target_location_destroy.restype = None


_cmavsdk_lib.mavsdk_follow_me_get_config.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(ConfigCStruct),
]

_cmavsdk_lib.mavsdk_follow_me_get_config.restype = None

_cmavsdk_lib.mavsdk_follow_me_set_config.argtypes = [
    ctypes.c_void_p,
    ConfigCStruct,
]

_cmavsdk_lib.mavsdk_follow_me_set_config.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_follow_me_is_active.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(ctypes.c_bool),
]

_cmavsdk_lib.mavsdk_follow_me_is_active.restype = None

_cmavsdk_lib.mavsdk_follow_me_set_target_location.argtypes = [
    ctypes.c_void_p,
    TargetLocationCStruct,
]

_cmavsdk_lib.mavsdk_follow_me_set_target_location.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_follow_me_get_last_location.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(TargetLocationCStruct),
]

_cmavsdk_lib.mavsdk_follow_me_get_last_location.restype = None

_cmavsdk_lib.mavsdk_follow_me_start.argtypes = [
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_follow_me_start.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_follow_me_stop.argtypes = [
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_follow_me_stop.restype = ctypes.c_int
