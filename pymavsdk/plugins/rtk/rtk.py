# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/rtk/rtk.proto)

"""
Service to send RTK corrections to the vehicle.
"""

import ctypes

from typing import Optional, List, Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====

# ===== Result Enums =====
class RtkResult(IntEnum):
    """Possible results returned for rtk requests."""
    UNKNOWN = 0
    SUCCESS = 1
    TOO_LONG = 2
    NO_SYSTEM = 3
    CONNECTION_ERROR = 4


# ===== Internal C Structures =====
class RtcmDataCStruct(ctypes.Structure):
    """
    Internal C structure for RtcmData.
    Used only for C library communication.
    """
    _fields_ = [
        ("data_base64", ctypes.c_char_p),
    ]


# ===== Structures =====
class RtcmData:
    """
    RTCM data type
    """

    def __init__(self, data_base64=None):
        self.data_base64 = data_base64

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        # Convert C string to Python string
        instance.data_base64 = c_struct.data_base64.decode('utf-8')
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = RtcmDataCStruct()
        # Convert Python string to C string (bytes)
        c_struct.data_base64 = self.data_base64.encode('utf-8')
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"data_base64={self.data_base64}")
        return f"RtcmData({', '.join(fields)})"


# ===== Callback Types =====


class Rtk:
    """Service to send RTK corrections to the vehicle."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        self._setup_functions()

        # Validate input parameter
        if system is None:
            raise ValueError("system cannot be None")

        # Extract handle with validation
        if hasattr(system, '_handle'):
            system_handle = system._handle
        elif isinstance(system, ctypes.c_void_p):
            system_handle = system
        else:
            raise ValueError(f"Invalid system type: {type(system)}. Expected MavsdkSystem or c_void_p")

        # Validate handle is not null
        if not system_handle or (isinstance(system_handle, int) and system_handle == 0):
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_rtk_create(system_handle)

        # Validate plugin creation succeeded
        if not self._handle:
            raise RuntimeError("Failed to create Rtk plugin - C function returned null handle")

    def _setup_functions(self):
        """Setup C function signatures"""

        # Create/Destroy
        self._lib.mavsdk_rtk_create.argtypes = [ctypes.c_void_p]
        self._lib.mavsdk_rtk_create.restype = ctypes.c_void_p

        self._lib.mavsdk_rtk_destroy.argtypes = [ctypes.c_void_p]
        self._lib.mavsdk_rtk_destroy.restype = None

        self._lib.mavsdk_rtk_rtcm_data_destroy.argtypes = [
            ctypes.POINTER(RtcmDataCStruct)
        ]
        self._lib.mavsdk_rtk_rtcm_data_destroy.restype = None



        self._lib.mavsdk_rtk_send_rtcm_data.argtypes = [
            ctypes.c_void_p,
            RtcmDataCStruct,
        ]

        self._lib.mavsdk_rtk_send_rtcm_data.restype = ctypes.c_int



    def send_rtcm_data(self, rtcm_data):
        """Get send_rtcm_data (blocking)"""
        result_code = self._lib.mavsdk_rtk_send_rtcm_data(
            self._handle,
            rtcm_data.to_c_struct()        )
        result = RtkResult(result_code)
        if result != RtkResult.SUCCESS:
            raise Exception(f"send_rtcm_data failed: {result}")
        return result


    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_rtk_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()