# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/{{ plugin_name.lower_snake_case }}/{{ plugin_name.lower_snake_case }}.proto)

"""
{{ class_description }}
"""

import ctypes
from typing import Optional, List, Callable, Any
from enum import IntEnum


# ===== Enums =====
{% for enum in enums %}
class {{ enum.name.upper_camel_case }}(IntEnum):
    """{{ enum.enum_description }}"""
    {% for value in enum.values %}
    {{ value.name.uppercase }} = {{ loop.index0 }}
    {% endfor %}

{% endfor %}

# ===== Result Enums =====
{% for struct in structs %}
{% if struct.name.upper_camel_case.endswith('Result') %}
{% for nested_enum_name, nested_enum in struct.nested_enums.items() %}
{% if nested_enum_name == 'Result' %}
class {{ plugin_name.upper_camel_case }}Result(IntEnum):
    """{{ nested_enum.enum_description }}"""
    {% for value in nested_enum.values %}
    {{ value.name.uppercase }} = {{ loop.index0 }}
    {% endfor %}

{% endif %}
{% endfor %}
{% endif %}
{% endfor %}

# ===== Nested Enums =====
{% for struct in structs %}
{% if not struct.name.upper_camel_case.endswith('Result') %}
{% for nested_enum_name, nested_enum in struct.nested_enums.items() %}
class {{ struct.name.upper_camel_case }}{{ nested_enum.name.upper_camel_case }}(IntEnum):
    """{{ nested_enum.enum_description }}"""
    {% for value in nested_enum.values %}
    {{ value.name.uppercase }} = {{ loop.index0 }}
    {% endfor %}

{% endfor %}
{% endif %}
{% endfor %}

# ===== Structures =====
{% for struct in structs %}
{% if not struct.name.upper_camel_case.endswith('Result') %}
class {{ struct.name.upper_camel_case }}(ctypes.Structure):
    """
    {{ struct.struct_description }}
    
    Note: This struct may contain dynamically allocated memory.
    Always call destroy() when done to avoid memory leaks.
    """
    _fields_ = [
        {% for field in struct.fields %}
        {% if field.type_info.is_primitive %}
        {% if field.type_info.is_repeated %}
        ("{{ field.name.lower_snake_case }}", ctypes.POINTER(ctypes.{{ field.type_info.name }})),
        ("{{ field.name.lower_snake_case }}_size", ctypes.c_size_t),
        {% else %}
        ("{{ field.name.lower_snake_case }}", ctypes.{{ field.type_info.name }}),
        {% endif %}
        {% else %}
        {% if field.type_info.is_repeated %}
        ("{{ field.name.lower_snake_case }}", ctypes.POINTER({{ field.type_info.inner_name.upper_camel_case }})),
        ("{{ field.name.lower_snake_case }}_size", ctypes.c_size_t),
        {% elif field.type_info.parent_type %}
        ("{{ field.name.lower_snake_case }}", ctypes.c_int),
        {% else %}
        ("{{ field.name.lower_snake_case }}", {{ field.type_info.name.upper_camel_case }}),
        {% endif %}
        {% endif %}
        {% endfor %}
    ]

{% endif %}
{% endfor %}

# ===== Callback Types =====
{% for method in methods %}
{% if method.is_async %}
{{ method.name.upper_camel_case }}Callback = ctypes.CFUNCTYPE(
    None,
    {% if method.has_result %}ctypes.c_int,{% endif %}
    {% if method.return_type %}
    {% if method.return_type.is_primitive %}
    ctypes.{{ method.return_type.name }},
    {% else %}
    {% if method.return_type.is_repeated %}
    ctypes.POINTER({{ method.return_type.inner_name.upper_camel_case }}),
    ctypes.c_size_t,
    {% else %}
    {{ method.return_type.inner_name.upper_camel_case }},
    {% endif %}
    {% endif %}
    {% endif %}
    ctypes.c_void_p
)
{% endif %}
{% endfor %}


class {{ plugin_name.upper_camel_case }}:
    """{{ class_description }}"""
    
    def __init__(self, lib: ctypes.CDLL, {% if is_server %}server_component{% else %}system{% endif %}):
        self._lib = lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC
        
        self._setup_functions()
        {% if is_server %}
        self._handle = self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_create(server_component._handle if hasattr(server_component, '_handle') else server_component)
        {% else %}
        self._handle = self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_create(system._handle if hasattr(system, '_handle') else system)
        {% endif %}
    
    def _setup_functions(self):
        """Setup C function signatures"""
        
        # Create/Destroy
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_create.argtypes = [ctypes.c_void_p]
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_create.restype = ctypes.c_void_p
        
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_destroy.argtypes = [ctypes.c_void_p]
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_destroy.restype = None
        
        {% for struct in structs %}
        {% if not struct.name.upper_camel_case.endswith('Result') %}
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_destroy.argtypes = [
            ctypes.POINTER({{ struct.name.upper_camel_case }})
        ]
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_destroy.restype = None
        
        {% endif %}
        {% endfor %}
        
        {% for method in methods %}
        {% if method.is_async %}
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}{% if method.is_stream and not method.is_finite %}_subscribe{% endif %}_{{ method.name.lower_snake_case }}{% if not method.is_stream or method.is_finite %}_async{% endif %}.argtypes = [
            ctypes.c_void_p,
            {% for param in method.params %}
            {% if param.type_info.is_repeated %}
            {% if param.type_info.is_primitive %}
            ctypes.POINTER(ctypes.{{ param.type_info.inner_name }}),
            {% else %}
            ctypes.POINTER({{ param.type_info.inner_name.upper_camel_case }}),
            {% endif %}
            ctypes.c_size_t,
            {% elif param.type_info.is_primitive %}
            ctypes.{{ param.type_info.name }},
            {% elif param.type_info.is_enum %}
            ctypes.c_int,
            {% elif param.type_info.parent_type %}
            ctypes.c_int,
            {% else %}
            {{ param.type_info.name.upper_camel_case }},
            {% endif %}
            {% endfor %}
            {{ method.name.upper_camel_case }}Callback,
            ctypes.c_void_p
        ]

        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}{% if method.is_stream and not method.is_finite %}_subscribe{% endif %}_{{ method.name.lower_snake_case }}{% if not method.is_stream or method.is_finite %}_async{% endif %}.restype = {% if method.is_stream and not method.is_finite %}ctypes.c_void_p{% else %}None{% endif %}
        
        {% if method.is_stream and not method.is_finite %}
        # Unsubscribe
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_unsubscribe_{{ method.name.lower_snake_case }}.argtypes = [
            ctypes.c_void_p,
            ctypes.c_void_p
        ]

        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_unsubscribe_{{ method.name.lower_snake_case }}.restype = None
        {% endif %}
        {% endif %}
        
        {% if method.is_sync %}
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}.argtypes = [
            ctypes.c_void_p,
            {% for param in method.params %}
            {% if param.type_info.is_repeated %}
            {% if param.type_info.is_primitive %}
            ctypes.POINTER(ctypes.{{ param.type_info.inner_name }}),
            {% else %}
            ctypes.POINTER({{ param.type_info.inner_name.upper_camel_case }}),
            {% endif %}
            ctypes.c_size_t,
            {% elif param.type_info.is_primitive %}
            ctypes.{{ param.type_info.name }},
            {% elif param.type_info.is_enum %}
            ctypes.c_int,
            {% elif param.type_info.parent_type %}
            ctypes.c_int,
            {% else %}
            {{ param.type_info.name.upper_camel_case }},
            {% endif %}
            {% endfor %}
            {% if method.return_name %}
            {% if method.return_type.is_repeated %}
            ctypes.POINTER(ctypes.POINTER({{ method.return_type.inner_name.upper_camel_case }})),
            ctypes.POINTER(ctypes.c_size_t)
            {% elif method.return_type.is_primitive %}
            ctypes.POINTER(ctypes.{{ method.return_type.name }})
            {% else %}
            ctypes.POINTER({{ method.return_type.inner_name.upper_camel_case }})
            {% endif %}
            {% endif %}
        ]

        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}.restype = {% if method.has_result %}ctypes.c_int{% else %}None{% endif %}

        {% endif %}
        {% endfor %}
    
    {% for method in methods %}
    {% if method.is_async %}
    def {{ method.name.lower_snake_case }}_async(self, {% for param in method.params %}{{ param.name.lower_snake_case }}, {% endfor %}callback: Callable, user_data: Any = None):
        """{{ method.method_description }}"""
        
        def c_callback({% if method.has_result %}result, {% endif %}{% if method.return_type %}{{ method.return_name.lower_snake_case }}{% if method.return_type.is_repeated %}, size{% endif %}, {% endif %}ud):
            try:
                callback({% if method.has_result %}{{ plugin_name.upper_camel_case }}Result(result), {% endif %}{% if method.return_type %}{{ method.return_name.lower_snake_case }}{% if method.return_type.is_repeated %}, size{% endif %}, {% endif %}user_data)
            except Exception as e:
                print(f"Error in {{ method.name.lower_snake_case }} callback: {e}")
        
        cb = {{ method.name.upper_camel_case }}Callback(c_callback)
        self._callbacks.append(cb)
        
        {% if method.is_stream and not method.is_finite %}
        return self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_subscribe_{{ method.name.lower_snake_case }}(
        {% else %}
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}_async(
        {% endif %}
            self._handle,
            {% for param in method.params %}
            {{ param.name.lower_snake_case }},
            {% endfor %}
            cb,
            None
        )
    
    {% if method.is_stream and not method.is_finite %}
    def unsubscribe_{{ method.name.lower_snake_case }}(self, handle: ctypes.c_void_p):
        """Unsubscribe from {{ method.name.lower_snake_case }}"""
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_unsubscribe_{{ method.name.lower_snake_case }}(
            self._handle, handle
        )
    {% endif %}
    {% endif %}
    
    {% if method.is_sync %}
    def {{ method.name.lower_snake_case }}(self{% for param in method.params %}, {{ param.name.lower_snake_case }}{% endfor %}):
        """Get {{ method.name.lower_snake_case }} (blocking)"""
        {% if method.return_name %}
        {% if method.return_type.is_repeated %}
        result_ptr = ctypes.POINTER({{ method.return_type.inner_name.upper_camel_case }})()
        size = ctypes.c_size_t()
        {% if method.has_result %}
        result = self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}(
            self._handle,
            {% for param in method.params %}{{ param.name.lower_snake_case }}, {% endfor %}
            ctypes.byref(result_ptr),
            ctypes.byref(size)
        )
        if result != 0:
            raise Exception(f"{{ method.name.lower_snake_case }} failed: {result}")
        {% else %}
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}(
            self._handle,
            {% for param in method.params %}{{ param.name.lower_snake_case }}, {% endfor %}
            ctypes.byref(result_ptr),
            ctypes.byref(size)
        )
        {% endif %}
        return [result_ptr[i] for i in range(size.value)]
        {% else %}
        result_out = {{ method.return_type.inner_name.upper_camel_case }}()
        {% if method.has_result %}
        result = self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}(
            self._handle,
            {% for param in method.params %}{{ param.name.lower_snake_case }}, {% endfor %}
            ctypes.byref(result_out)
        )
        if result != 0:
            raise Exception(f"{{ method.name.lower_snake_case }} failed: {result}")
        {% else %}
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}(
            self._handle,
            {% for param in method.params %}{{ param.name.lower_snake_case }}, {% endfor %}
            ctypes.byref(result_out)
        )
        {% endif %}
        return result_out
        {% endif %}
        {% else %}
        {% if method.has_result %}
        result = self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}(
            self._handle,
            {% for param in method.params %}{{ param.name.lower_snake_case }}{% if not loop.last %}, {% endif %}{% endfor %}
        )
        if result != 0:
            raise Exception(f"{{ method.name.lower_snake_case }} failed: {result}")
        {% else %}
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}(
            self._handle,
            {% for param in method.params %}{{ param.name.lower_snake_case }}{% if not loop.last %}, {% endif %}{% endfor %}
        )
        {% endif %}
        {% endif %}
    {% endif %}
    
    {% endfor %}
    
    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_destroy(self._handle)
            self._handle = None
    
    def __del__(self):
        self.destroy()
