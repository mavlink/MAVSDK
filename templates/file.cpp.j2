// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/{{ plugin_name.lower_snake_case }}/{{ plugin_name.lower_snake_case }}.proto)

#include "{{ plugin_name.lower_snake_case }}.h"

#include <mavsdk/plugins/{{ plugin_name.lower_snake_case }}/{{ plugin_name.lower_snake_case }}.h>
#include <cstring>
#include <vector>

// ===== C++ to C Type Conversions =====

{% for struct in structs %}
{% if struct.name.upper_camel_case.endswith('Result') %}
static mavsdk_{{ plugin_name.lower_snake_case }}_result_t
translate_result(mavsdk::{{ plugin_name.upper_camel_case }}::Result cpp_result) {
    switch(cpp_result) {
        {% for struct in structs %}
        {% if struct.name.upper_camel_case.endswith('Result') %}
        {% for nested_enum_name, nested_enum in struct.nested_enums.items() %}
        {% if nested_enum_name == 'Result' %}
        {% for value in nested_enum.values %}
        case mavsdk::{{ plugin_name.upper_camel_case }}::Result::{{ value.name.upper_camel_case }}:
            return MAVSDK_{{ plugin_name.uppercase }}_RESULT_{{ value.name.uppercase }};
        {% endfor %}
        {% endif %}
        {% endfor %}
        {% endif %}
        {% endfor %}
    }
}
{% endif %}
{% endfor %}

{% for enum in enums %}
static mavsdk::{{ plugin_name.upper_camel_case }}::{{ enum.name.upper_camel_case }}
translate_{{ enum.name.lower_snake_case }}_from_c(mavsdk_{{ plugin_name.lower_snake_case }}_{{ enum.name.lower_snake_case }}_t c_enum) {
    switch(c_enum) {
        {% for value in enum.values %}
        case MAVSDK_{{ plugin_name.uppercase }}_{{ enum.name.uppercase }}_{{ value.name.uppercase }}:
            return mavsdk::{{ plugin_name.upper_camel_case }}::{{ enum.name.upper_camel_case }}::{{ value.name.upper_camel_case }};
        {% endfor %}
    }
    return mavsdk::{{ plugin_name.upper_camel_case }}::{{ enum.name.upper_camel_case }}::{{ enum.values[0].name.upper_camel_case }};
}

static mavsdk_{{ plugin_name.lower_snake_case }}_{{ enum.name.lower_snake_case }}_t
translate_{{ enum.name.lower_snake_case }}_to_c(mavsdk::{{ plugin_name.upper_camel_case }}::{{ enum.name.upper_camel_case }} cpp_enum) {
    switch(cpp_enum) {
        {% for value in enum.values %}
        case mavsdk::{{ plugin_name.upper_camel_case }}::{{ enum.name.upper_camel_case }}::{{ value.name.upper_camel_case }}:
            return MAVSDK_{{ plugin_name.uppercase }}_{{ enum.name.uppercase }}_{{ value.name.uppercase }};
        {% endfor %}
    }
    return MAVSDK_{{ plugin_name.uppercase }}_{{ enum.name.uppercase }}_{{ enum.values[0].name.uppercase }};
}

{% endfor %}

{% for struct in structs %}
{% if not struct.name.upper_camel_case.endswith('Result') %}
{% for nested_enum_name, nested_enum in struct.nested_enums.items() %}

static mavsdk::{{ plugin_name.upper_camel_case }}::{{ struct.name.upper_camel_case }}::{{ nested_enum.name.upper_camel_case }}
translate_{{ struct.name.lower_snake_case }}_{{ nested_enum.name.lower_snake_case }}_from_c(mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_{{ nested_enum.name.lower_snake_case }}_t c_enum) {
    switch(c_enum) {
        {% for value in nested_enum.values %}
        case MAVSDK_{{ plugin_name.uppercase }}_{{ struct.name.uppercase }}_{{ nested_enum.name.uppercase }}_{{ value.name.uppercase }}:
            return mavsdk::{{ plugin_name.upper_camel_case }}::{{ struct.name.upper_camel_case }}::{{ nested_enum.name.upper_camel_case }}::{{ value.name.upper_camel_case }};
        {% endfor %}
    }
    return mavsdk::{{ plugin_name.upper_camel_case }}::{{ struct.name.upper_camel_case }}::{{ nested_enum.name.upper_camel_case }}::{{ nested_enum.values[0].name.upper_camel_case }};
}

{% endfor %}

static mavsdk::{{ plugin_name.upper_camel_case }}::{{ struct.name.upper_camel_case }}
translate_{{ struct.name.lower_snake_case }}_from_c(const mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_t& c_struct) {
    mavsdk::{{ plugin_name.upper_camel_case }}::{{ struct.name.upper_camel_case }} cpp_struct{};
    {% for field in struct.fields %}
    {% if field.type_info.is_repeated %}
    {% if field.type_info.is_string %}
    cpp_struct.{{ field.name.lower_snake_case }}.reserve(c_struct.{{ field.name.lower_snake_case }}_size);
    for (size_t i = 0; i < c_struct.{{ field.name.lower_snake_case }}_size; i++) {
        if (c_struct.{{ field.name.lower_snake_case }}[i]) {
            cpp_struct.{{ field.name.lower_snake_case }}.push_back(c_struct.{{ field.name.lower_snake_case }}[i]);
        }
    }
    {% elif field.type_info.is_primitive %}
    cpp_struct.{{ field.name.lower_snake_case }}.assign(
        c_struct.{{ field.name.lower_snake_case }},
        c_struct.{{ field.name.lower_snake_case }} + c_struct.{{ field.name.lower_snake_case }}_size);
    {% else %}
    cpp_struct.{{ field.name.lower_snake_case }}.reserve(c_struct.{{ field.name.lower_snake_case }}_size);
    for (size_t i = 0; i < c_struct.{{ field.name.lower_snake_case }}_size; i++) {
        cpp_struct.{{ field.name.lower_snake_case }}.push_back(
            translate_{{ field.type_info.inner_name }}_from_c(c_struct.{{ field.name.lower_snake_case }}[i]));
    }
    {% endif %}
    {% elif field.type_info.is_string %}
    if (c_struct.{{ field.name.lower_snake_case }}) {
        cpp_struct.{{ field.name.lower_snake_case }} = c_struct.{{ field.name.lower_snake_case }};
    }
    {% elif field.type_info.is_primitive %}
    cpp_struct.{{ field.name.lower_snake_case }} = c_struct.{{ field.name.lower_snake_case }};
    {% elif field.type_info.parent_type %}
    cpp_struct.{{ field.name.lower_snake_case }} = translate_{{ field.type_info.parent_type }}_{{ field.type_info.name }}_from_c(c_struct.{{ field.name.lower_snake_case }});
    {% else %}
    cpp_struct.{{ field.name.lower_snake_case }} = translate_{{ field.type_info.name }}_from_c(c_struct.{{ field.name.lower_snake_case }});
    {% endif %}
    {% endfor %}
    return cpp_struct;
}
{% endif %}

{% if not struct.name.upper_camel_case.endswith('Result') %}
{% for nested_enum_name, nested_enum in struct.nested_enums.items() %}

static mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_{{ nested_enum.name.lower_snake_case }}_t
translate_{{ struct.name.lower_snake_case }}_{{ nested_enum.name.lower_snake_case }}_to_c(mavsdk::{{ plugin_name.upper_camel_case }}::{{ struct.name.upper_camel_case }}::{{ nested_enum.name.upper_camel_case }} cpp_enum) {
    switch(cpp_enum) {
        {% for value in nested_enum.values %}
        case mavsdk::{{ plugin_name.upper_camel_case }}::{{ struct.name.upper_camel_case }}::{{ nested_enum.name.upper_camel_case }}::{{ value.name.upper_camel_case }}:
            return MAVSDK_{{ plugin_name.uppercase }}_{{ struct.name.uppercase }}_{{ nested_enum.name.uppercase }}_{{ value.name.uppercase }};
        {% endfor %}
    }
    return MAVSDK_{{ plugin_name.uppercase }}_{{ struct.name.uppercase }}_{{ nested_enum.name.uppercase }}_{{ nested_enum.values[0].name.uppercase }};
}

{% endfor %}
static mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_t
translate_{{ struct.name.lower_snake_case }}_to_c(const mavsdk::{{ plugin_name.upper_camel_case }}::{{ struct.name.upper_camel_case }}& cpp_struct) {
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_t c_struct{};
    {% for field in struct.fields %}
    {% if field.type_info.is_repeated %}
    c_struct.{{ field.name.lower_snake_case }}_size = cpp_struct.{{ field.name.lower_snake_case }}.size();
    {% if field.type_info.is_string %}
    c_struct.{{ field.name.lower_snake_case }} = new char*[c_struct.{{ field.name.lower_snake_case }}_size];
    for (size_t i = 0; i < c_struct.{{ field.name.lower_snake_case }}_size; i++) {
        c_struct.{{ field.name.lower_snake_case }}[i] = strdup(cpp_struct.{{ field.name.lower_snake_case }}[i].c_str());
    }
    {% elif field.type_info.is_primitive %}
    c_struct.{{ field.name.lower_snake_case }} = new {{ field.type_info.inner_name }}[c_struct.{{ field.name.lower_snake_case }}_size];
    std::copy(cpp_struct.{{ field.name.lower_snake_case }}.begin(), cpp_struct.{{ field.name.lower_snake_case }}.end(), c_struct.{{ field.name.lower_snake_case }});
    {% else %}
    c_struct.{{ field.name.lower_snake_case }} = new mavsdk_{{ plugin_name.lower_snake_case }}_{{ field.type_info.inner_name }}_t[c_struct.{{ field.name.lower_snake_case }}_size];
    for (size_t i = 0; i < c_struct.{{ field.name.lower_snake_case }}_size; i++) {
        c_struct.{{ field.name.lower_snake_case }}[i] = translate_{{ field.type_info.inner_name }}_to_c(cpp_struct.{{ field.name.lower_snake_case }}[i]);
    }
    {% endif %}
    {% elif field.type_info.is_string %}
    c_struct.{{ field.name.lower_snake_case }} = strdup(cpp_struct.{{ field.name.lower_snake_case }}.c_str());
    {% elif field.type_info.is_primitive %}
    c_struct.{{ field.name.lower_snake_case }} = cpp_struct.{{ field.name.lower_snake_case }};
    {% elif field.type_info.parent_type %}
    c_struct.{{ field.name.lower_snake_case }} = translate_{{ field.type_info.parent_type }}_{{ field.type_info.name }}_to_c(cpp_struct.{{ field.name.lower_snake_case }});
    {% else %}
    c_struct.{{ field.name.lower_snake_case }} = translate_{{ field.type_info.name }}_to_c(cpp_struct.{{ field.name.lower_snake_case }});
    {% endif %}
    {% endfor %}
    return c_struct;
}

void mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_destroy(
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_t* target) {
    if (!target) return;
    {% for field in struct.fields %}
    {% if field.type_info.is_repeated %}
    if (target->{{ field.name.lower_snake_case }}) {
        {% if field.type_info.is_string %}
        for (size_t i = 0; i < target->{{ field.name.lower_snake_case }}_size; i++) {
            if (target->{{ field.name.lower_snake_case }}[i]) {
                free(target->{{ field.name.lower_snake_case }}[i]);
            }
        }
        delete[] target->{{ field.name.lower_snake_case }};
        {% elif field.type_info.is_enum %}
        delete[] target->{{ field.name.lower_snake_case }};
        {% elif not field.type_info.is_primitive %}
        for (size_t i = 0; i < target->{{ field.name.lower_snake_case }}_size; i++) {
            mavsdk_{{ plugin_name.lower_snake_case }}_{{ field.type_info.inner_name }}_destroy(&target->{{ field.name.lower_snake_case }}[i]);
        }
        delete[] target->{{ field.name.lower_snake_case }};
        {% else %}
        delete[] target->{{ field.name.lower_snake_case }};
        {% endif %}
        target->{{ field.name.lower_snake_case }} = nullptr;
        target->{{ field.name.lower_snake_case }}_size = 0;
    }
    {% elif field.type_info.is_string %}
    if (target->{{ field.name.lower_snake_case }}) {
        free((void*)target->{{ field.name.lower_snake_case }});
        target->{{ field.name.lower_snake_case }} = nullptr;
    }
    {% endif %}
    {% endfor %}
}

void mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_array_destroy(
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}

{% endif %}
{% endfor %}

// ===== Primitive Array Destroy Functions =====
{% set primitive_types = ['float', 'double', 'int32_t', 'uint32_t', 'int64_t', 'uint64_t', 'bool'] %}
{% for prim_type in primitive_types %}
void mavsdk_{{ plugin_name.lower_snake_case }}_{{ prim_type | replace('_', '') }}_array_destroy({{ prim_type }}** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

{% endfor %}

void mavsdk_{{ plugin_name.lower_snake_case }}_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_{{ plugin_name.lower_snake_case }}_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== {{ plugin_name.upper_camel_case }} Wrapper =====

struct mavsdk_{{ plugin_name.lower_snake_case }}_wrapper {
    std::shared_ptr<mavsdk::{{ plugin_name.upper_camel_case }}> cpp_plugin;
};

{% if is_server %}
mavsdk_{{ plugin_name.lower_snake_case }}_t
mavsdk_{{ plugin_name.lower_snake_case }}_create(mavsdk_server_component_t server_component) {
    if (server_component == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_{{ plugin_name.lower_snake_case }}_wrapper();
    auto server_component_ptr = static_cast<std::shared_ptr<mavsdk::ServerComponent>*>(server_component);
    wrapper->cpp_plugin = std::make_shared<mavsdk::{{ plugin_name.upper_camel_case }}>(*server_component_ptr);

    return wrapper;
}
{% else %}
mavsdk_{{ plugin_name.lower_snake_case }}_t
mavsdk_{{ plugin_name.lower_snake_case }}_create(mavsdk_system_t system) {
    if (system == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_{{ plugin_name.lower_snake_case }}_wrapper();
    auto system_ptr = static_cast<std::shared_ptr<mavsdk::System>*>(system);
    wrapper->cpp_plugin = std::make_shared<mavsdk::{{ plugin_name.upper_camel_case }}>(*system_ptr);

    return wrapper;
}
{% endif %}

void mavsdk_{{ plugin_name.lower_snake_case }}_destroy(mavsdk_{{ plugin_name.lower_snake_case }}_t {{ plugin_name.lower_snake_case }}) {
    if ({{ plugin_name.lower_snake_case }} == nullptr) {
        return;
    }

    auto wrapper = static_cast<mavsdk_{{ plugin_name.lower_snake_case }}_wrapper*>({{ plugin_name.lower_snake_case }});
    delete wrapper;
}

// ===== Method Implementations =====
{% for method in methods %}

{% if method.is_async %}
// {{ method.name.upper_camel_case }} async
{% if method.is_stream and not method.is_finite%}mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}_handle_t{% else %}void{% endif %} mavsdk_{{ plugin_name.lower_snake_case }}{% if method.is_stream and not method.is_finite %}_subscribe{% endif %}_{{ method.name.lower_snake_case }}{% if not method.is_stream or method.is_finite %}_async{% endif %}(
    mavsdk_{{ plugin_name.lower_snake_case }}_t {{ plugin_name.lower_snake_case }},
    {% for param in method.params %}
    {% if param.type_info.is_repeated %}
    {% if param.type_info.is_primitive %}
    const {{ param.type_info.inner_name }}* {{ param.name.lower_snake_case }},
    size_t {{ param.name.lower_snake_case }}_size,
    {% else %}
    const mavsdk_{{ plugin_name.lower_snake_case }}_{{ param.type_info.inner_name }}_t* {{ param.name.lower_snake_case }},
    size_t {{ param.name.lower_snake_case }}_size,
    {% endif %}
    {% elif param.type_info.is_primitive %}
    {{ param.type_info.name }} {{ param.name.lower_snake_case }},
    {% elif param.type_info.parent_type %}
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ param.type_info.parent_type }}_{{ param.type_info.name }}_t {{ param.name.lower_snake_case }},
    {% else %}
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ param.type_info.name }}_t {{ param.name.lower_snake_case }},
    {% endif %}
    {% endfor %}
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}_callback_t callback,
    void* user_data)
{
    auto wrapper = static_cast<mavsdk_{{ plugin_name.lower_snake_case }}_wrapper*>({{ plugin_name.lower_snake_case }});

    {% if method.is_stream and not method.is_finite %}
    auto cpp_handle = {%- endif %}
    wrapper->cpp_plugin->{% if method.is_stream and not method.is_finite %}subscribe_{% endif %}{{ method.name.lower_snake_case }}{% if not method.is_stream or method.is_finite %}_async{% endif %}(
        {% for param in method.params %}
        {% if param.type_info.is_repeated %}
        {% if param.type_info.is_primitive %}
        std::vector<{{ param.type_info.inner_name }}>({{ param.name.lower_snake_case }}, {{ param.name.lower_snake_case }} + {{ param.name.lower_snake_case }}_size){% if not loop.last %},
        {% endif %}
        {% else %}
        [&{{ param.name.lower_snake_case }}, {{ param.name.lower_snake_case }}_size]() {
            std::vector<mavsdk::{{ plugin_name.upper_camel_case }}::{{ param.type_info.inner_name }}> vec;
            vec.reserve({{ param.name.lower_snake_case }}_size);
            for (size_t i = 0; i < {{ param.name.lower_snake_case }}_size; i++) {
                vec.push_back(translate_{{ param.type_info.inner_name }}_from_c({{ param.name.lower_snake_case }}[i]));
            }
            return vec;
        }(){% if not loop.last %},
        {% endif %}
        {% endif %}
        {% elif param.type_info.is_primitive %}
        {{ param.name.lower_snake_case }}{% if not loop.last %},
        {% endif %}
        {% elif param.type_info.parent_type %}
        translate_{{ param.type_info.parent_type }}_{{ param.type_info.name }}_from_c({{ param.name.lower_snake_case }}){% if not loop.last %},
        {% endif %}
        {% else %}
        translate_{{ param.type_info.name }}_from_c({{ param.name.lower_snake_case }}){% if not loop.last %},{% endif %}
        {% endif %}
        {% endfor %}{% if method.params %},
        {% endif %}
        [callback, user_data](
            {% if method.has_result %}
            mavsdk::{{ plugin_name.upper_camel_case }}::Result result{% if method.return_type %},
            {% endif %}
            {% endif %}
            {% if method.return_type %}
            {% if method.return_type.is_string %}
            const std::string& value
            {%- elif method.return_type.is_primitive %}
            {{ method.return_type.name }} value
            {%- elif method.return_type.is_repeated %}
            std::vector<mavsdk::{{ plugin_name.upper_camel_case }}::{{ method.return_type.inner_name }}> value
            {%- else %}
            mavsdk::{{ plugin_name.upper_camel_case }}::{{ method.return_type.name.upper_camel_case }} value
            {%- endif %}
            {% endif %}) {
                if (callback) {
                    {% if method.return_name and method.return_type.is_repeated %}
                    size_t count = value.size();
                    mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.return_type.inner_name }}_t* {{ method.return_name.lower_snake_case }} = nullptr;

                    if (count > 0) {
                        {{ method.return_name.lower_snake_case }} = new mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.return_type.inner_name }}_t[count];
                        for (size_t i = 0; i < count; i++) {
                            {{ method.return_name.lower_snake_case }}[i] = translate_{{ method.return_type.inner_name }}_to_c(value[i]);
                        }
                    }

                    {% endif %}
                    callback(
                        {% if method.has_result %}
                        translate_result(result),
                        {% endif %}
                        {% if method.return_type %}
                        {% if method.return_type.is_string %}
                        strdup(value.c_str()),
                        {% elif method.return_type.is_primitive %}
                        value,
                        {% elif method.return_type.is_repeated %}
                        {{ method.return_name.lower_snake_case }},
                        count,
                        {% else %}
                        translate_{{ method.return_type.name.lower_snake_case }}_to_c(value),
                        {% endif %}
                        {% endif %}
                        user_data);
                }
        });
    {% if method.is_stream and not method.is_finite %}

    auto handle_wrapper = new mavsdk::{{ plugin_name.upper_camel_case }}::{{ method.name.upper_camel_case }}Handle(std::move(cpp_handle));
    return static_cast<mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}_handle_t>(handle_wrapper);
    {% endif %}
}

{% if method.is_stream and not method.is_finite %}
void mavsdk_{{ plugin_name.lower_snake_case }}_unsubscribe_{{ method.name.lower_snake_case }}(
    mavsdk_{{ plugin_name.lower_snake_case }}_t {{ plugin_name.lower_snake_case }},
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}_handle_t handle)
{
    if (handle) {
        auto wrapper = static_cast<mavsdk_{{ plugin_name.lower_snake_case }}_wrapper*>({{ plugin_name.lower_snake_case }});
        auto cpp_handle = static_cast<mavsdk::{{ plugin_name.upper_camel_case }}::{{ method.name.upper_camel_case }}Handle*>(handle);
        wrapper->cpp_plugin->unsubscribe_{{ method.name.lower_snake_case }}(std::move(*cpp_handle));
        delete cpp_handle;
    }
}
{% endif %}
{% endif %}

{% if method.is_sync %}
// {{ method.name.upper_camel_case }} sync
{% if method.has_result %}
mavsdk_{{ plugin_name.lower_snake_case }}_result_t
{% else %}
void
{% endif %}
mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}(
    mavsdk_{{ plugin_name.lower_snake_case }}_t {{ plugin_name.lower_snake_case }}{% if method.params %},
    {% for param in method.params %}
    {% if param.type_info.is_repeated %}
    {% if param.type_info.is_primitive %}
    const {{ param.type_info.inner_name }}* {{ param.name.lower_snake_case }},
    size_t {{ param.name.lower_snake_case }}_size{% if not loop.last %},
    {% endif %}
    {% else %}
    const mavsdk_{{ plugin_name.lower_snake_case }}_{{ param.type_info.inner_name }}_t* {{ param.name.lower_snake_case }},
    size_t {{ param.name.lower_snake_case }}_size{% if not loop.last %},
    {% endif %}
    {% endif %}
    {% elif param.type_info.is_primitive %}
    {{ param.type_info.name }} {{ param.name.lower_snake_case }}{% if not loop.last %},
    {% endif %}
    {% elif param.type_info.parent_type %}
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ param.type_info.parent_type }}_{{ param.type_info.name }}_t {{ param.name.lower_snake_case }}{% if not loop.last %},
    {% endif %}
    {% else %}
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ param.type_info.name }}_t {{ param.name.lower_snake_case }}{% if not loop.last %},
    {% endif %}
    {% endif %}
    {% endfor %}{% endif %}{% if method.return_name %},
    {% if method.return_type.is_primitive %}
    {{ method.return_type.name }}* {{ method.return_name.lower_snake_case }}_out)
    {% elif method.return_type.is_repeated %}
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.return_type.inner_name }}_t** {{ method.return_name.lower_snake_case }}_out,
    size_t* {{ method.return_name.lower_snake_case }}_size_out)
    {% else %}
    mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.return_type.inner_name }}_t* {{ method.return_name.lower_snake_case }}_out)
    {% endif %}
    {% else %})
    {% endif %}
{
    auto wrapper = static_cast<mavsdk_{{ plugin_name.lower_snake_case }}_wrapper*>({{ plugin_name.lower_snake_case }});

    {% if method.has_result and method.return_name %}
    auto result_pair = wrapper->cpp_plugin->{{ method.name.lower_snake_case }}(
        {% for param in method.params %}
        {% if param.type_info.is_repeated %}
        {% if param.type_info.is_primitive %}
        std::vector<{{ param.type_info.inner_name }}>({{ param.name.lower_snake_case }}, {{ param.name.lower_snake_case }} + {{ param.name.lower_snake_case }}_size){% if not loop.last %},
        {% endif %}
        {% else %}
        [&{{ param.name.lower_snake_case }}, {{ param.name.lower_snake_case }}_size]() {
            std::vector<mavsdk::{{ plugin_name.upper_camel_case }}::{{ param.type_info.inner_name }}> vec;
            vec.reserve({{ param.name.lower_snake_case }}_size);
            for (size_t i = 0; i < {{ param.name.lower_snake_case }}_size; i++) {
                vec.push_back(translate_{{ param.type_info.inner_name }}_from_c({{ param.name.lower_snake_case }}[i]));
            }
            return vec;
        }(){% if not loop.last %},
        {% endif %}
        {% endif %}
        {% elif param.type_info.is_primitive %}
        {{ param.name.lower_snake_case }}{% if not loop.last %},
        {% endif %}
        {% elif param.type_info.parent_type %}
        translate_{{ param.type_info.parent_type }}_{{ param.type_info.name }}_from_c({{ param.name.lower_snake_case }}){% if not loop.last %},
        {% endif %}
        {% else %}
        translate_{{ param.type_info.name }}_from_c({{ param.name.lower_snake_case }}){% if not loop.last %},
        {% endif %}
        {% endif %}
        {% endfor %});

    {% if method.return_type.is_primitive %}
    {% if method.return_type.is_string %}
    if ({{ method.return_name.lower_snake_case }}_out != nullptr) {
        *{{ method.return_name.lower_snake_case }}_out = strdup(result_pair.second.c_str());
    }
    {% else %}
    *{{ method.return_name.lower_snake_case }}_out = result_pair.second;
    {% endif %}
    {% elif method.return_type.is_repeated %}
    if ({{ method.return_name.lower_snake_case }}_out != nullptr) {
        size_t count = result_pair.second.size();

        *{{ method.return_name.lower_snake_case }}_out = new mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.return_type.inner_name }}_t[count];

        for (size_t i = 0; i < count; i++) {
            (*{{ method.return_name.lower_snake_case }}_out)[i] = translate_{{ method.return_type.inner_name }}_to_c(result_pair.second[i]);
        }

        if ({{ method.return_name.lower_snake_case }}_size_out != nullptr) {
            *{{ method.return_name.lower_snake_case }}_size_out = count;
        }
    }
    {% else %}
    if ({{ method.return_name.lower_snake_case }}_out != nullptr) {
        *{{ method.return_name.lower_snake_case }}_out = translate_{{ method.return_type.name.lower_snake_case }}_to_c(result_pair.second);
    }
    {% endif %}

    return translate_result(result_pair.first);
    {% else %}
    {% if method.has_result or method.return_type %}
    auto ret_value = {% endif %}wrapper->cpp_plugin->{{ method.name.lower_snake_case }}({% for param in method.params %}
        {% if param.type_info.is_repeated %}
        {% if param.type_info.is_primitive %}
        std::vector<{{ param.type_info.inner_name }}>({{ param.name.lower_snake_case }}, {{ param.name.lower_snake_case }} + {{ param.name.lower_snake_case }}_size){% if not loop.last %},{% endif %}
        {% else %}
        [&{{ param.name.lower_snake_case }}, {{ param.name.lower_snake_case }}_size]() {
            std::vector<mavsdk::{{ plugin_name.upper_camel_case }}::{{ param.type_info.inner_name }}> vec;
            vec.reserve({{ param.name.lower_snake_case }}_size);
            for (size_t i = 0; i < {{ param.name.lower_snake_case }}_size; i++) {
                vec.push_back(translate_{{ param.type_info.inner_name }}_from_c({{ param.name.lower_snake_case }}[i]));
            }
            return vec;
        }(){% if not loop.last %},{% endif %}
        {% endif %}
        {% elif param.type_info.is_primitive %}
        {{ param.name.lower_snake_case }}{% if not loop.last %},{% endif %}
        {% elif param.type_info.parent_type %}
        translate_{{ param.type_info.parent_type }}_{{ param.type_info.name }}_from_c({{ param.name.lower_snake_case }}){% if not loop.last %},{% endif %}
        {% else %}
        translate_{{ param.type_info.name }}_from_c({{ param.name.lower_snake_case }}){% if not loop.last %},{% endif %}
        {% endif %}
        {% endfor %});

    {% if method.return_name %}
    {% if method.return_type.is_primitive %}
    {% if method.return_type.is_string %}
    if ({{ method.return_name.lower_snake_case }}_out != nullptr) {
        *{{ method.return_name.lower_snake_case }}_out = strdup(ret_value.c_str());
    }
    {% else %}
    *{{ method.return_name.lower_snake_case }}_out = ret_value;
    {% endif %}
    {% else %}
    if ({{ method.return_name.lower_snake_case }}_out != nullptr) {
        *{{ method.return_name.lower_snake_case }}_out = translate_{{ method.return_type.name.lower_snake_case }}_to_c(ret_value);
    }
    {% endif %}
    {% endif %}
    {% if method.has_result %}
    return translate_result(ret_value);
    {% endif %}
    {% endif %}
}
{% endif %}
{% endfor %}
