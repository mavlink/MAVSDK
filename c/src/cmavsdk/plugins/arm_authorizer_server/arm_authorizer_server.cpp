// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/arm_authorizer_server/arm_authorizer_server.proto)

#include "arm_authorizer_server.h"

#include <mavsdk/plugins/arm_authorizer_server/arm_authorizer_server.h>
#include <algorithm>
#include <cstring>
#include <mutex>
#include <vector>

// ===== C++ to C Type Conversions =====

static mavsdk_arm_authorizer_server_result_t
translate_result(mavsdk::ArmAuthorizerServer::Result cpp_result) {
    switch(cpp_result) {
        case mavsdk::ArmAuthorizerServer::Result::Unknown:
            return MAVSDK_ARM_AUTHORIZER_SERVER_RESULT_UNKNOWN;
        case mavsdk::ArmAuthorizerServer::Result::Success:
            return MAVSDK_ARM_AUTHORIZER_SERVER_RESULT_SUCCESS;
        case mavsdk::ArmAuthorizerServer::Result::Failed:
            return MAVSDK_ARM_AUTHORIZER_SERVER_RESULT_FAILED;
    }
}

static mavsdk::ArmAuthorizerServer::RejectionReason
translate_rejection_reason_from_c(mavsdk_arm_authorizer_server_rejection_reason_t c_enum) {
    switch(c_enum) {
        case MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_GENERIC:
            return mavsdk::ArmAuthorizerServer::RejectionReason::Generic;
        case MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_NONE:
            return mavsdk::ArmAuthorizerServer::RejectionReason::None;
        case MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_INVALID_WAYPOINT:
            return mavsdk::ArmAuthorizerServer::RejectionReason::InvalidWaypoint;
        case MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_TIMEOUT:
            return mavsdk::ArmAuthorizerServer::RejectionReason::Timeout;
        case MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_AIRSPACE_IN_USE:
            return mavsdk::ArmAuthorizerServer::RejectionReason::AirspaceInUse;
        case MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_BAD_WEATHER:
            return mavsdk::ArmAuthorizerServer::RejectionReason::BadWeather;
    }
    return mavsdk::ArmAuthorizerServer::RejectionReason::Generic;
}

static mavsdk_arm_authorizer_server_rejection_reason_t
translate_rejection_reason_to_c(mavsdk::ArmAuthorizerServer::RejectionReason cpp_enum) {
    switch(cpp_enum) {
        case mavsdk::ArmAuthorizerServer::RejectionReason::Generic:
            return MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_GENERIC;
        case mavsdk::ArmAuthorizerServer::RejectionReason::None:
            return MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_NONE;
        case mavsdk::ArmAuthorizerServer::RejectionReason::InvalidWaypoint:
            return MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_INVALID_WAYPOINT;
        case mavsdk::ArmAuthorizerServer::RejectionReason::Timeout:
            return MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_TIMEOUT;
        case mavsdk::ArmAuthorizerServer::RejectionReason::AirspaceInUse:
            return MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_AIRSPACE_IN_USE;
        case mavsdk::ArmAuthorizerServer::RejectionReason::BadWeather:
            return MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_BAD_WEATHER;
    }
    return MAVSDK_ARM_AUTHORIZER_SERVER_REJECTION_REASON_GENERIC;
}




// ===== Primitive Array Destroy Functions =====
void mavsdk_arm_authorizer_server_float_array_destroy(float** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_arm_authorizer_server_double_array_destroy(double** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_arm_authorizer_server_int32t_array_destroy(int32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_arm_authorizer_server_uint32t_array_destroy(uint32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_arm_authorizer_server_int64t_array_destroy(int64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_arm_authorizer_server_uint64t_array_destroy(uint64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_arm_authorizer_server_bool_array_destroy(bool** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}


void mavsdk_arm_authorizer_server_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_arm_authorizer_server_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== ArmAuthorizerServer Wrapper =====

struct mavsdk_arm_authorizer_server_wrapper {
    std::shared_ptr<mavsdk::ArmAuthorizerServer> cpp_plugin;
    std::mutex handles_mutex;
    std::vector<mavsdk::ArmAuthorizerServer::ArmAuthorizationHandle*> arm_authorization_handles;
};

mavsdk_arm_authorizer_server_t
mavsdk_arm_authorizer_server_create(mavsdk_server_component_t server_component) {
    if (server_component == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_arm_authorizer_server_wrapper();
    auto server_component_ptr = reinterpret_cast<std::shared_ptr<mavsdk::ServerComponent>*>(server_component);
    wrapper->cpp_plugin = std::make_shared<mavsdk::ArmAuthorizerServer>(*server_component_ptr);

    return reinterpret_cast<mavsdk_arm_authorizer_server_t>(wrapper);
}

void mavsdk_arm_authorizer_server_destroy(mavsdk_arm_authorizer_server_t arm_authorizer_server) {
    if (arm_authorizer_server == nullptr) {
        return;
    }

    auto wrapper = reinterpret_cast<mavsdk_arm_authorizer_server_wrapper*>(arm_authorizer_server);

    // Unsubscribe all active streams before destroying to prevent
    // callbacks firing into a destroyed object
    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
        for (auto* h : wrapper->arm_authorization_handles) {
            wrapper->cpp_plugin->unsubscribe_arm_authorization(std::move(*h));
            delete h;
        }
        wrapper->arm_authorization_handles.clear();
    }

    delete wrapper;
}

// ===== Method Implementations =====

// ArmAuthorization async
mavsdk_arm_authorizer_server_arm_authorization_handle_t mavsdk_arm_authorizer_server_subscribe_arm_authorization(
    mavsdk_arm_authorizer_server_t arm_authorizer_server,
    mavsdk_arm_authorizer_server_arm_authorization_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_arm_authorizer_server_wrapper*>(arm_authorizer_server);

    auto cpp_handle =    wrapper->cpp_plugin->subscribe_arm_authorization(
        [callback, user_data](
            uint32_t value) {
                if (callback) {
                    callback(
                        value,
                        user_data);
                }
        });

    auto cpp_handle_ptr = new mavsdk::ArmAuthorizerServer::ArmAuthorizationHandle(std::move(cpp_handle));

    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
        wrapper->arm_authorization_handles.push_back(cpp_handle_ptr);
    }

    return reinterpret_cast<mavsdk_arm_authorizer_server_arm_authorization_handle_t>(cpp_handle_ptr);
}

void mavsdk_arm_authorizer_server_unsubscribe_arm_authorization(
    mavsdk_arm_authorizer_server_t arm_authorizer_server,
    mavsdk_arm_authorizer_server_arm_authorization_handle_t handle)
{
    if (handle) {
        auto wrapper = reinterpret_cast<mavsdk_arm_authorizer_server_wrapper*>(arm_authorizer_server);
        auto cpp_handle = reinterpret_cast<mavsdk::ArmAuthorizerServer::ArmAuthorizationHandle*>(handle);

        {
            std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
            auto& vec = wrapper->arm_authorization_handles;
            vec.erase(std::remove(vec.begin(), vec.end(), cpp_handle), vec.end());
        }

        wrapper->cpp_plugin->unsubscribe_arm_authorization(std::move(*cpp_handle));
        delete cpp_handle;
    }
}



// AcceptArmAuthorization sync
mavsdk_arm_authorizer_server_result_t
mavsdk_arm_authorizer_server_accept_arm_authorization(
    mavsdk_arm_authorizer_server_t arm_authorizer_server,
    int32_t valid_time_s)
{
    auto wrapper = reinterpret_cast<mavsdk_arm_authorizer_server_wrapper*>(arm_authorizer_server);

    auto ret_value = wrapper->cpp_plugin->accept_arm_authorization(        valid_time_s);

    return translate_result(ret_value);
}


// RejectArmAuthorization sync
mavsdk_arm_authorizer_server_result_t
mavsdk_arm_authorizer_server_reject_arm_authorization(
    mavsdk_arm_authorizer_server_t arm_authorizer_server,
    bool temporarily,
    mavsdk_arm_authorizer_server_rejection_reason_t reason,
    int32_t extra_info)
{
    auto wrapper = reinterpret_cast<mavsdk_arm_authorizer_server_wrapper*>(arm_authorizer_server);

    auto ret_value = wrapper->cpp_plugin->reject_arm_authorization(        temporarily,        translate_rejection_reason_from_c(reason),        extra_info);

    return translate_result(ret_value);
}
