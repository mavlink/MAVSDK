// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/server_utility/server_utility.proto)

#include "server_utility.h"

#include <mavsdk/plugins/server_utility/server_utility.h>
#include <algorithm>
#include <cstring>
#include <mutex>
#include <vector>

// ===== C++ to C Type Conversions =====

static mavsdk_server_utility_result_t
translate_result(mavsdk::ServerUtility::Result cpp_result) {
    switch(cpp_result) {
        case mavsdk::ServerUtility::Result::Unknown:
            return MAVSDK_SERVER_UTILITY_RESULT_UNKNOWN;
        case mavsdk::ServerUtility::Result::Success:
            return MAVSDK_SERVER_UTILITY_RESULT_SUCCESS;
        case mavsdk::ServerUtility::Result::NoSystem:
            return MAVSDK_SERVER_UTILITY_RESULT_NO_SYSTEM;
        case mavsdk::ServerUtility::Result::ConnectionError:
            return MAVSDK_SERVER_UTILITY_RESULT_CONNECTION_ERROR;
        case mavsdk::ServerUtility::Result::InvalidArgument:
            return MAVSDK_SERVER_UTILITY_RESULT_INVALID_ARGUMENT;
    }
}

static mavsdk::ServerUtility::StatusTextType
translate_status_text_type_from_c(mavsdk_server_utility_status_text_type_t c_enum) {
    switch(c_enum) {
        case MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_DEBUG:
            return mavsdk::ServerUtility::StatusTextType::Debug;
        case MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_INFO:
            return mavsdk::ServerUtility::StatusTextType::Info;
        case MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_NOTICE:
            return mavsdk::ServerUtility::StatusTextType::Notice;
        case MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_WARNING:
            return mavsdk::ServerUtility::StatusTextType::Warning;
        case MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_ERROR:
            return mavsdk::ServerUtility::StatusTextType::Error;
        case MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_CRITICAL:
            return mavsdk::ServerUtility::StatusTextType::Critical;
        case MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_ALERT:
            return mavsdk::ServerUtility::StatusTextType::Alert;
        case MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_EMERGENCY:
            return mavsdk::ServerUtility::StatusTextType::Emergency;
    }
    return mavsdk::ServerUtility::StatusTextType::Debug;
}

static mavsdk_server_utility_status_text_type_t
translate_status_text_type_to_c(mavsdk::ServerUtility::StatusTextType cpp_enum) {
    switch(cpp_enum) {
        case mavsdk::ServerUtility::StatusTextType::Debug:
            return MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_DEBUG;
        case mavsdk::ServerUtility::StatusTextType::Info:
            return MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_INFO;
        case mavsdk::ServerUtility::StatusTextType::Notice:
            return MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_NOTICE;
        case mavsdk::ServerUtility::StatusTextType::Warning:
            return MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_WARNING;
        case mavsdk::ServerUtility::StatusTextType::Error:
            return MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_ERROR;
        case mavsdk::ServerUtility::StatusTextType::Critical:
            return MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_CRITICAL;
        case mavsdk::ServerUtility::StatusTextType::Alert:
            return MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_ALERT;
        case mavsdk::ServerUtility::StatusTextType::Emergency:
            return MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_EMERGENCY;
    }
    return MAVSDK_SERVER_UTILITY_STATUS_TEXT_TYPE_DEBUG;
}




// ===== Primitive Array Destroy Functions =====
void mavsdk_server_utility_float_array_destroy(float** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_server_utility_double_array_destroy(double** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_server_utility_int32t_array_destroy(int32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_server_utility_uint32t_array_destroy(uint32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_server_utility_int64t_array_destroy(int64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_server_utility_uint64t_array_destroy(uint64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_server_utility_bool_array_destroy(bool** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}


void mavsdk_server_utility_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_server_utility_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== ServerUtility Wrapper =====

struct mavsdk_server_utility_wrapper {
    std::shared_ptr<mavsdk::ServerUtility> cpp_plugin;
    std::mutex handles_mutex;
};

mavsdk_server_utility_t
mavsdk_server_utility_create(mavsdk_system_t system) {
    if (system == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_server_utility_wrapper();
    auto system_ptr = reinterpret_cast<std::shared_ptr<mavsdk::System>*>(system);
    wrapper->cpp_plugin = std::make_shared<mavsdk::ServerUtility>(*system_ptr);

    return reinterpret_cast<mavsdk_server_utility_t>(wrapper);
}

void mavsdk_server_utility_destroy(mavsdk_server_utility_t server_utility) {
    if (server_utility == nullptr) {
        return;
    }

    auto wrapper = reinterpret_cast<mavsdk_server_utility_wrapper*>(server_utility);

    // Unsubscribe all active streams before destroying to prevent
    // callbacks firing into a destroyed object
    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
    }

    delete wrapper;
}

// ===== Method Implementations =====


// SendStatusText sync
mavsdk_server_utility_result_t
mavsdk_server_utility_send_status_text(
    mavsdk_server_utility_t server_utility,
    mavsdk_server_utility_status_text_type_t type,
    char* text)
{
    auto wrapper = reinterpret_cast<mavsdk_server_utility_wrapper*>(server_utility);

    auto ret_value = wrapper->cpp_plugin->send_status_text(        translate_status_text_type_from_c(type),        text);

    return translate_result(ret_value);
}
