// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/param_server/param_server.proto)

#include "param_server.h"

#include <mavsdk/plugins/param_server/param_server.h>
#include <algorithm>
#include <cstring>
#include <mutex>
#include <vector>

// ===== C++ to C Type Conversions =====

static mavsdk_param_server_result_t
translate_result(mavsdk::ParamServer::Result cpp_result) {
    switch(cpp_result) {
        case mavsdk::ParamServer::Result::Unknown:
            return MAVSDK_PARAM_SERVER_RESULT_UNKNOWN;
        case mavsdk::ParamServer::Result::Success:
            return MAVSDK_PARAM_SERVER_RESULT_SUCCESS;
        case mavsdk::ParamServer::Result::NotFound:
            return MAVSDK_PARAM_SERVER_RESULT_NOT_FOUND;
        case mavsdk::ParamServer::Result::WrongType:
            return MAVSDK_PARAM_SERVER_RESULT_WRONG_TYPE;
        case mavsdk::ParamServer::Result::ParamNameTooLong:
            return MAVSDK_PARAM_SERVER_RESULT_PARAM_NAME_TOO_LONG;
        case mavsdk::ParamServer::Result::NoSystem:
            return MAVSDK_PARAM_SERVER_RESULT_NO_SYSTEM;
        case mavsdk::ParamServer::Result::ParamValueTooLong:
            return MAVSDK_PARAM_SERVER_RESULT_PARAM_VALUE_TOO_LONG;
        case mavsdk::ParamServer::Result::ParamProvidedTooLate:
            return MAVSDK_PARAM_SERVER_RESULT_PARAM_PROVIDED_TOO_LATE;
    }
}



static mavsdk::ParamServer::IntParam
translate_int_param_from_c(const mavsdk_param_server_int_param_t& c_struct) {
    mavsdk::ParamServer::IntParam cpp_struct{};
    if (c_struct.name) {
        cpp_struct.name = c_struct.name;
    }
    cpp_struct.value = c_struct.value;
    return cpp_struct;
}

static mavsdk_param_server_int_param_t
translate_int_param_to_c(const mavsdk::ParamServer::IntParam& cpp_struct) {
    mavsdk_param_server_int_param_t c_struct{};
    c_struct.name = strdup(cpp_struct.name.c_str());
    c_struct.value = cpp_struct.value;
    return c_struct;
}

void mavsdk_param_server_int_param_destroy(
    mavsdk_param_server_int_param_t* target) {
    if (!target) return;
    if (target->name) {
        free((void*)target->name);
        target->name = nullptr;
    }
}

void mavsdk_param_server_int_param_array_destroy(
    mavsdk_param_server_int_param_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_param_server_int_param_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}


static mavsdk::ParamServer::FloatParam
translate_float_param_from_c(const mavsdk_param_server_float_param_t& c_struct) {
    mavsdk::ParamServer::FloatParam cpp_struct{};
    if (c_struct.name) {
        cpp_struct.name = c_struct.name;
    }
    cpp_struct.value = c_struct.value;
    return cpp_struct;
}

static mavsdk_param_server_float_param_t
translate_float_param_to_c(const mavsdk::ParamServer::FloatParam& cpp_struct) {
    mavsdk_param_server_float_param_t c_struct{};
    c_struct.name = strdup(cpp_struct.name.c_str());
    c_struct.value = cpp_struct.value;
    return c_struct;
}

void mavsdk_param_server_float_param_destroy(
    mavsdk_param_server_float_param_t* target) {
    if (!target) return;
    if (target->name) {
        free((void*)target->name);
        target->name = nullptr;
    }
}

void mavsdk_param_server_float_param_array_destroy(
    mavsdk_param_server_float_param_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_param_server_float_param_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}


static mavsdk::ParamServer::CustomParam
translate_custom_param_from_c(const mavsdk_param_server_custom_param_t& c_struct) {
    mavsdk::ParamServer::CustomParam cpp_struct{};
    if (c_struct.name) {
        cpp_struct.name = c_struct.name;
    }
    if (c_struct.value) {
        cpp_struct.value = c_struct.value;
    }
    return cpp_struct;
}

static mavsdk_param_server_custom_param_t
translate_custom_param_to_c(const mavsdk::ParamServer::CustomParam& cpp_struct) {
    mavsdk_param_server_custom_param_t c_struct{};
    c_struct.name = strdup(cpp_struct.name.c_str());
    c_struct.value = strdup(cpp_struct.value.c_str());
    return c_struct;
}

void mavsdk_param_server_custom_param_destroy(
    mavsdk_param_server_custom_param_t* target) {
    if (!target) return;
    if (target->name) {
        free((void*)target->name);
        target->name = nullptr;
    }
    if (target->value) {
        free((void*)target->value);
        target->value = nullptr;
    }
}

void mavsdk_param_server_custom_param_array_destroy(
    mavsdk_param_server_custom_param_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_param_server_custom_param_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}


static mavsdk::ParamServer::AllParams
translate_all_params_from_c(const mavsdk_param_server_all_params_t& c_struct) {
    mavsdk::ParamServer::AllParams cpp_struct{};
    cpp_struct.int_params.reserve(c_struct.int_params_size);
    for (size_t i = 0; i < c_struct.int_params_size; i++) {
        cpp_struct.int_params.push_back(
            translate_int_param_from_c(c_struct.int_params[i]));
    }
    cpp_struct.float_params.reserve(c_struct.float_params_size);
    for (size_t i = 0; i < c_struct.float_params_size; i++) {
        cpp_struct.float_params.push_back(
            translate_float_param_from_c(c_struct.float_params[i]));
    }
    cpp_struct.custom_params.reserve(c_struct.custom_params_size);
    for (size_t i = 0; i < c_struct.custom_params_size; i++) {
        cpp_struct.custom_params.push_back(
            translate_custom_param_from_c(c_struct.custom_params[i]));
    }
    return cpp_struct;
}

static mavsdk_param_server_all_params_t
translate_all_params_to_c(const mavsdk::ParamServer::AllParams& cpp_struct) {
    mavsdk_param_server_all_params_t c_struct{};
    c_struct.int_params_size = cpp_struct.int_params.size();
    c_struct.int_params = new mavsdk_param_server_int_param_t[c_struct.int_params_size];
    for (size_t i = 0; i < c_struct.int_params_size; i++) {
        c_struct.int_params[i] = translate_int_param_to_c(cpp_struct.int_params[i]);
    }
    c_struct.float_params_size = cpp_struct.float_params.size();
    c_struct.float_params = new mavsdk_param_server_float_param_t[c_struct.float_params_size];
    for (size_t i = 0; i < c_struct.float_params_size; i++) {
        c_struct.float_params[i] = translate_float_param_to_c(cpp_struct.float_params[i]);
    }
    c_struct.custom_params_size = cpp_struct.custom_params.size();
    c_struct.custom_params = new mavsdk_param_server_custom_param_t[c_struct.custom_params_size];
    for (size_t i = 0; i < c_struct.custom_params_size; i++) {
        c_struct.custom_params[i] = translate_custom_param_to_c(cpp_struct.custom_params[i]);
    }
    return c_struct;
}

void mavsdk_param_server_all_params_destroy(
    mavsdk_param_server_all_params_t* target) {
    if (!target) return;
    if (target->int_params) {
        for (size_t i = 0; i < target->int_params_size; i++) {
            mavsdk_param_server_int_param_destroy(&target->int_params[i]);
        }
        delete[] target->int_params;
        target->int_params = nullptr;
        target->int_params_size = 0;
    }
    if (target->float_params) {
        for (size_t i = 0; i < target->float_params_size; i++) {
            mavsdk_param_server_float_param_destroy(&target->float_params[i]);
        }
        delete[] target->float_params;
        target->float_params = nullptr;
        target->float_params_size = 0;
    }
    if (target->custom_params) {
        for (size_t i = 0; i < target->custom_params_size; i++) {
            mavsdk_param_server_custom_param_destroy(&target->custom_params[i]);
        }
        delete[] target->custom_params;
        target->custom_params = nullptr;
        target->custom_params_size = 0;
    }
}

void mavsdk_param_server_all_params_array_destroy(
    mavsdk_param_server_all_params_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_param_server_all_params_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}



// ===== Primitive Array Destroy Functions =====
void mavsdk_param_server_float_array_destroy(float** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_server_double_array_destroy(double** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_server_int32t_array_destroy(int32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_server_uint32t_array_destroy(uint32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_server_int64t_array_destroy(int64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_server_uint64t_array_destroy(uint64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_server_bool_array_destroy(bool** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}


void mavsdk_param_server_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_param_server_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== ParamServer Wrapper =====

struct mavsdk_param_server_wrapper {
    std::shared_ptr<mavsdk::ParamServer> cpp_plugin;
    std::mutex handles_mutex;
    std::vector<mavsdk::ParamServer::ChangedParamIntHandle*> changed_param_int_handles;
    std::vector<mavsdk::ParamServer::ChangedParamFloatHandle*> changed_param_float_handles;
    std::vector<mavsdk::ParamServer::ChangedParamCustomHandle*> changed_param_custom_handles;
};

mavsdk_param_server_t
mavsdk_param_server_create(mavsdk_server_component_t server_component) {
    if (server_component == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_param_server_wrapper();
    auto server_component_ptr = reinterpret_cast<std::shared_ptr<mavsdk::ServerComponent>*>(server_component);
    wrapper->cpp_plugin = std::make_shared<mavsdk::ParamServer>(*server_component_ptr);

    return reinterpret_cast<mavsdk_param_server_t>(wrapper);
}

void mavsdk_param_server_destroy(mavsdk_param_server_t param_server) {
    if (param_server == nullptr) {
        return;
    }

    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    // Unsubscribe all active streams before destroying to prevent
    // callbacks firing into a destroyed object
    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
        for (auto* h : wrapper->changed_param_int_handles) {
            wrapper->cpp_plugin->unsubscribe_changed_param_int(std::move(*h));
            delete h;
        }
        wrapper->changed_param_int_handles.clear();
        for (auto* h : wrapper->changed_param_float_handles) {
            wrapper->cpp_plugin->unsubscribe_changed_param_float(std::move(*h));
            delete h;
        }
        wrapper->changed_param_float_handles.clear();
        for (auto* h : wrapper->changed_param_custom_handles) {
            wrapper->cpp_plugin->unsubscribe_changed_param_custom(std::move(*h));
            delete h;
        }
        wrapper->changed_param_custom_handles.clear();
    }

    delete wrapper;
}

// ===== Method Implementations =====


// SetProtocol sync
mavsdk_param_server_result_t
mavsdk_param_server_set_protocol(
    mavsdk_param_server_t param_server,
    bool extended_protocol)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto ret_value = wrapper->cpp_plugin->set_protocol(        extended_protocol);

    return translate_result(ret_value);
}


// RetrieveParamInt sync
mavsdk_param_server_result_t
mavsdk_param_server_retrieve_param_int(
    mavsdk_param_server_t param_server,
    char* name,
    int32_t* value_out)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto result_pair = wrapper->cpp_plugin->retrieve_param_int(
        name);

    *value_out = result_pair.second;

    return translate_result(result_pair.first);
}


// ProvideParamInt sync
mavsdk_param_server_result_t
mavsdk_param_server_provide_param_int(
    mavsdk_param_server_t param_server,
    char* name,
    int32_t value)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto ret_value = wrapper->cpp_plugin->provide_param_int(        name,        value);

    return translate_result(ret_value);
}


// RetrieveParamFloat sync
mavsdk_param_server_result_t
mavsdk_param_server_retrieve_param_float(
    mavsdk_param_server_t param_server,
    char* name,
    float* value_out)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto result_pair = wrapper->cpp_plugin->retrieve_param_float(
        name);

    *value_out = result_pair.second;

    return translate_result(result_pair.first);
}


// ProvideParamFloat sync
mavsdk_param_server_result_t
mavsdk_param_server_provide_param_float(
    mavsdk_param_server_t param_server,
    char* name,
    float value)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto ret_value = wrapper->cpp_plugin->provide_param_float(        name,        value);

    return translate_result(ret_value);
}


// RetrieveParamCustom sync
mavsdk_param_server_result_t
mavsdk_param_server_retrieve_param_custom(
    mavsdk_param_server_t param_server,
    char* name,
    char** value_out)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto result_pair = wrapper->cpp_plugin->retrieve_param_custom(
        name);

    if (value_out != nullptr) {
        *value_out = strdup(result_pair.second.c_str());
    }

    return translate_result(result_pair.first);
}


// ProvideParamCustom sync
mavsdk_param_server_result_t
mavsdk_param_server_provide_param_custom(
    mavsdk_param_server_t param_server,
    char* name,
    char* value)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto ret_value = wrapper->cpp_plugin->provide_param_custom(        name,        value);

    return translate_result(ret_value);
}


// RetrieveAllParams sync
void
mavsdk_param_server_retrieve_all_params(
    mavsdk_param_server_t param_server,
    mavsdk_param_server_all_params_t* params_out)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto ret_value = wrapper->cpp_plugin->retrieve_all_params();

    if (params_out != nullptr) {
        *params_out = translate_all_params_to_c(ret_value);
    }
}

// ChangedParamInt async
mavsdk_param_server_changed_param_int_handle_t mavsdk_param_server_subscribe_changed_param_int(
    mavsdk_param_server_t param_server,
    mavsdk_param_server_changed_param_int_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto cpp_handle =    wrapper->cpp_plugin->subscribe_changed_param_int(
        [callback, user_data](
            mavsdk::ParamServer::IntParam value) {
                if (callback) {
                    callback(
                        translate_int_param_to_c(value),
                        user_data);
                }
        });

    auto cpp_handle_ptr = new mavsdk::ParamServer::ChangedParamIntHandle(std::move(cpp_handle));

    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
        wrapper->changed_param_int_handles.push_back(cpp_handle_ptr);
    }

    return reinterpret_cast<mavsdk_param_server_changed_param_int_handle_t>(cpp_handle_ptr);
}

void mavsdk_param_server_unsubscribe_changed_param_int(
    mavsdk_param_server_t param_server,
    mavsdk_param_server_changed_param_int_handle_t handle)
{
    if (handle) {
        auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);
        auto cpp_handle = reinterpret_cast<mavsdk::ParamServer::ChangedParamIntHandle*>(handle);

        {
            std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
            auto& vec = wrapper->changed_param_int_handles;
            vec.erase(std::remove(vec.begin(), vec.end(), cpp_handle), vec.end());
        }

        wrapper->cpp_plugin->unsubscribe_changed_param_int(std::move(*cpp_handle));
        delete cpp_handle;
    }
}


// ChangedParamFloat async
mavsdk_param_server_changed_param_float_handle_t mavsdk_param_server_subscribe_changed_param_float(
    mavsdk_param_server_t param_server,
    mavsdk_param_server_changed_param_float_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto cpp_handle =    wrapper->cpp_plugin->subscribe_changed_param_float(
        [callback, user_data](
            mavsdk::ParamServer::FloatParam value) {
                if (callback) {
                    callback(
                        translate_float_param_to_c(value),
                        user_data);
                }
        });

    auto cpp_handle_ptr = new mavsdk::ParamServer::ChangedParamFloatHandle(std::move(cpp_handle));

    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
        wrapper->changed_param_float_handles.push_back(cpp_handle_ptr);
    }

    return reinterpret_cast<mavsdk_param_server_changed_param_float_handle_t>(cpp_handle_ptr);
}

void mavsdk_param_server_unsubscribe_changed_param_float(
    mavsdk_param_server_t param_server,
    mavsdk_param_server_changed_param_float_handle_t handle)
{
    if (handle) {
        auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);
        auto cpp_handle = reinterpret_cast<mavsdk::ParamServer::ChangedParamFloatHandle*>(handle);

        {
            std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
            auto& vec = wrapper->changed_param_float_handles;
            vec.erase(std::remove(vec.begin(), vec.end(), cpp_handle), vec.end());
        }

        wrapper->cpp_plugin->unsubscribe_changed_param_float(std::move(*cpp_handle));
        delete cpp_handle;
    }
}


// ChangedParamCustom async
mavsdk_param_server_changed_param_custom_handle_t mavsdk_param_server_subscribe_changed_param_custom(
    mavsdk_param_server_t param_server,
    mavsdk_param_server_changed_param_custom_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);

    auto cpp_handle =    wrapper->cpp_plugin->subscribe_changed_param_custom(
        [callback, user_data](
            mavsdk::ParamServer::CustomParam value) {
                if (callback) {
                    callback(
                        translate_custom_param_to_c(value),
                        user_data);
                }
        });

    auto cpp_handle_ptr = new mavsdk::ParamServer::ChangedParamCustomHandle(std::move(cpp_handle));

    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
        wrapper->changed_param_custom_handles.push_back(cpp_handle_ptr);
    }

    return reinterpret_cast<mavsdk_param_server_changed_param_custom_handle_t>(cpp_handle_ptr);
}

void mavsdk_param_server_unsubscribe_changed_param_custom(
    mavsdk_param_server_t param_server,
    mavsdk_param_server_changed_param_custom_handle_t handle)
{
    if (handle) {
        auto wrapper = reinterpret_cast<mavsdk_param_server_wrapper*>(param_server);
        auto cpp_handle = reinterpret_cast<mavsdk::ParamServer::ChangedParamCustomHandle*>(handle);

        {
            std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
            auto& vec = wrapper->changed_param_custom_handles;
            vec.erase(std::remove(vec.begin(), vec.end(), cpp_handle), vec.end());
        }

        wrapper->cpp_plugin->unsubscribe_changed_param_custom(std::move(*cpp_handle));
        delete cpp_handle;
    }
}

