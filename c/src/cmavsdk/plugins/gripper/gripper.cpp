// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/gripper/gripper.proto)

#include "gripper.h"

#include <mavsdk/plugins/gripper/gripper.h>
#include <algorithm>
#include <cstring>
#include <mutex>
#include <vector>

// ===== C++ to C Type Conversions =====

static mavsdk_gripper_result_t
translate_result(mavsdk::Gripper::Result cpp_result) {
    switch(cpp_result) {
        case mavsdk::Gripper::Result::Unknown:
            return MAVSDK_GRIPPER_RESULT_UNKNOWN;
        case mavsdk::Gripper::Result::Success:
            return MAVSDK_GRIPPER_RESULT_SUCCESS;
        case mavsdk::Gripper::Result::NoSystem:
            return MAVSDK_GRIPPER_RESULT_NO_SYSTEM;
        case mavsdk::Gripper::Result::Busy:
            return MAVSDK_GRIPPER_RESULT_BUSY;
        case mavsdk::Gripper::Result::Timeout:
            return MAVSDK_GRIPPER_RESULT_TIMEOUT;
        case mavsdk::Gripper::Result::Unsupported:
            return MAVSDK_GRIPPER_RESULT_UNSUPPORTED;
        case mavsdk::Gripper::Result::Failed:
            return MAVSDK_GRIPPER_RESULT_FAILED;
    }
}

static mavsdk::Gripper::GripperAction
translate_gripper_action_from_c(mavsdk_gripper_gripper_action_t c_enum) {
    switch(c_enum) {
        case MAVSDK_GRIPPER_GRIPPER_ACTION_RELEASE:
            return mavsdk::Gripper::GripperAction::Release;
        case MAVSDK_GRIPPER_GRIPPER_ACTION_GRAB:
            return mavsdk::Gripper::GripperAction::Grab;
    }
    return mavsdk::Gripper::GripperAction::Release;
}

static mavsdk_gripper_gripper_action_t
translate_gripper_action_to_c(mavsdk::Gripper::GripperAction cpp_enum) {
    switch(cpp_enum) {
        case mavsdk::Gripper::GripperAction::Release:
            return MAVSDK_GRIPPER_GRIPPER_ACTION_RELEASE;
        case mavsdk::Gripper::GripperAction::Grab:
            return MAVSDK_GRIPPER_GRIPPER_ACTION_GRAB;
    }
    return MAVSDK_GRIPPER_GRIPPER_ACTION_RELEASE;
}




// ===== Primitive Array Destroy Functions =====
void mavsdk_gripper_float_array_destroy(float** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_gripper_double_array_destroy(double** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_gripper_int32t_array_destroy(int32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_gripper_uint32t_array_destroy(uint32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_gripper_int64t_array_destroy(int64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_gripper_uint64t_array_destroy(uint64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_gripper_bool_array_destroy(bool** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}


void mavsdk_gripper_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_gripper_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== Gripper Wrapper =====

struct mavsdk_gripper_wrapper {
    std::shared_ptr<mavsdk::Gripper> cpp_plugin;
    std::mutex handles_mutex;
};

mavsdk_gripper_t
mavsdk_gripper_create(mavsdk_system_t system) {
    if (system == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_gripper_wrapper();
    auto system_ptr = reinterpret_cast<std::shared_ptr<mavsdk::System>*>(system);
    wrapper->cpp_plugin = std::make_shared<mavsdk::Gripper>(*system_ptr);

    return reinterpret_cast<mavsdk_gripper_t>(wrapper);
}

void mavsdk_gripper_destroy(mavsdk_gripper_t gripper) {
    if (gripper == nullptr) {
        return;
    }

    auto wrapper = reinterpret_cast<mavsdk_gripper_wrapper*>(gripper);

    // Unsubscribe all active streams before destroying to prevent
    // callbacks firing into a destroyed object
    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
    }

    delete wrapper;
}

// ===== Method Implementations =====

// Grab async
void mavsdk_gripper_grab_async(
    mavsdk_gripper_t gripper,
    uint32_t instance,
    mavsdk_gripper_grab_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_gripper_wrapper*>(gripper);

    wrapper->cpp_plugin->grab_async(
        instance,
        [callback, user_data](
            mavsdk::Gripper::Result result) {
                if (callback) {
                    callback(
                        translate_result(result),
                        user_data);
                }
        });
}


// Grab sync
mavsdk_gripper_result_t
mavsdk_gripper_grab(
    mavsdk_gripper_t gripper,
    uint32_t instance)
{
    auto wrapper = reinterpret_cast<mavsdk_gripper_wrapper*>(gripper);

    auto ret_value = wrapper->cpp_plugin->grab(        instance);

    return translate_result(ret_value);
}

// Release async
void mavsdk_gripper_release_async(
    mavsdk_gripper_t gripper,
    uint32_t instance,
    mavsdk_gripper_release_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_gripper_wrapper*>(gripper);

    wrapper->cpp_plugin->release_async(
        instance,
        [callback, user_data](
            mavsdk::Gripper::Result result) {
                if (callback) {
                    callback(
                        translate_result(result),
                        user_data);
                }
        });
}


// Release sync
mavsdk_gripper_result_t
mavsdk_gripper_release(
    mavsdk_gripper_t gripper,
    uint32_t instance)
{
    auto wrapper = reinterpret_cast<mavsdk_gripper_wrapper*>(gripper);

    auto ret_value = wrapper->cpp_plugin->release(        instance);

    return translate_result(ret_value);
}
