// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/log_files/log_files.proto)

#include "log_files.h"

#include <mavsdk/plugins/log_files/log_files.h>
#include <cstring>
#include <vector>

// ===== C++ to C Type Conversions =====

static mavsdk_log_files_result_t
translate_result(mavsdk::LogFiles::Result cpp_result) {
    switch(cpp_result) {
        case mavsdk::LogFiles::Result::Unknown:
            return MAVSDK_LOG_FILES_RESULT_UNKNOWN;
        case mavsdk::LogFiles::Result::Success:
            return MAVSDK_LOG_FILES_RESULT_SUCCESS;
        case mavsdk::LogFiles::Result::Next:
            return MAVSDK_LOG_FILES_RESULT_NEXT;
        case mavsdk::LogFiles::Result::NoLogfiles:
            return MAVSDK_LOG_FILES_RESULT_NO_LOGFILES;
        case mavsdk::LogFiles::Result::Timeout:
            return MAVSDK_LOG_FILES_RESULT_TIMEOUT;
        case mavsdk::LogFiles::Result::InvalidArgument:
            return MAVSDK_LOG_FILES_RESULT_INVALID_ARGUMENT;
        case mavsdk::LogFiles::Result::FileOpenFailed:
            return MAVSDK_LOG_FILES_RESULT_FILE_OPEN_FAILED;
        case mavsdk::LogFiles::Result::NoSystem:
            return MAVSDK_LOG_FILES_RESULT_NO_SYSTEM;
    }
}



static mavsdk::LogFiles::ProgressData
translate_progress_data_from_c(const mavsdk_log_files_progress_data_t& c_struct) {
    mavsdk::LogFiles::ProgressData cpp_struct{};
    cpp_struct.progress = c_struct.progress;
    return cpp_struct;
}

static mavsdk_log_files_progress_data_t
translate_progress_data_to_c(const mavsdk::LogFiles::ProgressData& cpp_struct) {
    mavsdk_log_files_progress_data_t c_struct{};
    c_struct.progress = cpp_struct.progress;
    return c_struct;
}

void mavsdk_log_files_progress_data_destroy(
    mavsdk_log_files_progress_data_t* target) {
    if (!target) return;
}

void mavsdk_log_files_progress_data_array_destroy(
    mavsdk_log_files_progress_data_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_log_files_progress_data_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}


static mavsdk::LogFiles::Entry
translate_entry_from_c(const mavsdk_log_files_entry_t& c_struct) {
    mavsdk::LogFiles::Entry cpp_struct{};
    cpp_struct.id = c_struct.id;
    if (c_struct.date) {
        cpp_struct.date = c_struct.date;
    }
    cpp_struct.size_bytes = c_struct.size_bytes;
    return cpp_struct;
}

static mavsdk_log_files_entry_t
translate_entry_to_c(const mavsdk::LogFiles::Entry& cpp_struct) {
    mavsdk_log_files_entry_t c_struct{};
    c_struct.id = cpp_struct.id;
    c_struct.date = strdup(cpp_struct.date.c_str());
    c_struct.size_bytes = cpp_struct.size_bytes;
    return c_struct;
}

void mavsdk_log_files_entry_destroy(
    mavsdk_log_files_entry_t* target) {
    if (!target) return;
    if (target->date) {
        free((void*)target->date);
        target->date = nullptr;
    }
}

void mavsdk_log_files_entry_array_destroy(
    mavsdk_log_files_entry_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_log_files_entry_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}



// ===== Primitive Array Destroy Functions =====
void mavsdk_log_files_float_array_destroy(float** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_log_files_double_array_destroy(double** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_log_files_int32t_array_destroy(int32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_log_files_uint32t_array_destroy(uint32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_log_files_int64t_array_destroy(int64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_log_files_uint64t_array_destroy(uint64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_log_files_bool_array_destroy(bool** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}


void mavsdk_log_files_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_log_files_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== LogFiles Wrapper =====

struct mavsdk_log_files_wrapper {
    std::shared_ptr<mavsdk::LogFiles> cpp_plugin;
};

mavsdk_log_files_t
mavsdk_log_files_create(mavsdk_system_t system) {
    if (system == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_log_files_wrapper();
    auto system_ptr = reinterpret_cast<std::shared_ptr<mavsdk::System>*>(system);
    wrapper->cpp_plugin = std::make_shared<mavsdk::LogFiles>(*system_ptr);

    return reinterpret_cast<mavsdk_log_files_t>(wrapper);
}

void mavsdk_log_files_destroy(mavsdk_log_files_t log_files) {
    if (log_files == nullptr) {
        return;
    }

    auto wrapper = reinterpret_cast<mavsdk_log_files_wrapper*>(log_files);
    delete wrapper;
}

// ===== Method Implementations =====

// GetEntries async
void mavsdk_log_files_get_entries_async(
    mavsdk_log_files_t log_files,
    mavsdk_log_files_get_entries_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_log_files_wrapper*>(log_files);

    wrapper->cpp_plugin->get_entries_async(
        [callback, user_data](
            mavsdk::LogFiles::Result result,
            std::vector<mavsdk::LogFiles::Entry> value) {
                if (callback) {
                    size_t count = value.size();
                    mavsdk_log_files_entry_t* entries = nullptr;

                    if (count > 0) {
                        entries = new mavsdk_log_files_entry_t[count];
                        for (size_t i = 0; i < count; i++) {
                            entries[i] = translate_entry_to_c(value[i]);
                        }
                    }

                    callback(
                        translate_result(result),
                        entries,
                        count,
                        user_data);
                }
        });
}


// GetEntries sync
mavsdk_log_files_result_t
mavsdk_log_files_get_entries(
    mavsdk_log_files_t log_files,
    mavsdk_log_files_entry_t** entries_out,
    size_t* entries_size_out)
{
    auto wrapper = reinterpret_cast<mavsdk_log_files_wrapper*>(log_files);

    auto result_pair = wrapper->cpp_plugin->get_entries(
);

    if (entries_out != nullptr) {
        size_t count = result_pair.second.size();

        *entries_out = new mavsdk_log_files_entry_t[count];

        for (size_t i = 0; i < count; i++) {
            (*entries_out)[i] = translate_entry_to_c(result_pair.second[i]);
        }

        if (entries_size_out != nullptr) {
            *entries_size_out = count;
        }
    }

    return translate_result(result_pair.first);
}

// DownloadLogFile async
void mavsdk_log_files_download_log_file_async(
    mavsdk_log_files_t log_files,
    mavsdk_log_files_entry_t entry,
    char* path,
    mavsdk_log_files_download_log_file_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_log_files_wrapper*>(log_files);

    wrapper->cpp_plugin->download_log_file_async(
        translate_entry_from_c(entry),        path,
        [callback, user_data](
            mavsdk::LogFiles::Result result,
            mavsdk::LogFiles::ProgressData value) {
                if (callback) {
                    callback(
                        translate_result(result),
                        translate_progress_data_to_c(value),
                        user_data);
                }
        });
}




// EraseAllLogFiles sync
mavsdk_log_files_result_t
mavsdk_log_files_erase_all_log_files(
    mavsdk_log_files_t log_files)
{
    auto wrapper = reinterpret_cast<mavsdk_log_files_wrapper*>(log_files);

    auto ret_value = wrapper->cpp_plugin->erase_all_log_files();

    return translate_result(ret_value);
}
