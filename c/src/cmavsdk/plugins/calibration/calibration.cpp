// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/calibration/calibration.proto)

#include "calibration.h"

#include <mavsdk/plugins/calibration/calibration.h>
#include <cstring>
#include <vector>

// ===== C++ to C Type Conversions =====

static mavsdk_calibration_result_t
translate_result(mavsdk::Calibration::Result cpp_result) {
    switch(cpp_result) {
        case mavsdk::Calibration::Result::Unknown:
            return MAVSDK_CALIBRATION_RESULT_UNKNOWN;
        case mavsdk::Calibration::Result::Success:
            return MAVSDK_CALIBRATION_RESULT_SUCCESS;
        case mavsdk::Calibration::Result::Next:
            return MAVSDK_CALIBRATION_RESULT_NEXT;
        case mavsdk::Calibration::Result::Failed:
            return MAVSDK_CALIBRATION_RESULT_FAILED;
        case mavsdk::Calibration::Result::NoSystem:
            return MAVSDK_CALIBRATION_RESULT_NO_SYSTEM;
        case mavsdk::Calibration::Result::ConnectionError:
            return MAVSDK_CALIBRATION_RESULT_CONNECTION_ERROR;
        case mavsdk::Calibration::Result::Busy:
            return MAVSDK_CALIBRATION_RESULT_BUSY;
        case mavsdk::Calibration::Result::CommandDenied:
            return MAVSDK_CALIBRATION_RESULT_COMMAND_DENIED;
        case mavsdk::Calibration::Result::Timeout:
            return MAVSDK_CALIBRATION_RESULT_TIMEOUT;
        case mavsdk::Calibration::Result::Cancelled:
            return MAVSDK_CALIBRATION_RESULT_CANCELLED;
        case mavsdk::Calibration::Result::FailedArmed:
            return MAVSDK_CALIBRATION_RESULT_FAILED_ARMED;
        case mavsdk::Calibration::Result::Unsupported:
            return MAVSDK_CALIBRATION_RESULT_UNSUPPORTED;
    }
}




static mavsdk::Calibration::ProgressData
translate_progress_data_from_c(const mavsdk_calibration_progress_data_t& c_struct) {
    mavsdk::Calibration::ProgressData cpp_struct{};
    cpp_struct.has_progress = c_struct.has_progress;
    cpp_struct.progress = c_struct.progress;
    cpp_struct.has_status_text = c_struct.has_status_text;
    if (c_struct.status_text) {
        cpp_struct.status_text = c_struct.status_text;
    }
    return cpp_struct;
}

static mavsdk_calibration_progress_data_t
translate_progress_data_to_c(const mavsdk::Calibration::ProgressData& cpp_struct) {
    mavsdk_calibration_progress_data_t c_struct{};
    c_struct.has_progress = cpp_struct.has_progress;
    c_struct.progress = cpp_struct.progress;
    c_struct.has_status_text = cpp_struct.has_status_text;
    c_struct.status_text = strdup(cpp_struct.status_text.c_str());
    return c_struct;
}

void mavsdk_calibration_progress_data_destroy(
    mavsdk_calibration_progress_data_t* target) {
    if (!target) return;
    if (target->status_text) {
        free((void*)target->status_text);
        target->status_text = nullptr;
    }
}

void mavsdk_calibration_progress_data_array_destroy(
    mavsdk_calibration_progress_data_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_calibration_progress_data_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}


// ===== Primitive Array Destroy Functions =====
void mavsdk_calibration_float_array_destroy(float** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_calibration_double_array_destroy(double** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_calibration_int32t_array_destroy(int32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_calibration_uint32t_array_destroy(uint32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_calibration_int64t_array_destroy(int64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_calibration_uint64t_array_destroy(uint64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_calibration_bool_array_destroy(bool** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}


void mavsdk_calibration_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_calibration_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== Calibration Wrapper =====

struct mavsdk_calibration_wrapper {
    std::shared_ptr<mavsdk::Calibration> cpp_plugin;
};

mavsdk_calibration_t
mavsdk_calibration_create(mavsdk_system_t system) {
    if (system == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_calibration_wrapper();
    auto system_ptr = reinterpret_cast<std::shared_ptr<mavsdk::System>*>(system);
    wrapper->cpp_plugin = std::make_shared<mavsdk::Calibration>(*system_ptr);

    return reinterpret_cast<mavsdk_calibration_t>(wrapper);
}

void mavsdk_calibration_destroy(mavsdk_calibration_t calibration) {
    if (calibration == nullptr) {
        return;
    }

    auto wrapper = reinterpret_cast<mavsdk_calibration_wrapper*>(calibration);
    delete wrapper;
}

// ===== Method Implementations =====

// CalibrateGyro async
void mavsdk_calibration_calibrate_gyro_async(
    mavsdk_calibration_t calibration,
    mavsdk_calibration_calibrate_gyro_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_calibration_wrapper*>(calibration);

    wrapper->cpp_plugin->calibrate_gyro_async(
        [callback, user_data](
            mavsdk::Calibration::Result result,
            mavsdk::Calibration::ProgressData value) {
                if (callback) {
                    callback(
                        translate_result(result),
                        translate_progress_data_to_c(value),
                        user_data);
                }
        });
}



// CalibrateAccelerometer async
void mavsdk_calibration_calibrate_accelerometer_async(
    mavsdk_calibration_t calibration,
    mavsdk_calibration_calibrate_accelerometer_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_calibration_wrapper*>(calibration);

    wrapper->cpp_plugin->calibrate_accelerometer_async(
        [callback, user_data](
            mavsdk::Calibration::Result result,
            mavsdk::Calibration::ProgressData value) {
                if (callback) {
                    callback(
                        translate_result(result),
                        translate_progress_data_to_c(value),
                        user_data);
                }
        });
}



// CalibrateMagnetometer async
void mavsdk_calibration_calibrate_magnetometer_async(
    mavsdk_calibration_t calibration,
    mavsdk_calibration_calibrate_magnetometer_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_calibration_wrapper*>(calibration);

    wrapper->cpp_plugin->calibrate_magnetometer_async(
        [callback, user_data](
            mavsdk::Calibration::Result result,
            mavsdk::Calibration::ProgressData value) {
                if (callback) {
                    callback(
                        translate_result(result),
                        translate_progress_data_to_c(value),
                        user_data);
                }
        });
}



// CalibrateLevelHorizon async
void mavsdk_calibration_calibrate_level_horizon_async(
    mavsdk_calibration_t calibration,
    mavsdk_calibration_calibrate_level_horizon_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_calibration_wrapper*>(calibration);

    wrapper->cpp_plugin->calibrate_level_horizon_async(
        [callback, user_data](
            mavsdk::Calibration::Result result,
            mavsdk::Calibration::ProgressData value) {
                if (callback) {
                    callback(
                        translate_result(result),
                        translate_progress_data_to_c(value),
                        user_data);
                }
        });
}



// CalibrateGimbalAccelerometer async
void mavsdk_calibration_calibrate_gimbal_accelerometer_async(
    mavsdk_calibration_t calibration,
    mavsdk_calibration_calibrate_gimbal_accelerometer_callback_t callback,
    void* user_data)
{
    auto wrapper = reinterpret_cast<mavsdk_calibration_wrapper*>(calibration);

    wrapper->cpp_plugin->calibrate_gimbal_accelerometer_async(
        [callback, user_data](
            mavsdk::Calibration::Result result,
            mavsdk::Calibration::ProgressData value) {
                if (callback) {
                    callback(
                        translate_result(result),
                        translate_progress_data_to_c(value),
                        user_data);
                }
        });
}




// Cancel sync
mavsdk_calibration_result_t
mavsdk_calibration_cancel(
    mavsdk_calibration_t calibration)
{
    auto wrapper = reinterpret_cast<mavsdk_calibration_wrapper*>(calibration);

    auto ret_value = wrapper->cpp_plugin->cancel();

    return translate_result(ret_value);
}
