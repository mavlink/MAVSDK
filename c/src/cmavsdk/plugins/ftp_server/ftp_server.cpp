// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/ftp_server/ftp_server.proto)

#include "ftp_server.h"

#include <mavsdk/plugins/ftp_server/ftp_server.h>
#include <algorithm>
#include <cstring>
#include <mutex>
#include <vector>

// ===== C++ to C Type Conversions =====

static mavsdk_ftp_server_result_t
translate_result(mavsdk::FtpServer::Result cpp_result) {
    switch(cpp_result) {
        case mavsdk::FtpServer::Result::Unknown:
            return MAVSDK_FTP_SERVER_RESULT_UNKNOWN;
        case mavsdk::FtpServer::Result::Success:
            return MAVSDK_FTP_SERVER_RESULT_SUCCESS;
        case mavsdk::FtpServer::Result::DoesNotExist:
            return MAVSDK_FTP_SERVER_RESULT_DOES_NOT_EXIST;
        case mavsdk::FtpServer::Result::Busy:
            return MAVSDK_FTP_SERVER_RESULT_BUSY;
    }
}




// ===== Primitive Array Destroy Functions =====
void mavsdk_ftp_server_float_array_destroy(float** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_ftp_server_double_array_destroy(double** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_ftp_server_int32t_array_destroy(int32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_ftp_server_uint32t_array_destroy(uint32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_ftp_server_int64t_array_destroy(int64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_ftp_server_uint64t_array_destroy(uint64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_ftp_server_bool_array_destroy(bool** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}


void mavsdk_ftp_server_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_ftp_server_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== FtpServer Wrapper =====

struct mavsdk_ftp_server_wrapper {
    std::shared_ptr<mavsdk::FtpServer> cpp_plugin;
    std::mutex handles_mutex;
};

mavsdk_ftp_server_t
mavsdk_ftp_server_create(mavsdk_server_component_t server_component) {
    if (server_component == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_ftp_server_wrapper();
    auto server_component_ptr = reinterpret_cast<std::shared_ptr<mavsdk::ServerComponent>*>(server_component);
    wrapper->cpp_plugin = std::make_shared<mavsdk::FtpServer>(*server_component_ptr);

    return reinterpret_cast<mavsdk_ftp_server_t>(wrapper);
}

void mavsdk_ftp_server_destroy(mavsdk_ftp_server_t ftp_server) {
    if (ftp_server == nullptr) {
        return;
    }

    auto wrapper = reinterpret_cast<mavsdk_ftp_server_wrapper*>(ftp_server);

    // Unsubscribe all active streams before destroying to prevent
    // callbacks firing into a destroyed object
    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
    }

    delete wrapper;
}

// ===== Method Implementations =====


// SetRootDir sync
mavsdk_ftp_server_result_t
mavsdk_ftp_server_set_root_dir(
    mavsdk_ftp_server_t ftp_server,
    char* path)
{
    auto wrapper = reinterpret_cast<mavsdk_ftp_server_wrapper*>(ftp_server);

    auto ret_value = wrapper->cpp_plugin->set_root_dir(        path);

    return translate_result(ret_value);
}
