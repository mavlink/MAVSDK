// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/param/param.proto)

#include "param.h"

#include <mavsdk/plugins/param/param.h>
#include <algorithm>
#include <cstring>
#include <mutex>
#include <vector>

// ===== C++ to C Type Conversions =====

static mavsdk_param_result_t
translate_result(mavsdk::Param::Result cpp_result) {
    switch(cpp_result) {
        case mavsdk::Param::Result::Unknown:
            return MAVSDK_PARAM_RESULT_UNKNOWN;
        case mavsdk::Param::Result::Success:
            return MAVSDK_PARAM_RESULT_SUCCESS;
        case mavsdk::Param::Result::Timeout:
            return MAVSDK_PARAM_RESULT_TIMEOUT;
        case mavsdk::Param::Result::ConnectionError:
            return MAVSDK_PARAM_RESULT_CONNECTION_ERROR;
        case mavsdk::Param::Result::WrongType:
            return MAVSDK_PARAM_RESULT_WRONG_TYPE;
        case mavsdk::Param::Result::ParamNameTooLong:
            return MAVSDK_PARAM_RESULT_PARAM_NAME_TOO_LONG;
        case mavsdk::Param::Result::NoSystem:
            return MAVSDK_PARAM_RESULT_NO_SYSTEM;
        case mavsdk::Param::Result::ParamValueTooLong:
            return MAVSDK_PARAM_RESULT_PARAM_VALUE_TOO_LONG;
        case mavsdk::Param::Result::Failed:
            return MAVSDK_PARAM_RESULT_FAILED;
        case mavsdk::Param::Result::DoesNotExist:
            return MAVSDK_PARAM_RESULT_DOES_NOT_EXIST;
        case mavsdk::Param::Result::ValueOutOfRange:
            return MAVSDK_PARAM_RESULT_VALUE_OUT_OF_RANGE;
        case mavsdk::Param::Result::PermissionDenied:
            return MAVSDK_PARAM_RESULT_PERMISSION_DENIED;
        case mavsdk::Param::Result::ComponentNotFound:
            return MAVSDK_PARAM_RESULT_COMPONENT_NOT_FOUND;
        case mavsdk::Param::Result::ReadOnly:
            return MAVSDK_PARAM_RESULT_READ_ONLY;
        case mavsdk::Param::Result::TypeUnsupported:
            return MAVSDK_PARAM_RESULT_TYPE_UNSUPPORTED;
        case mavsdk::Param::Result::TypeMismatch:
            return MAVSDK_PARAM_RESULT_TYPE_MISMATCH;
        case mavsdk::Param::Result::ReadFail:
            return MAVSDK_PARAM_RESULT_READ_FAIL;
    }
}

static mavsdk::Param::ProtocolVersion
translate_protocol_version_from_c(mavsdk_param_protocol_version_t c_enum) {
    switch(c_enum) {
        case MAVSDK_PARAM_PROTOCOL_VERSION_V1:
            return mavsdk::Param::ProtocolVersion::V1;
        case MAVSDK_PARAM_PROTOCOL_VERSION_EXT:
            return mavsdk::Param::ProtocolVersion::Ext;
    }
    return mavsdk::Param::ProtocolVersion::V1;
}

static mavsdk_param_protocol_version_t
translate_protocol_version_to_c(mavsdk::Param::ProtocolVersion cpp_enum) {
    switch(cpp_enum) {
        case mavsdk::Param::ProtocolVersion::V1:
            return MAVSDK_PARAM_PROTOCOL_VERSION_V1;
        case mavsdk::Param::ProtocolVersion::Ext:
            return MAVSDK_PARAM_PROTOCOL_VERSION_EXT;
    }
    return MAVSDK_PARAM_PROTOCOL_VERSION_V1;
}



static mavsdk::Param::IntParam
translate_int_param_from_c(const mavsdk_param_int_param_t& c_struct) {
    mavsdk::Param::IntParam cpp_struct{};
    if (c_struct.name) {
        cpp_struct.name = c_struct.name;
    }
    cpp_struct.value = c_struct.value;
    return cpp_struct;
}

static mavsdk_param_int_param_t
translate_int_param_to_c(const mavsdk::Param::IntParam& cpp_struct) {
    mavsdk_param_int_param_t c_struct{};
    c_struct.name = strdup(cpp_struct.name.c_str());
    c_struct.value = cpp_struct.value;
    return c_struct;
}

void mavsdk_param_int_param_destroy(
    mavsdk_param_int_param_t* target) {
    if (!target) return;
    if (target->name) {
        free((void*)target->name);
        target->name = nullptr;
    }
}

void mavsdk_param_int_param_array_destroy(
    mavsdk_param_int_param_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_param_int_param_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}


static mavsdk::Param::FloatParam
translate_float_param_from_c(const mavsdk_param_float_param_t& c_struct) {
    mavsdk::Param::FloatParam cpp_struct{};
    if (c_struct.name) {
        cpp_struct.name = c_struct.name;
    }
    cpp_struct.value = c_struct.value;
    return cpp_struct;
}

static mavsdk_param_float_param_t
translate_float_param_to_c(const mavsdk::Param::FloatParam& cpp_struct) {
    mavsdk_param_float_param_t c_struct{};
    c_struct.name = strdup(cpp_struct.name.c_str());
    c_struct.value = cpp_struct.value;
    return c_struct;
}

void mavsdk_param_float_param_destroy(
    mavsdk_param_float_param_t* target) {
    if (!target) return;
    if (target->name) {
        free((void*)target->name);
        target->name = nullptr;
    }
}

void mavsdk_param_float_param_array_destroy(
    mavsdk_param_float_param_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_param_float_param_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}


static mavsdk::Param::CustomParam
translate_custom_param_from_c(const mavsdk_param_custom_param_t& c_struct) {
    mavsdk::Param::CustomParam cpp_struct{};
    if (c_struct.name) {
        cpp_struct.name = c_struct.name;
    }
    if (c_struct.value) {
        cpp_struct.value = c_struct.value;
    }
    return cpp_struct;
}

static mavsdk_param_custom_param_t
translate_custom_param_to_c(const mavsdk::Param::CustomParam& cpp_struct) {
    mavsdk_param_custom_param_t c_struct{};
    c_struct.name = strdup(cpp_struct.name.c_str());
    c_struct.value = strdup(cpp_struct.value.c_str());
    return c_struct;
}

void mavsdk_param_custom_param_destroy(
    mavsdk_param_custom_param_t* target) {
    if (!target) return;
    if (target->name) {
        free((void*)target->name);
        target->name = nullptr;
    }
    if (target->value) {
        free((void*)target->value);
        target->value = nullptr;
    }
}

void mavsdk_param_custom_param_array_destroy(
    mavsdk_param_custom_param_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_param_custom_param_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}


static mavsdk::Param::AllParams
translate_all_params_from_c(const mavsdk_param_all_params_t& c_struct) {
    mavsdk::Param::AllParams cpp_struct{};
    cpp_struct.int_params.reserve(c_struct.int_params_size);
    for (size_t i = 0; i < c_struct.int_params_size; i++) {
        cpp_struct.int_params.push_back(
            translate_int_param_from_c(c_struct.int_params[i]));
    }
    cpp_struct.float_params.reserve(c_struct.float_params_size);
    for (size_t i = 0; i < c_struct.float_params_size; i++) {
        cpp_struct.float_params.push_back(
            translate_float_param_from_c(c_struct.float_params[i]));
    }
    cpp_struct.custom_params.reserve(c_struct.custom_params_size);
    for (size_t i = 0; i < c_struct.custom_params_size; i++) {
        cpp_struct.custom_params.push_back(
            translate_custom_param_from_c(c_struct.custom_params[i]));
    }
    return cpp_struct;
}

static mavsdk_param_all_params_t
translate_all_params_to_c(const mavsdk::Param::AllParams& cpp_struct) {
    mavsdk_param_all_params_t c_struct{};
    c_struct.int_params_size = cpp_struct.int_params.size();
    c_struct.int_params = new mavsdk_param_int_param_t[c_struct.int_params_size];
    for (size_t i = 0; i < c_struct.int_params_size; i++) {
        c_struct.int_params[i] = translate_int_param_to_c(cpp_struct.int_params[i]);
    }
    c_struct.float_params_size = cpp_struct.float_params.size();
    c_struct.float_params = new mavsdk_param_float_param_t[c_struct.float_params_size];
    for (size_t i = 0; i < c_struct.float_params_size; i++) {
        c_struct.float_params[i] = translate_float_param_to_c(cpp_struct.float_params[i]);
    }
    c_struct.custom_params_size = cpp_struct.custom_params.size();
    c_struct.custom_params = new mavsdk_param_custom_param_t[c_struct.custom_params_size];
    for (size_t i = 0; i < c_struct.custom_params_size; i++) {
        c_struct.custom_params[i] = translate_custom_param_to_c(cpp_struct.custom_params[i]);
    }
    return c_struct;
}

void mavsdk_param_all_params_destroy(
    mavsdk_param_all_params_t* target) {
    if (!target) return;
    if (target->int_params) {
        for (size_t i = 0; i < target->int_params_size; i++) {
            mavsdk_param_int_param_destroy(&target->int_params[i]);
        }
        delete[] target->int_params;
        target->int_params = nullptr;
        target->int_params_size = 0;
    }
    if (target->float_params) {
        for (size_t i = 0; i < target->float_params_size; i++) {
            mavsdk_param_float_param_destroy(&target->float_params[i]);
        }
        delete[] target->float_params;
        target->float_params = nullptr;
        target->float_params_size = 0;
    }
    if (target->custom_params) {
        for (size_t i = 0; i < target->custom_params_size; i++) {
            mavsdk_param_custom_param_destroy(&target->custom_params[i]);
        }
        delete[] target->custom_params;
        target->custom_params = nullptr;
        target->custom_params_size = 0;
    }
}

void mavsdk_param_all_params_array_destroy(
    mavsdk_param_all_params_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_param_all_params_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}



// ===== Primitive Array Destroy Functions =====
void mavsdk_param_float_array_destroy(float** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_double_array_destroy(double** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_int32t_array_destroy(int32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_uint32t_array_destroy(uint32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_int64t_array_destroy(int64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_uint64t_array_destroy(uint64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_param_bool_array_destroy(bool** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}


void mavsdk_param_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_param_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== Param Wrapper =====

struct mavsdk_param_wrapper {
    std::shared_ptr<mavsdk::Param> cpp_plugin;
    std::mutex handles_mutex;
};

mavsdk_param_t
mavsdk_param_create(mavsdk_system_t system) {
    if (system == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_param_wrapper();
    auto system_ptr = reinterpret_cast<std::shared_ptr<mavsdk::System>*>(system);
    wrapper->cpp_plugin = std::make_shared<mavsdk::Param>(*system_ptr);

    return reinterpret_cast<mavsdk_param_t>(wrapper);
}

void mavsdk_param_destroy(mavsdk_param_t param) {
    if (param == nullptr) {
        return;
    }

    auto wrapper = reinterpret_cast<mavsdk_param_wrapper*>(param);

    // Unsubscribe all active streams before destroying to prevent
    // callbacks firing into a destroyed object
    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
    }

    delete wrapper;
}

// ===== Method Implementations =====


// GetParamInt sync
mavsdk_param_result_t
mavsdk_param_get_param_int(
    mavsdk_param_t param,
    char* name,
    int32_t* value_out)
{
    auto wrapper = reinterpret_cast<mavsdk_param_wrapper*>(param);

    auto result_pair = wrapper->cpp_plugin->get_param_int(
        name);

    *value_out = result_pair.second;

    return translate_result(result_pair.first);
}


// SetParamInt sync
mavsdk_param_result_t
mavsdk_param_set_param_int(
    mavsdk_param_t param,
    char* name,
    int32_t value)
{
    auto wrapper = reinterpret_cast<mavsdk_param_wrapper*>(param);

    auto ret_value = wrapper->cpp_plugin->set_param_int(        name,        value);

    return translate_result(ret_value);
}


// GetParamFloat sync
mavsdk_param_result_t
mavsdk_param_get_param_float(
    mavsdk_param_t param,
    char* name,
    float* value_out)
{
    auto wrapper = reinterpret_cast<mavsdk_param_wrapper*>(param);

    auto result_pair = wrapper->cpp_plugin->get_param_float(
        name);

    *value_out = result_pair.second;

    return translate_result(result_pair.first);
}


// SetParamFloat sync
mavsdk_param_result_t
mavsdk_param_set_param_float(
    mavsdk_param_t param,
    char* name,
    float value)
{
    auto wrapper = reinterpret_cast<mavsdk_param_wrapper*>(param);

    auto ret_value = wrapper->cpp_plugin->set_param_float(        name,        value);

    return translate_result(ret_value);
}


// GetParamCustom sync
mavsdk_param_result_t
mavsdk_param_get_param_custom(
    mavsdk_param_t param,
    char* name,
    char** value_out)
{
    auto wrapper = reinterpret_cast<mavsdk_param_wrapper*>(param);

    auto result_pair = wrapper->cpp_plugin->get_param_custom(
        name);

    if (value_out != nullptr) {
        *value_out = strdup(result_pair.second.c_str());
    }

    return translate_result(result_pair.first);
}


// SetParamCustom sync
mavsdk_param_result_t
mavsdk_param_set_param_custom(
    mavsdk_param_t param,
    char* name,
    char* value)
{
    auto wrapper = reinterpret_cast<mavsdk_param_wrapper*>(param);

    auto ret_value = wrapper->cpp_plugin->set_param_custom(        name,        value);

    return translate_result(ret_value);
}


// GetAllParams sync
void
mavsdk_param_get_all_params(
    mavsdk_param_t param,
    mavsdk_param_all_params_t* params_out)
{
    auto wrapper = reinterpret_cast<mavsdk_param_wrapper*>(param);

    auto ret_value = wrapper->cpp_plugin->get_all_params();

    if (params_out != nullptr) {
        *params_out = translate_all_params_to_c(ret_value);
    }
}


// SelectComponent sync
mavsdk_param_result_t
mavsdk_param_select_component(
    mavsdk_param_t param,
    int32_t component_id,
    mavsdk_param_protocol_version_t protocol_version)
{
    auto wrapper = reinterpret_cast<mavsdk_param_wrapper*>(param);

    auto ret_value = wrapper->cpp_plugin->select_component(        component_id,        translate_protocol_version_from_c(protocol_version));

    return translate_result(ret_value);
}
