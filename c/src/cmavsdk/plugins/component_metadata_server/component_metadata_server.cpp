// WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
// Edits need to be made to the proto files
// (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/component_metadata_server/component_metadata_server.proto)

#include "component_metadata_server.h"

#include <mavsdk/plugins/component_metadata_server/component_metadata_server.h>
#include <algorithm>
#include <cstring>
#include <mutex>
#include <vector>

// ===== C++ to C Type Conversions =====


static mavsdk::ComponentMetadataServer::MetadataType
translate_metadata_type_from_c(mavsdk_component_metadata_server_metadata_type_t c_enum) {
    switch(c_enum) {
        case MAVSDK_COMPONENT_METADATA_SERVER_METADATA_TYPE_PARAMETER:
            return mavsdk::ComponentMetadataServer::MetadataType::Parameter;
        case MAVSDK_COMPONENT_METADATA_SERVER_METADATA_TYPE_EVENTS:
            return mavsdk::ComponentMetadataServer::MetadataType::Events;
        case MAVSDK_COMPONENT_METADATA_SERVER_METADATA_TYPE_ACTUATORS:
            return mavsdk::ComponentMetadataServer::MetadataType::Actuators;
    }
    return mavsdk::ComponentMetadataServer::MetadataType::Parameter;
}

static mavsdk_component_metadata_server_metadata_type_t
translate_metadata_type_to_c(mavsdk::ComponentMetadataServer::MetadataType cpp_enum) {
    switch(cpp_enum) {
        case mavsdk::ComponentMetadataServer::MetadataType::Parameter:
            return MAVSDK_COMPONENT_METADATA_SERVER_METADATA_TYPE_PARAMETER;
        case mavsdk::ComponentMetadataServer::MetadataType::Events:
            return MAVSDK_COMPONENT_METADATA_SERVER_METADATA_TYPE_EVENTS;
        case mavsdk::ComponentMetadataServer::MetadataType::Actuators:
            return MAVSDK_COMPONENT_METADATA_SERVER_METADATA_TYPE_ACTUATORS;
    }
    return MAVSDK_COMPONENT_METADATA_SERVER_METADATA_TYPE_PARAMETER;
}



static mavsdk::ComponentMetadataServer::Metadata
translate_metadata_from_c(const mavsdk_component_metadata_server_metadata_t& c_struct) {
    mavsdk::ComponentMetadataServer::Metadata cpp_struct{};
    cpp_struct.type = translate_metadata_type_from_c(c_struct.type);
    if (c_struct.json_metadata) {
        cpp_struct.json_metadata = c_struct.json_metadata;
    }
    return cpp_struct;
}

static mavsdk_component_metadata_server_metadata_t
translate_metadata_to_c(const mavsdk::ComponentMetadataServer::Metadata& cpp_struct) {
    mavsdk_component_metadata_server_metadata_t c_struct{};
    c_struct.type = translate_metadata_type_to_c(cpp_struct.type);
    c_struct.json_metadata = strdup(cpp_struct.json_metadata.c_str());
    return c_struct;
}

void mavsdk_component_metadata_server_metadata_destroy(
    mavsdk_component_metadata_server_metadata_t* target) {
    if (!target) return;
    if (target->json_metadata) {
        free((void*)target->json_metadata);
        target->json_metadata = nullptr;
    }
}

void mavsdk_component_metadata_server_metadata_array_destroy(
    mavsdk_component_metadata_server_metadata_t** array,
    size_t size) {
    if (!array || !*array) return;

    for (size_t i = 0; i < size; i++) {
        mavsdk_component_metadata_server_metadata_destroy(&(*array)[i]);
    }

    delete[] *array;
    *array = nullptr;
}


// ===== Primitive Array Destroy Functions =====
void mavsdk_component_metadata_server_float_array_destroy(float** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_component_metadata_server_double_array_destroy(double** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_component_metadata_server_int32t_array_destroy(int32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_component_metadata_server_uint32t_array_destroy(uint32_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_component_metadata_server_int64t_array_destroy(int64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_component_metadata_server_uint64t_array_destroy(uint64_t** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}

void mavsdk_component_metadata_server_bool_array_destroy(bool** array) {
    if (!array || !*array) return;
    delete[] *array;
    *array = nullptr;
}


void mavsdk_component_metadata_server_string_destroy(char** str) {
    if (!str || !*str) return;
    free(*str);
    *str = nullptr;
}

void mavsdk_component_metadata_server_byte_buffer_destroy(uint8_t** buffer) {
    if (!buffer || !*buffer) return;
    delete[] *buffer;
    *buffer = nullptr;
}

// ===== ComponentMetadataServer Wrapper =====

struct mavsdk_component_metadata_server_wrapper {
    std::shared_ptr<mavsdk::ComponentMetadataServer> cpp_plugin;
    std::mutex handles_mutex;
};

mavsdk_component_metadata_server_t
mavsdk_component_metadata_server_create(mavsdk_server_component_t server_component) {
    if (server_component == nullptr) {
        return nullptr;
    }

    auto wrapper = new mavsdk_component_metadata_server_wrapper();
    auto server_component_ptr = reinterpret_cast<std::shared_ptr<mavsdk::ServerComponent>*>(server_component);
    wrapper->cpp_plugin = std::make_shared<mavsdk::ComponentMetadataServer>(*server_component_ptr);

    return reinterpret_cast<mavsdk_component_metadata_server_t>(wrapper);
}

void mavsdk_component_metadata_server_destroy(mavsdk_component_metadata_server_t component_metadata_server) {
    if (component_metadata_server == nullptr) {
        return;
    }

    auto wrapper = reinterpret_cast<mavsdk_component_metadata_server_wrapper*>(component_metadata_server);

    // Unsubscribe all active streams before destroying to prevent
    // callbacks firing into a destroyed object
    {
        std::lock_guard<std::mutex> lock(wrapper->handles_mutex);
    }

    delete wrapper;
}

// ===== Method Implementations =====


// SetMetadata sync
void
mavsdk_component_metadata_server_set_metadata(
    mavsdk_component_metadata_server_t component_metadata_server,
    const mavsdk_component_metadata_server_metadata_t* metadata,
    size_t metadata_size)
{
    auto wrapper = reinterpret_cast<mavsdk_component_metadata_server_wrapper*>(component_metadata_server);

wrapper->cpp_plugin->set_metadata(        [&metadata, metadata_size]() {
            std::vector<mavsdk::ComponentMetadataServer::Metadata> vec;
            vec.reserve(metadata_size);
            for (size_t i = 0; i < metadata_size; i++) {
                vec.push_back(translate_metadata_from_c(metadata[i]));
            }
            return vec;
        }());

}
