# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/{{ plugin_name.lower_snake_case }}/{{ plugin_name.lower_snake_case }}.proto)

"""
{{ class_description }}
"""

import asyncio
from typing import AsyncGenerator

from pymavsdk.plugins.{{ plugin_name.lower_snake_case }} import (
    {{ plugin_name.upper_camel_case }},
    {% for enum in enums %}
    {{ enum.name.upper_camel_case }},
    {% endfor %}
    {% for struct in structs %}
    {% if not struct.name.upper_camel_case.endswith('Result') %}
    {{ struct.name.upper_camel_case }},
    {% endif %}
    {% endfor %}
)


class {{ plugin_name.upper_camel_case }}Error(Exception):
    """Raised when a {{ plugin_name.upper_camel_case }} operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class {{ plugin_name.upper_camel_case }}Async:
    """
    {{ class_description }}

    Async wrapper around :class:`{{ plugin_name.upper_camel_case }}` that mirrors the gRPC-based
    asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, {% if is_server %}server_component{% else %}system{% endif %}):
        self._plugin = {{ plugin_name.upper_camel_case }}({% if is_server %}server_component._server_component{% else %}system._system{% endif %})

    {% for method in methods %}
    {% if method.is_async and method.is_stream and not method.is_finite %}
    async def subscribe_{{ method.name.lower_snake_case }}(self) -> AsyncGenerator[{% if not method.return_type %}bool{% elif method.return_type.is_primitive %}{{ method.return_type.name }}{% else %}{{ method.return_type.inner_name.upper_camel_case }}{% endif %}, None]:
        """
        {{ method.method_description }}

        Yields
        ------
        {% if method.return_type %}
        {% if method.return_type.is_primitive %}
        {{ method.return_type.name.lower_snake_case }} : {{ method.return_type.name }}
        {% else %}
        {{ method.return_type.inner_name.lower_snake_case }} : {{ method.return_type.inner_name.upper_camel_case }}
        {% endif %}
             The next update
        {% endif %}
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_{{ method.name.lower_snake_case }}(callback)
        try:
            while True:
                yield await queue.get()
        finally:
            self._plugin.unsubscribe_{{ method.name.lower_snake_case }}(handle)

    {% endif %}
    {% if method.is_sync %}
    async def {{ method.name.lower_snake_case }}(self{% for param in method.params %}, {{ param.name.lower_snake_case }}{% endfor %}):
        """
        {{ method.method_description }}

        {% if method.params %}
        Parameters
        ----------
        {% for param in method.params %}
        {{ param.name.lower_snake_case }} : {{ param.type_info.name }}
        {% endfor %}
        {% endif %}
        {% if method.return_name %}
        Returns
        -------
        {{ method.return_name }} : {{ method.return_type.inner_name.upper_camel_case }}
        {% endif %}
        Raises
        ------
        {{ plugin_name.upper_camel_case }}Error
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._plugin.{{ method.name.lower_snake_case }}({% for param in method.params %}{{ param.name.lower_snake_case }}{% if not loop.last %}, {% endif %}{% endfor %})
        )

    {% endif %}
    {% endfor %}
