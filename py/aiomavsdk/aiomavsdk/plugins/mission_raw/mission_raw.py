# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/mission_raw/mission_raw.proto)
"""
Enable raw missions as exposed by MAVLink.
"""

import asyncio
from typing import AsyncGenerator
from mavsdk.plugins.mission_raw import (
    MissionRaw,
    MissionRawResult,
    MissionProgress,
    MissionItem,
    MissionImportData,
)


class MissionRawError(Exception):
    """Raised when a MissionRaw operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class MissionRawAsync:
    """
    Enable raw missions as exposed by MAVLink.

    Async wrapper around :class:`MissionRaw` that mirrors the gRPC-based
    asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, system):
        self._subscription_handles: dict = {}
        self._plugin = MissionRaw(system._system)

    async def upload_mission(self, mission_items):
        """
               Upload a list of raw mission items to the system.

        The raw mission items are uploaded to a drone. Once uploaded the mission
        can be started and executed even if the connection is lost.

               Parameters
               ----------
               mission_items :
               Raises
               ------
               MissionRawError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.upload_mission(mission_items)
        )

    async def upload_geofence(self, mission_items):
        """
        Upload a list of geofence items to the system.

        Parameters
        ----------
        mission_items :
        Raises
        ------
        MissionRawError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.upload_geofence(mission_items)
        )

    async def upload_rally_points(self, mission_items):
        """
        Upload a list of rally point items to the system.

        Parameters
        ----------
        mission_items :
        Raises
        ------
        MissionRawError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.upload_rally_points(mission_items)
        )

    async def cancel_mission_upload(self):
        """
        Cancel an ongoing mission upload.

        Raises
        ------
        MissionRawError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.cancel_mission_upload()
        )

    async def download_mission(self):
        """
        Download a list of raw mission items from the system (asynchronous).

        Returns
        -------
        mission_items : MissionItem
        Raises
        ------
        MissionRawError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.download_mission())

    async def download_geofence(self):
        """
        Download a list of raw geofence items from the system (asynchronous).

        Returns
        -------
        geofence_items : MissionItem
        Raises
        ------
        MissionRawError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.download_geofence()
        )

    async def download_rallypoints(self):
        """
        Download a list of raw rallypoint items from the system (asynchronous).

        Returns
        -------
        rallypoint_items : MissionItem
        Raises
        ------
        MissionRawError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.download_rallypoints()
        )

    async def cancel_mission_download(self):
        """
        Cancel an ongoing mission download.

        Raises
        ------
        MissionRawError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.cancel_mission_download()
        )

    async def start_mission(self):
        """
               Start the mission.

        A mission must be uploaded to the vehicle before this can be called.

               Raises
               ------
               MissionRawError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.start_mission())

    async def pause_mission(self):
        """
               Pause the mission.

        Pausing the mission puts the vehicle into
        [HOLD mode](https://docs.px4.io/en/flight_modes/hold.html).
        A multicopter should just hover at the spot while a fixedwing vehicle should loiter
        around the location where it paused.

               Raises
               ------
               MissionRawError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.pause_mission())

    async def clear_mission(self):
        """
        Clear the mission saved on the vehicle.

        Raises
        ------
        MissionRawError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.clear_mission())

    async def set_current_mission_item(self, index):
        """
               Sets the raw mission item index to go to.

        By setting the current index to 0, the mission is restarted from the beginning. If it is set
        to a specific index of a raw mission item, the mission will be set to this item.

               Parameters
               ----------
               index : int
               Raises
               ------
               MissionRawError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_current_mission_item(index)
        )

    async def subscribe_mission_progress(self) -> AsyncGenerator[MissionProgress, None]:
        """
        Subscribe to mission progress updates.

        Yields
        ------
        mission_progress : MissionProgress
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_mission_progress(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_mission_progress(handle)

    async def mission_progress(self):
        """
        Subscribe to mission progress updates.

        Returns
        -------
        mission_progress : MissionProgress
        Raises
        ------
        MissionRawError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.mission_progress())

    async def subscribe_mission_changed(self) -> AsyncGenerator[bool, None]:
        """
               Subscribes to mission changed.

        This notification can be used to be informed if a ground station has
        been uploaded or changed by a ground station or companion computer.

        @param callback Callback to notify about change.

               Yields
               ------
                : bool
                    The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_mission_changed(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_mission_changed(handle)

    async def import_qgroundcontrol_mission(self, qgc_plan_path):
        """
               Import a QGroundControl missions in JSON .plan format, from a file.

        Supported:
        - Waypoints
        - Survey
        Not supported:
        - Structure Scan

               Parameters
               ----------
               qgc_plan_path : str
               Returns
               -------
               mission_import_data : MissionImportData
               Raises
               ------
               MissionRawError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.import_qgroundcontrol_mission(qgc_plan_path)
        )

    async def import_qgroundcontrol_mission_from_string(self, qgc_plan):
        """
               Import a QGroundControl missions in JSON .plan format, from a string.

        Supported:
        - Waypoints
        - Survey
        Not supported:
        - Structure Scan

               Parameters
               ----------
               qgc_plan : str
               Returns
               -------
               mission_import_data : MissionImportData
               Raises
               ------
               MissionRawError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._plugin.import_qgroundcontrol_mission_from_string(qgc_plan),
        )

    async def import_mission_planner_mission(self, mission_planner_path):
        """
               Import a Mission Planner mission in QGC WPL 110 format, from a file.

        Supported:
        - Waypoints
        - ArduPilot home position handling

               Parameters
               ----------
               mission_planner_path : str
               Returns
               -------
               mission_import_data : MissionImportData
               Raises
               ------
               MissionRawError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._plugin.import_mission_planner_mission(mission_planner_path),
        )

    async def import_mission_planner_mission_from_string(self, mission_planner_mission):
        """
               Import a Mission Planner mission in QGC WPL 110 format, from a string.

        Supported:
        - Waypoints
        - ArduPilot home position handling

               Parameters
               ----------
               mission_planner_mission : str
               Returns
               -------
               mission_import_data : MissionImportData
               Raises
               ------
               MissionRawError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._plugin.import_mission_planner_mission_from_string(
                mission_planner_mission
            ),
        )

    async def is_mission_finished(self):
        """
               Check if the mission is finished.

        Returns true if the mission is finished, false otherwise.

               Returns
               -------
               is_finished : bool
               Raises
               ------
               MissionRawError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.is_mission_finished()
        )

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
