# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/manual_control/manual_control.proto)
"""
Enable manual control using e.g. a joystick or gamepad.
"""

import asyncio
from typing import AsyncGenerator
from pymavsdk.plugins.manual_control import (
    ManualControl,
    ManualControlResult,
)


class ManualControlError(Exception):
    """Raised when a ManualControl operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class ManualControlAsync:
    """
    Enable manual control using e.g. a joystick or gamepad.

    Async wrapper around :class:`ManualControl` that mirrors the gRPC-based
    asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, system):
        self._subscription_handles: dict = {}
        self._plugin = ManualControl(system._system)

    async def start_position_control(self):
        """
               Start position control using e.g. joystick input.

        Requires manual control input to be sent regularly already.
        Requires a valid position using e.g. GPS, external vision, or optical flow.

               Raises
               ------
               ManualControlError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.start_position_control()
        )

    async def start_altitude_control(self):
        """
               Start altitude control

        Requires manual control input to be sent regularly already.
        Does not require a  valid position e.g. GPS.

               Raises
               ------
               ManualControlError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.start_altitude_control()
        )

    async def set_manual_control_input(self, x, y, z, r):
        """
               Set manual control input

        The manual control input needs to be sent at a rate high enough to prevent
        triggering of RC loss, a good minimum rate is 10 Hz.

               Parameters
               ----------
               x : float
               y : float
               z : float
               r : float
               Raises
               ------
               ManualControlError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_manual_control_input(x, y, z, r)
        )

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
