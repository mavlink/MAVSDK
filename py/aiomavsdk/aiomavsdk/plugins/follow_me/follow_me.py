# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/follow_me/follow_me.proto)
"""
Allow users to command the vehicle to follow a specific target.
 The target is provided as a GPS coordinate and altitude.
"""

import asyncio
from typing import AsyncGenerator
from pymavsdk.plugins.follow_me import (
    FollowMe,
    FollowMeResult,
    Config,
    TargetLocation,
)


class FollowMeError(Exception):
    """Raised when a FollowMe operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class FollowMeAsync:
    """
       Allow users to command the vehicle to follow a specific target.
    The target is provided as a GPS coordinate and altitude.

       Async wrapper around :class:`FollowMe` that mirrors the gRPC-based
       asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, system):
        self._subscription_handles: dict = {}
        self._plugin = FollowMe(system._system)

    async def get_config(self):
        """
        Get current configuration.

        Returns
        -------
        <protoc_gen_mavsdk.name_parser.NameParser object at 0x10a47c350> : Config
        Raises
        ------
        FollowMeError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.get_config())

    async def set_config(self, config):
        """
        Apply configuration by sending it to the system.

        Parameters
        ----------
        config : <protoc_gen_mavsdk.name_parser.NameParser object at 0x10a47ce90>
        Raises
        ------
        FollowMeError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.set_config(config))

    async def is_active(self):
        """
        Check if FollowMe is active.

        Returns
        -------
        <protoc_gen_mavsdk.name_parser.NameParser object at 0x10a47c770> :
        Raises
        ------
        FollowMeError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.is_active())

    async def set_target_location(self, location):
        """
        Set location of the moving target.

        Parameters
        ----------
        location : <protoc_gen_mavsdk.name_parser.NameParser object at 0x10a47d8b0>
        Raises
        ------
        FollowMeError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_target_location(location)
        )

    async def get_last_location(self):
        """
        Get the last location of the target.

        Returns
        -------
        <protoc_gen_mavsdk.name_parser.NameParser object at 0x10a47cb30> : TargetLocation
        Raises
        ------
        FollowMeError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.get_last_location()
        )

    async def start(self):
        """
        Start FollowMe mode.

        Raises
        ------
        FollowMeError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.start())

    async def stop(self):
        """
        Stop FollowMe mode.

        Raises
        ------
        FollowMeError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.stop())

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
