# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/component_metadata/component_metadata.proto)
"""
Access component metadata json definitions, such as parameters.
"""

import asyncio
from typing import AsyncGenerator
from pymavsdk.plugins.component_metadata import (
    ComponentMetadata,
    ComponentMetadataResult,
    MetadataType,
    MetadataData,
    MetadataUpdate,
)


class ComponentMetadataError(Exception):
    """Raised when a ComponentMetadata operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class ComponentMetadataAsync:
    """
    Access component metadata json definitions, such as parameters.

    Async wrapper around :class:`ComponentMetadata` that mirrors the gRPC-based
    asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, system):
        self._subscription_handles: dict = {}
        self._plugin = ComponentMetadata(system._system)

    async def request_component(self, compid):
        """
               Request metadata from a specific component. This is used to start requesting metadata from a component.
        The metadata can later be accessed via subscription (see below) or GetMetadata.

               Parameters
               ----------
               compid : uint32_t
               Raises
               ------
               ComponentMetadataError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.request_component(compid)
        )

    async def request_autopilot_component(self):
        """
               Request metadata from the autopilot component. This is used to start requesting metadata from the autopilot.
        The metadata can later be accessed via subscription (see below) or GetMetadata.

               Raises
               ------
               ComponentMetadataError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.request_autopilot_component()
        )

    async def subscribe_metadata_available(
        self,
    ) -> AsyncGenerator[MetadataUpdate, None]:
        """
        Register a callback that gets called when metadata is available

        Yields
        ------
        metadata_update : MetadataUpdate
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_metadata_available(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_metadata_available(handle)

    async def get_metadata(self, compid, metadata_type):
        """
               Access metadata. This can be used if you know the metadata is available already, otherwise use
        the subscription to get notified when it becomes available.

               Parameters
               ----------
               compid : uint32_t
               metadata_type : <protoc_gen_mavsdk.name_parser.NameParser object at 0x1081e4530>
               Returns
               -------
               <protoc_gen_mavsdk.name_parser.NameParser object at 0x1081e4590> : MetadataData
               Raises
               ------
               ComponentMetadataError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.get_metadata(compid, metadata_type)
        )

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
