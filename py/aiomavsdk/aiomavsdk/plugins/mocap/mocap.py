# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/mocap/mocap.proto)
"""
Allows interfacing a vehicle with a motion capture system in
 order to allow navigation without global positioning sources available
 (e.g. indoors, or when flying under a bridge. etc.).
"""

import asyncio
from typing import AsyncGenerator
from mavsdk.plugins.mocap import (
    Mocap,
    MocapResult,
    PositionBody,
    AngleBody,
    SpeedBody,
    SpeedNed,
    AngularVelocityBody,
    Covariance,
    Quaternion,
    VisionPositionEstimate,
    VisionSpeedEstimate,
    AttitudePositionMocap,
    Odometry,
)


class MocapError(Exception):
    """Raised when a Mocap operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class MocapAsync:
    """
       Allows interfacing a vehicle with a motion capture system in
    order to allow navigation without global positioning sources available
    (e.g. indoors, or when flying under a bridge. etc.).

       Async wrapper around :class:`Mocap` that mirrors the gRPC-based
       asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, system):
        self._subscription_handles: dict = {}
        self._plugin = Mocap(system._system)

    async def set_vision_position_estimate(self, vision_position_estimate):
        """
        Send Global position/attitude estimate from a vision source.

        Parameters
        ----------
        vision_position_estimate : <protoc_gen_mavsdk.name_parser.NameParser object at 0x10a71a750>
        Raises
        ------
        MocapError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._plugin.set_vision_position_estimate(vision_position_estimate),
        )

    async def set_vision_speed_estimate(self, vision_speed_estimate):
        """
        Send Global speed estimate from a vision source.

        Parameters
        ----------
        vision_speed_estimate : <protoc_gen_mavsdk.name_parser.NameParser object at 0x10a71a750>
        Raises
        ------
        MocapError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_vision_speed_estimate(vision_speed_estimate)
        )

    async def set_attitude_position_mocap(self, attitude_position_mocap):
        """
        Send motion capture attitude and position.

        Parameters
        ----------
        attitude_position_mocap : <protoc_gen_mavsdk.name_parser.NameParser object at 0x10a71a750>
        Raises
        ------
        MocapError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._plugin.set_attitude_position_mocap(attitude_position_mocap),
        )

    async def set_odometry(self, odometry):
        """
        Send odometry information with an external interface.

        Parameters
        ----------
        odometry : <protoc_gen_mavsdk.name_parser.NameParser object at 0x10a71a750>
        Raises
        ------
        MocapError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_odometry(odometry)
        )

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
