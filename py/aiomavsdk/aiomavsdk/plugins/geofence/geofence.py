# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/geofence/geofence.proto)
"""
Enable setting a geofence.
"""

import asyncio
from typing import AsyncGenerator
from pymavsdk.plugins.geofence import (
    Geofence,
    GeofenceResult,
    FenceType,
    Point,
    Polygon,
    Circle,
    GeofenceData,
)


class GeofenceError(Exception):
    """Raised when a Geofence operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class GeofenceAsync:
    """
    Enable setting a geofence.

    Async wrapper around :class:`Geofence` that mirrors the gRPC-based
    asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, system):
        self._subscription_handles: dict = {}
        self._plugin = Geofence(system._system)

    async def upload_geofence(self, geofence_data):
        """
               Upload geofences.

        Polygon and Circular geofences are uploaded to a drone. Once uploaded, the geofence will remain
        on the drone even if a connection is lost.

               Parameters
               ----------
               geofence_data : <protoc_gen_mavsdk.name_parser.NameParser object at 0x1061801d0>
               Raises
               ------
               GeofenceError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.upload_geofence(geofence_data)
        )

    async def clear_geofence(self):
        """
        Clear all geofences saved on the vehicle.

        Raises
        ------
        GeofenceError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.clear_geofence())

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
