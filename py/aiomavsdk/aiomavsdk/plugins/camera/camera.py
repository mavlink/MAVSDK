# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/camera/camera.proto)
"""
Can be used to manage cameras that implement the MAVLink
 Camera Protocol: https://mavlink.io/en/services/camera.html.

 Currently only a single camera is supported.
 When multiple cameras are supported the plugin will need to be
 instantiated separately for every camera and the camera selected using
 `select_camera`.
"""

import asyncio
from typing import AsyncGenerator
from mavsdk.plugins.camera import (
    Camera,
    CameraResult,
    Mode,
    PhotosRange,
    Option,
    Setting,
    SettingOptions,
    VideoStreamSettings,
    VideoStreamInfo,
    ModeUpdate,
    VideoStreamUpdate,
    Storage,
    StorageUpdate,
    CurrentSettingsUpdate,
    PossibleSettingOptionsUpdate,
    Position,
    Quaternion,
    EulerAngle,
    CaptureInfo,
    Information,
    CameraList,
)


class CameraError(Exception):
    """Raised when a Camera operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class CameraAsync:
    """
       Can be used to manage cameras that implement the MAVLink
    Camera Protocol: https://mavlink.io/en/services/camera.html.

    Currently only a single camera is supported.
    When multiple cameras are supported the plugin will need to be
    instantiated separately for every camera and the camera selected using
    `select_camera`.

       Async wrapper around :class:`Camera` that mirrors the gRPC-based
       asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, system):
        self._subscription_handles: dict = {}
        self._plugin = Camera(system._system)

    async def take_photo(self, component_id):
        """
        Take one photo.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.take_photo(component_id)
        )

    async def start_photo_interval(self, component_id, interval_s):
        """
        Start photo timelapse with a given interval.

        Parameters
        ----------
        component_id : int32_t
        interval_s : float
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.start_photo_interval(component_id, interval_s)
        )

    async def stop_photo_interval(self, component_id):
        """
        Stop a running photo timelapse.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.stop_photo_interval(component_id)
        )

    async def start_video(self, component_id):
        """
        Start a video recording.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.start_video(component_id)
        )

    async def stop_video(self, component_id):
        """
        Stop a running video recording.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.stop_video(component_id)
        )

    async def start_video_streaming(self, component_id, stream_id):
        """
        Start video streaming.

        Parameters
        ----------
        component_id : int32_t
        stream_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.start_video_streaming(component_id, stream_id)
        )

    async def stop_video_streaming(self, component_id, stream_id):
        """
        Stop current video streaming.

        Parameters
        ----------
        component_id : int32_t
        stream_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.stop_video_streaming(component_id, stream_id)
        )

    async def set_mode(self, component_id, mode):
        """
        Set camera mode.

        Parameters
        ----------
        component_id : int32_t
        mode : <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080cb470>
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_mode(component_id, mode)
        )

    async def list_photos(self, component_id, photos_range):
        """
               List photos available on the camera.

        Note that this might need to be called initially to set the PhotosRange accordingly.
        Once set to 'all' rather than 'since connection', it will try to request the previous
        images over time.

               Parameters
               ----------
               component_id : int32_t
               photos_range : <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080cb470>
               Returns
               -------
               <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080be930> : CaptureInfo
               Raises
               ------
               CameraError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.list_photos(component_id, photos_range)
        )

    async def subscribe_camera_list(self) -> AsyncGenerator[CameraList, None]:
        """
               Subscribe to list of cameras.

        This allows to find out what cameras are connected to the system.
        Based on the camera ID, we can then address a specific camera.

               Yields
               ------
               camera_list : CameraList
                    The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_camera_list(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_camera_list(handle)

    async def camera_list(self):
        """
               Subscribe to list of cameras.

        This allows to find out what cameras are connected to the system.
        Based on the camera ID, we can then address a specific camera.

               Returns
               -------
               <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080beab0> : CameraList
               Raises
               ------
               CameraError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(None, lambda: self._plugin.camera_list())

    async def subscribe_mode(self) -> AsyncGenerator[ModeUpdate, None]:
        """
        Subscribe to camera mode updates.

        Yields
        ------
        mode_update : ModeUpdate
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_mode(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_mode(handle)

    async def get_mode(self, component_id):
        """
        Get camera mode.

        Parameters
        ----------
        component_id : int32_t
        Returns
        -------
        <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080beff0> : Mode
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.get_mode(component_id)
        )

    async def subscribe_video_stream_info(
        self,
    ) -> AsyncGenerator[VideoStreamUpdate, None]:
        """
        Subscribe to video stream info updates.

        Yields
        ------
        video_stream_update : VideoStreamUpdate
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_video_stream_info(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_video_stream_info(handle)

    async def get_video_stream_info(self, component_id):
        """
        Get video stream info.

        Parameters
        ----------
        component_id : int32_t
        Returns
        -------
        <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080bf470> : VideoStreamInfo
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.get_video_stream_info(component_id)
        )

    async def subscribe_capture_info(self) -> AsyncGenerator[CaptureInfo, None]:
        """
        Subscribe to capture info updates.

        Yields
        ------
        capture_info : CaptureInfo
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_capture_info(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_capture_info(handle)

    async def subscribe_storage(self) -> AsyncGenerator[StorageUpdate, None]:
        """
        Subscribe to camera's storage status updates.

        Yields
        ------
        storage_update : StorageUpdate
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_storage(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_storage(handle)

    async def get_storage(self, component_id):
        """
        Get camera's storage status.

        Parameters
        ----------
        component_id : int32_t
        Returns
        -------
        <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080bfbf0> : Storage
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.get_storage(component_id)
        )

    async def subscribe_current_settings(
        self,
    ) -> AsyncGenerator[CurrentSettingsUpdate, None]:
        """
        Get the list of current camera settings.

        Yields
        ------
        current_settings_update : CurrentSettingsUpdate
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_current_settings(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_current_settings(handle)

    async def get_current_settings(self, component_id):
        """
        Get current settings.

        Parameters
        ----------
        component_id : int32_t
        Returns
        -------
        <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080c8110> : Setting
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.get_current_settings(component_id)
        )

    async def subscribe_possible_setting_options(
        self,
    ) -> AsyncGenerator[PossibleSettingOptionsUpdate, None]:
        """
        Get the list of settings that can be changed.

        Yields
        ------
        possible_setting_options_update : PossibleSettingOptionsUpdate
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_possible_setting_options(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_possible_setting_options(handle)

    async def get_possible_setting_options(self, component_id):
        """
        Get possible setting options.

        Parameters
        ----------
        component_id : int32_t
        Returns
        -------
        <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080c8650> : SettingOptions
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.get_possible_setting_options(component_id)
        )

    async def set_setting(self, component_id, setting):
        """
               Set a setting to some value.

        Only setting_id of setting and option_id of option needs to be set.

               Parameters
               ----------
               component_id : int32_t
               setting : <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080cb470>
               Raises
               ------
               CameraError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_setting(component_id, setting)
        )

    async def get_setting(self, component_id, setting):
        """
               Get a setting.

        Only setting_id of setting needs to be set.

               Parameters
               ----------
               component_id : int32_t
               setting : <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080cb470>
               Returns
               -------
               <protoc_gen_mavsdk.name_parser.NameParser object at 0x1080c8d70> : Setting
               Raises
               ------
               CameraError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.get_setting(component_id, setting)
        )

    async def format_storage(self, component_id, storage_id):
        """
               Format storage (e.g. SD card) in camera.

        This will delete all content of the camera storage!

               Parameters
               ----------
               component_id : int32_t
               storage_id : int32_t
               Raises
               ------
               CameraError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.format_storage(component_id, storage_id)
        )

    async def reset_settings(self, component_id):
        """
               Reset all settings in camera.

        This will reset all camera settings to default value

               Parameters
               ----------
               component_id : int32_t
               Raises
               ------
               CameraError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.reset_settings(component_id)
        )

    async def zoom_in_start(self, component_id):
        """
        Start zooming in.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.zoom_in_start(component_id)
        )

    async def zoom_out_start(self, component_id):
        """
        Start zooming out.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.zoom_out_start(component_id)
        )

    async def zoom_stop(self, component_id):
        """
        Stop zooming.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.zoom_stop(component_id)
        )

    async def zoom_range(self, component_id, range):
        """
        Zoom to value as proportion of full camera range (percentage between 0.0 and 100.0).

        Parameters
        ----------
        component_id : int32_t
        range : float
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.zoom_range(component_id, range)
        )

    async def track_point(self, component_id, point_x, point_y, radius):
        """
        Track point.

        Parameters
        ----------
        component_id : int32_t
        point_x : float
        point_y : float
        radius : float
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._plugin.track_point(component_id, point_x, point_y, radius),
        )

    async def track_rectangle(
        self, component_id, top_left_x, top_left_y, bottom_right_x, bottom_right_y
    ):
        """
        Track rectangle.

        Parameters
        ----------
        component_id : int32_t
        top_left_x : float
        top_left_y : float
        bottom_right_x : float
        bottom_right_y : float
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._plugin.track_rectangle(
                component_id, top_left_x, top_left_y, bottom_right_x, bottom_right_y
            ),
        )

    async def track_stop(self, component_id):
        """
        Stop tracking.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.track_stop(component_id)
        )

    async def focus_in_start(self, component_id):
        """
        Start focusing in.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.focus_in_start(component_id)
        )

    async def focus_out_start(self, component_id):
        """
        Start focusing out.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.focus_out_start(component_id)
        )

    async def focus_stop(self, component_id):
        """
        Stop focus.

        Parameters
        ----------
        component_id : int32_t
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.focus_stop(component_id)
        )

    async def focus_range(self, component_id, range):
        """
        Focus with range value of full range (value between 0.0 and 100.0).

        Parameters
        ----------
        component_id : int32_t
        range : float
        Raises
        ------
        CameraError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.focus_range(component_id, range)
        )

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
