# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/ftp/ftp.proto)
"""
Implements file transfer functionality using MAVLink FTP.
"""

import asyncio
from typing import AsyncGenerator
from mavsdk.plugins.ftp import (
    Ftp,
    FtpResult,
    ListDirectoryData,
    ProgressData,
)


class FtpError(Exception):
    """Raised when a Ftp operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class FtpAsync:
    """
    Implements file transfer functionality using MAVLink FTP.

    Async wrapper around :class:`Ftp` that mirrors the gRPC-based
    asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, system):
        self._subscription_handles: dict = {}
        self._plugin = Ftp(system._system)

    async def download(self, remote_file_path, local_dir, use_burst) -> AsyncGenerator:
        """
        Downloads a file to local directory.
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(result, data, _user_data=None):
            loop.call_soon_threadsafe(queue.put_nowait, (result, data))

        self._plugin.download_async(callback)
        while True:
            result, data = await queue.get()
            yield result, data
            if result != FtpResult.NEXT:
                break

    async def upload(self, local_file_path, remote_dir) -> AsyncGenerator:
        """
        Uploads local file to remote directory.
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(result, data, _user_data=None):
            loop.call_soon_threadsafe(queue.put_nowait, (result, data))

        self._plugin.upload_async(callback)
        while True:
            result, data = await queue.get()
            yield result, data
            if result != FtpResult.NEXT:
                break

    async def list_directory(self, remote_dir):
        """
        Lists items from a remote directory.

        Parameters
        ----------
        remote_dir : str
        Returns
        -------
        data : ListDirectoryData
        Raises
        ------
        FtpError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.list_directory(remote_dir)
        )

    async def create_directory(self, remote_dir):
        """
        Creates a remote directory.

        Parameters
        ----------
        remote_dir : str
        Raises
        ------
        FtpError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.create_directory(remote_dir)
        )

    async def remove_directory(self, remote_dir):
        """
        Removes a remote directory.

        Parameters
        ----------
        remote_dir : str
        Raises
        ------
        FtpError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.remove_directory(remote_dir)
        )

    async def remove_file(self, remote_file_path):
        """
        Removes a remote file.

        Parameters
        ----------
        remote_file_path : str
        Raises
        ------
        FtpError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.remove_file(remote_file_path)
        )

    async def rename(self, remote_from_path, remote_to_path):
        """
        Renames a remote file or remote directory.

        Parameters
        ----------
        remote_from_path : str
        remote_to_path : str
        Raises
        ------
        FtpError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.rename(remote_from_path, remote_to_path)
        )

    async def are_files_identical(self, local_file_path, remote_file_path):
        """
        Compares a local file to a remote file using a CRC32 checksum.

        Parameters
        ----------
        local_file_path : str
        remote_file_path : str
        Returns
        -------
        are_identical : bool
        Raises
        ------
        FtpError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._plugin.are_files_identical(local_file_path, remote_file_path),
        )

    async def set_target_compid(self, compid):
        """
        Set target component ID. By default it is the autopilot.

        Parameters
        ----------
        compid : int
        Raises
        ------
        FtpError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_target_compid(compid)
        )

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
