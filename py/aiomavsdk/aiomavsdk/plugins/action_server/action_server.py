# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/action_server/action_server.proto)
"""
Provide vehicle actions (as a server) such as arming, taking off, and landing.
"""

import asyncio
from typing import AsyncGenerator
from pymavsdk.plugins.action_server import (
    ActionServer,
    ActionServerResult,
    FlightMode,
    AllowableFlightModes,
    ArmDisarm,
)


class ActionServerError(Exception):
    """Raised when a ActionServer operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class ActionServerAsync:
    """
    Provide vehicle actions (as a server) such as arming, taking off, and landing.

    Async wrapper around :class:`ActionServer` that mirrors the gRPC-based
    asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, server_component):
        self._subscription_handles: dict = {}
        self._plugin = ActionServer(server_component)

    async def subscribe_arm_disarm(self) -> AsyncGenerator[ArmDisarm, None]:
        """
        Subscribe to ARM/DISARM commands

        Yields
        ------
        arm_disarm : ArmDisarm
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_arm_disarm(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_arm_disarm(handle)

    async def subscribe_flight_mode_change(self) -> AsyncGenerator[FlightMode, None]:
        """
        Subscribe to DO_SET_MODE

        Yields
        ------
        flight_mode : FlightMode
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_flight_mode_change(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_flight_mode_change(handle)

    async def subscribe_takeoff(self) -> AsyncGenerator[bool, None]:
        """
        Subscribe to takeoff command

        Yields
        ------
         : bool
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_takeoff(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_takeoff(handle)

    async def subscribe_land(self) -> AsyncGenerator[bool, None]:
        """
        Subscribe to land command

        Yields
        ------
         : bool
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_land(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_land(handle)

    async def subscribe_reboot(self) -> AsyncGenerator[bool, None]:
        """
        Subscribe to reboot command

        Yields
        ------
         : bool
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_reboot(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_reboot(handle)

    async def subscribe_shutdown(self) -> AsyncGenerator[bool, None]:
        """
        Subscribe to shutdown command

        Yields
        ------
         : bool
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_shutdown(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_shutdown(handle)

    async def subscribe_terminate(self) -> AsyncGenerator[bool, None]:
        """
        Subscribe to terminate command

        Yields
        ------
         : bool
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_terminate(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_terminate(handle)

    async def set_allow_takeoff(self, allow_takeoff):
        """
        Can the vehicle takeoff

        Parameters
        ----------
        allow_takeoff : bool
        Raises
        ------
        ActionServerError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_allow_takeoff(allow_takeoff)
        )

    async def set_armable(self, armable, force_armable):
        """
        Can the vehicle arm when requested

        Parameters
        ----------
        armable : bool
        force_armable : bool
        Raises
        ------
        ActionServerError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_armable(armable, force_armable)
        )

    async def set_disarmable(self, disarmable, force_disarmable):
        """
        Can the vehicle disarm when requested

        Parameters
        ----------
        disarmable : bool
        force_disarmable : bool
        Raises
        ------
        ActionServerError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_disarmable(disarmable, force_disarmable)
        )

    async def set_allowable_flight_modes(self, flight_modes):
        """
        Set which modes the vehicle can transition to (Manual always allowed)

        Parameters
        ----------
        flight_modes : <protoc_gen_mavsdk.name_parser.NameParser object at 0x106586b70>
        Raises
        ------
        ActionServerError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_allowable_flight_modes(flight_modes)
        )

    async def get_allowable_flight_modes(self):
        """
        Get which modes the vehicle can transition to (Manual always allowed)

        Returns
        -------
        <protoc_gen_mavsdk.name_parser.NameParser object at 0x106586330> : AllowableFlightModes
        Raises
        ------
        ActionServerError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.get_allowable_flight_modes()
        )

    async def set_armed_state(self, is_armed):
        """
        Set/override the armed/disarmed state of the vehicle directly, and notify subscribers

        Parameters
        ----------
        is_armed : bool
        Raises
        ------
        ActionServerError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_armed_state(is_armed)
        )

    async def set_flight_mode(self, flight_mode):
        """
        Set/override the flight mode of the vehicle directly, and notify subscribers

        Parameters
        ----------
        flight_mode : <protoc_gen_mavsdk.name_parser.NameParser object at 0x106587530>
        Raises
        ------
        ActionServerError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_flight_mode(flight_mode)
        )

    async def set_flight_mode_internal(self, flight_mode):
        """
        Set/override the flight mode of the vehicle directly, and *do not* notify subscribers

        Parameters
        ----------
        flight_mode : <protoc_gen_mavsdk.name_parser.NameParser object at 0x106587530>
        Raises
        ------
        ActionServerError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_flight_mode_internal(flight_mode)
        )

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
