# ruff: noqa: F401
# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/param_server/param_server.proto)
"""
Provide raw access to retrieve and provide server parameters.
"""

import asyncio
from typing import AsyncGenerator
from mavsdk.plugins.param_server import (
    ParamServer,
    ParamServerResult,
    IntParam,
    FloatParam,
    CustomParam,
    AllParams,
)


class ParamServerError(Exception):
    """Raised when a ParamServer operation fails."""

    def __init__(self, result, origin, *params):
        self._result = result
        self._origin = origin
        self._params = params

    def __str__(self):
        return f"{self._result}: '{self._result.name}'; origin: {self._origin}; params: {self._params}"


class ParamServerAsync:
    """
    Provide raw access to retrieve and provide server parameters.

    Async wrapper around :class:`ParamServer` that mirrors the gRPC-based
    asyncio API while using the ctypes-based C library directly.
    """

    def __init__(self, server_component):
        self._subscription_handles: dict = {}
        self._plugin = ParamServer(server_component)

    async def set_protocol(self, extended_protocol):
        """
               Set param protocol.

        The extended param protocol is used by default. This allows to use the previous/normal one.

        Note that camera definition files are meant to implement/use the extended protocol.

               Parameters
               ----------
               extended_protocol : bool
               Raises
               ------
               ParamServerError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.set_protocol(extended_protocol)
        )

    async def retrieve_param_int(self, name):
        """
               Retrieve an int parameter.

        If the type is wrong, the result will be `WRONG_TYPE`.

               Parameters
               ----------
               name : str
               Returns
               -------
               value : int
               Raises
               ------
               ParamServerError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.retrieve_param_int(name)
        )

    async def provide_param_int(self, name, value):
        """
               Provide an int parameter.

        If the type is wrong, the result will be `WRONG_TYPE`.

        Note that all params need to be provided upfront. Once a client has
        requested a param list, the indices are locked and no more params
        can be added.

               Parameters
               ----------
               name : str
               value : int
               Raises
               ------
               ParamServerError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.provide_param_int(name, value)
        )

    async def retrieve_param_float(self, name):
        """
               Retrieve a float parameter.

        If the type is wrong, the result will be `WRONG_TYPE`.

        Note that all params need to be provided upfront. Once a client has
        requested a param list, the indices are locked and no more params
        can be added.

               Parameters
               ----------
               name : str
               Returns
               -------
               value : float
               Raises
               ------
               ParamServerError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.retrieve_param_float(name)
        )

    async def provide_param_float(self, name, value):
        """
               Provide a float parameter.

        If the type is wrong, the result will be `WRONG_TYPE`.

               Parameters
               ----------
               name : str
               value : float
               Raises
               ------
               ParamServerError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.provide_param_float(name, value)
        )

    async def retrieve_param_custom(self, name):
        """
               Retrieve a custom parameter.

        If the type is wrong, the result will be `WRONG_TYPE`.

        Note that all params need to be provided upfront. Once a client has
        requested a param list, the indices are locked and no more params
        can be added.

               Parameters
               ----------
               name : str
               Returns
               -------
               value : str
               Raises
               ------
               ParamServerError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.retrieve_param_custom(name)
        )

    async def provide_param_custom(self, name, value):
        """
               Provide a custom parameter.

        If the type is wrong, the result will be `WRONG_TYPE`.

               Parameters
               ----------
               name : str
               value : str
               Raises
               ------
               ParamServerError
                   If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.provide_param_custom(name, value)
        )

    async def retrieve_all_params(self):
        """
        Retrieve all parameters.

        Returns
        -------
        params : AllParams
        Raises
        ------
        ParamServerError
            If the request fails. The error contains the reason for the failure.
        """
        loop = asyncio.get_running_loop()
        return await loop.run_in_executor(
            None, lambda: self._plugin.retrieve_all_params()
        )

    async def subscribe_changed_param_int(self) -> AsyncGenerator[IntParam, None]:
        """
        Subscribe to changed int param.

        Yields
        ------
        int_param : IntParam
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_changed_param_int(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_changed_param_int(handle)

    async def subscribe_changed_param_float(self) -> AsyncGenerator[FloatParam, None]:
        """
        Subscribe to changed float param.

        Yields
        ------
        float_param : FloatParam
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_changed_param_float(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_changed_param_float(handle)

    async def subscribe_changed_param_custom(self) -> AsyncGenerator[CustomParam, None]:
        """
        Subscribe to changed custom param.

        Yields
        ------
        custom_param : CustomParam
             The next update
        """
        loop = asyncio.get_running_loop()
        queue: asyncio.Queue = asyncio.Queue()

        def callback(data, _user_data):
            loop.call_soon_threadsafe(queue.put_nowait, data)

        handle = self._plugin.subscribe_changed_param_custom(callback)
        self._subscription_handles[id(queue)] = handle
        try:
            while True:
                yield await queue.get()
        finally:
            if id(queue) in self._subscription_handles:
                self._subscription_handles.pop(id(queue))
                self._plugin.unsubscribe_changed_param_custom(handle)

    def destroy(self):
        self._subscription_handles.clear()
        self._plugin.destroy()

    def __del__(self):
        self.destroy()
