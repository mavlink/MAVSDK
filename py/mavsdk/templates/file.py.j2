# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/{{ plugin_name.lower_snake_case }}/{{ plugin_name.lower_snake_case }}.proto)

"""
{{ class_description }}
"""

import atexit
import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====
{% for enum in enums %}
class {{ enum.name.upper_camel_case }}(IntEnum):
    """{{ enum.enum_description }}"""
    {% for value in enum.values %}
    {{ value.name.uppercase }} = {{ loop.index0 }}
    {% endfor %}

{% endfor %}

# ===== Result Enums =====
{% set result_enum = plugin_name.upper_camel_case + "Result" %}
{% for struct in structs %}
  {% if struct.name.upper_camel_case.endswith('Result') %}
    {% for nested_enum_name, nested_enum in struct.nested_enums.items() %}
      {% if nested_enum_name == 'Result' %}
class {{ result_enum }}(IntEnum):
    """{{ nested_enum.enum_description }}"""
    {% for value in nested_enum.values %}
    {{ value.name.uppercase }} = {{ loop.index0 }}
    {% endfor %}

      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}

# ===== Internal C Structures =====
{% for struct in structs %}
  {% if not struct.name.upper_camel_case.endswith('Result') %}
class {{ struct.name.upper_camel_case }}CStruct(ctypes.Structure):
    """
    Internal C structure for {{ struct.name.upper_camel_case }}.
    Used only for C library communication.
    """
    _fields_ = [
        {% for field in struct.fields %}
          {% if field.type_info.is_primitive %}
            {% if field.type_info.is_repeated %}
        ("{{ field.name.lower_snake_case }}", ctypes.POINTER(ctypes.{{ field.type_info.inner_name }})),
        ("{{ field.name.lower_snake_case }}_size", ctypes.c_size_t),
            {% else %}
        ("{{ field.name.lower_snake_case }}", ctypes.{{ field.type_info.name }}),
            {% endif %}
          {% elif field.type_info.is_enum %}
        ("{{ field.name.lower_snake_case }}", ctypes.c_int),
          {% else %}
            {% if field.type_info.is_repeated %}
        ("{{ field.name.lower_snake_case }}", ctypes.POINTER({{ field.type_info.inner_name.upper_camel_case }}CStruct)),
        ("{{ field.name.lower_snake_case }}_size", ctypes.c_size_t),
            {% elif field.type_info.parent_type %}
        ("{{ field.name.lower_snake_case }}", ctypes.c_int),
            {% else %}
        ("{{ field.name.lower_snake_case }}", {{ field.type_info.name.upper_camel_case }}CStruct),
            {% endif %}
          {% endif %}
        {% endfor %}
    ]

  {% endif %}
{% endfor %}

# ===== Structures =====
{% for struct in structs %}
  {% if not struct.name.upper_camel_case.endswith('Result') %}
class {{ struct.name.upper_camel_case }}:
    """
    {{ struct.struct_description }}
    """
    {% for nested_enum_name, nested_enum in struct.nested_enums.items() %}
    class {{ nested_enum.name.upper_camel_case }}(IntEnum):
        """{{ nested_enum.enum_description }}"""
        {% for value in nested_enum.values %}
        {{ value.name.uppercase }} = {{ loop.index0 }}
        {% endfor %}

    {% endfor %}

    def __init__(self{% for field in struct.fields %}, {{ field.name.lower_snake_case }}=None{% endfor %}):
        {% for field in struct.fields %}
          {% if field.type_info.is_repeated %}
        self.{{ field.name.lower_snake_case }} = {{ field.name.lower_snake_case }} or []
          {% else %}
        self.{{ field.name.lower_snake_case }} = {{ field.name.lower_snake_case }}
          {% endif %}
        {% endfor %}

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        {% for field in struct.fields %}
          {% if field.type_info.is_string %}
        {# Convert C string to Python string #}
        instance.{{ field.name.lower_snake_case }} = c_struct.{{ field.name.lower_snake_case }}.decode('utf-8')
          {% elif field.type_info.is_primitive %}
            {% if field.type_info.is_repeated %}
        {# Convert C array to Python list #}
        if c_struct.{{ field.name.lower_snake_case }}_size > 0:
            instance.{{ field.name.lower_snake_case }} = [c_struct.{{ field.name.lower_snake_case }}[i] for i in range(c_struct.{{ field.name.lower_snake_case }}_size)]
        else:
            instance.{{ field.name.lower_snake_case }} = []
            {% else %}
        instance.{{ field.name.lower_snake_case }} = c_struct.{{ field.name.lower_snake_case }}
            {% endif %}
          {% elif field.type_info.is_enum %}
        {# Convert C enum to Python enum #}
        instance.{{ field.name.lower_snake_case }} = {% if field.type_info.parent_type %}{{ field.type_info.parent_type.upper_camel_case }}.{% endif %}{{ field.type_info.name.upper_camel_case }}(c_struct.{{ field.name.lower_snake_case }})
          {% else %}
            {% if field.type_info.is_repeated %}
        {# Convert array of C structs to Python objects #}
        if c_struct.{{ field.name.lower_snake_case }}_size > 0:
            instance.{{ field.name.lower_snake_case }} = [{{ field.type_info.inner_name.upper_camel_case }}.from_c_struct(c_struct.{{ field.name.lower_snake_case }}[i]) for i in range(c_struct.{{ field.name.lower_snake_case }}_size)]
        else:
            instance.{{ field.name.lower_snake_case }} = []
            {% else %}
        {# Convert nested C struct to Python object #}
        instance.{{ field.name.lower_snake_case }} = {{ field.type_info.name.upper_camel_case }}.from_c_struct(c_struct.{{ field.name.lower_snake_case }})
            {% endif %}
          {% endif %}
        {% endfor %}
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = {{ struct.name.upper_camel_case }}CStruct()
        {% for field in struct.fields %}
          {% if field.type_info.is_string %}
        {# Convert Python string to C string (bytes) #}
        c_struct.{{ field.name.lower_snake_case }} = self.{{ field.name.lower_snake_case }}.encode('utf-8')
          {% elif field.type_info.is_primitive %}
            {% if field.type_info.is_repeated %}
        {# Convert Python list to C array #}
        array_type = ctypes.{{ field.type_info.inner_name }} * len(self.{{ field.name.lower_snake_case }})
        c_struct.{{ field.name.lower_snake_case }} = array_type(*self.{{ field.name.lower_snake_case }})
        c_struct.{{ field.name.lower_snake_case }}_size = len(self.{{ field.name.lower_snake_case }})
            {% else %}
        c_struct.{{ field.name.lower_snake_case }} = self.{{ field.name.lower_snake_case }}
            {% endif %}
          {% elif field.type_info.is_enum %}
        c_struct.{{ field.name.lower_snake_case }} = int(self.{{ field.name.lower_snake_case }})
          {% else %}
            {% if field.type_info.is_repeated %}
        {# Convert list of Python objects to C array #}
        array_type = {{ field.type_info.inner_name.upper_camel_case }}CStruct * len(self.{{ field.name.lower_snake_case }})
        c_array = array_type()
        for i, item in enumerate(self.{{ field.name.lower_snake_case }}):
            c_array[i] = item.to_c_struct()
        c_struct.{{ field.name.lower_snake_case }} = ctypes.cast(c_array, ctypes.POINTER({{ field.type_info.inner_name.upper_camel_case }}CStruct))
        c_struct.{{ field.name.lower_snake_case }}_size = len(self.{{ field.name.lower_snake_case }})
            {% else %}
        {# Convert nested Python object to C struct #}
        c_struct.{{ field.name.lower_snake_case }} = self.{{ field.name.lower_snake_case }}.to_c_struct()
            {% endif %}
          {% endif %}
        {% endfor %}
        return c_struct

    def __str__(self):
        fields = []
        {% for field in struct.fields %}
          {% if field.type_info.is_primitive %}
            {% if field.type_info.is_repeated %}
        fields.append(f"{{ field.name.lower_snake_case }}=[{len(self.{{ field.name.lower_snake_case }})} items]")
            {% else %}
        fields.append(f"{{ field.name.lower_snake_case }}={self.{{ field.name.lower_snake_case }}}")
            {% endif %}
          {% else %}
        fields.append(f"{{ field.name.lower_snake_case }}={self.{{ field.name.lower_snake_case }}}")
          {% endif %}
        {% endfor %}
        return f"{{ struct.name.upper_camel_case }}({', '.join(fields)})"

  {% endif %}
{% endfor %}


# ===== Plugin =====
class {{ plugin_name.upper_camel_case }}:
    """{{ class_description }}"""

    def __init__(self, {% if is_server %}server_component{% else %}system{% endif %}):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        {% if is_server %}
        if server_component is None:
            raise ValueError("server_component cannot be None")

        component_handle = server_component._handle

        if not component_handle:
            raise ValueError("server_component handle is null")

        self._handle = self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_create(component_handle)
        {% else %}
        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_create(system_handle)
        {% endif %}

        if not self._handle:
            raise RuntimeError("Failed to create {{ plugin_name.upper_camel_case }} plugin - C function returned null handle")

        atexit.register(self.destroy)

    {% for method in methods %}

    {% if method.is_async %}
    def {% if method.is_stream and not method.is_finite %}subscribe_{% endif %}{{ method.name.lower_snake_case }}{% if not method.is_stream or method.is_finite %}_async{% endif %}(self, {% for param in method.params %}{{ param.name.lower_snake_case }}, {% endfor %}callback: Callable, user_data: Any = None):
        """{{ method.method_description }}"""

        def c_callback({% if method.has_result %}result, {% endif %}{% if method.return_type %}c_data{% if method.return_type.is_repeated %}, size{% endif %}, {% endif %}ud):
            try:
                {% if method.has_result %}
                py_result = {{ result_enum }}(result)
                {% endif %}

                {% if method.return_type %}
                {# Handle return data conversion #}
                  {% if method.return_type.is_primitive %}
                  {# Primitive types - no conversion needed #}
                py_data = c_data
                  {% elif method.return_type.is_enum %}
                  {# Enum types - convert from int to enum #}
                py_data = {{ method.return_type.inner_name.upper_camel_case }}(c_data)
                  {% else %}
                  {# Struct types - convert from CStruct #}
                    {% if method.return_type.is_repeated %}
                    {# Handle array types #}
                py_data = []
                if c_data and size.value > 0:
                    for i in range(size.value):
                        py_data.append({{ method.return_type.inner_name.upper_camel_case }}.from_c_struct(c_data[i]))
                    {% else %}
                py_data = {{ method.return_type.inner_name.upper_camel_case }}.from_c_struct(c_data)
                    {% endif %}

                    {# Destroy C struct #}
                    {% if method.return_type.is_repeated %}
                self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.return_type.inner_name.lower_snake_case }}_destroy(c_data)
                    {% else %}
                self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.return_type.inner_name.lower_snake_case }}_destroy(ctypes.byref(c_data))
                    {% endif %}
                  {% endif %}
                {% endif %}

                {# Call user callback with converted objects #}
                {% if method.has_result and method.return_type %}
                callback(py_result, py_data, user_data)
                {% elif method.has_result %}
                callback(py_result, user_data)
                {% elif method.return_type %}
                callback(py_data, user_data)
                {% else %}
                callback(user_data)
                {% endif %}

            except Exception as e:
                print(f"Error in {{ method.name.lower_snake_case }} callback: {e}")

        cb = {{ method.name.upper_camel_case }}Callback(c_callback)
        self._callbacks.append(cb)

        {% if method.is_stream and not method.is_finite %}
        return self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_subscribe_{{ method.name.lower_snake_case }}(
        {% else %}
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}_async(
        {% endif %}
            self._handle,
            {% for param in method.params %}
            {% if param.type_info.is_string %}
            {{ param.name.lower_snake_case }}.encode('utf-8') if isinstance({{ param.name.lower_snake_case }}, str) else {{ param.name.lower_snake_case }},
            {% else %}
            {{ param.name.lower_snake_case }},
            {% endif %}
            {% endfor %}
            cb,
            None
        )

    {% if method.is_stream and not method.is_finite %}
    def unsubscribe_{{ method.name.lower_snake_case }}(self, handle: ctypes.c_void_p):
        """Unsubscribe from {{ method.name.lower_snake_case }}"""
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_unsubscribe_{{ method.name.lower_snake_case }}(
            self._handle, handle
        )
      {% endif %}
    {% endif %}

{% if method.is_sync %}
    def {{ method.name.lower_snake_case }}(self{% for param in method.params %}, {{ param.name.lower_snake_case }}{% endfor %}):
        """Get {{ method.name.lower_snake_case }} (blocking)"""

        {# Prepare output parameters based on return type #}
        {% if method.return_name %}
          {% if method.return_type.is_repeated %}
        result_ptr = ctypes.POINTER({{ method.return_type.inner_name.upper_camel_case }}CStruct)()
        size = ctypes.c_size_t()
          {% else %}
            {% if method.return_type.is_primitive %}
        result_out = ctypes.{{ method.return_type.inner_name }}()
            {% elif method.return_type.is_enum %}
        result_out = ctypes.c_int()
            {% else %}
        result_out = {{ method.return_type.inner_name.upper_camel_case }}CStruct()
            {% endif %}
          {% endif %}
        {% endif %}

        {# Make the function call #}
        {% if method.has_result %}
        result_code = self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}(
            self._handle,
          {% for param in method.params %}
            {% if param.type_info.is_string %}
            {{ param.name.lower_snake_case }}.encode('utf-8') if isinstance({{ param.name.lower_snake_case }}, str) else {{ param.name.lower_snake_case }},
            {% elif param.type_info.is_primitive or param.type_info.is_enum %}
            {{ param.name.lower_snake_case }},
            {% else %}
            {{ param.name.lower_snake_case }}.to_c_struct(),
            {% endif %}
          {% endfor %}
          {% if method.return_name %}
            {% if method.return_type.is_repeated %}
            ctypes.byref(result_ptr),
            ctypes.byref(size)
            {% else %}
            ctypes.byref(result_out)
            {% endif %}
          {% endif %}
        )
        result = {{ result_enum }}(result_code)
        if result != {{ result_enum }}.SUCCESS:
            raise Exception(f"{{ method.name.lower_snake_case }} failed: {result}")
        {% else %}
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}(
            self._handle,
          {% for param in method.params %}
            {% if param.type_info.is_string %}
            {{ param.name.lower_snake_case }}.encode('utf-8') if isinstance({{ param.name.lower_snake_case }}, str) else {{ param.name.lower_snake_case }},
            {% elif param.type_info.is_primitive or param.type_info.is_enum %}
            {{ param.name.lower_snake_case }},
            {% else %}
            {{ param.name.lower_snake_case }}.to_c_struct(),
            {% endif %}
          {% endfor %}
          {% if method.return_name %}
            {% if method.return_type.is_repeated %}
            ctypes.byref(result_ptr),
            ctypes.byref(size)
            {% else %}
            ctypes.byref(result_out)
            {% endif %}
          {% endif %}
        )
        {% endif %}

        {# Process and return the result #}
        {% if method.return_name %}
          {% if method.return_type.is_repeated %}
        {# Convert C array to Python list #}
        py_result = [{{ method.return_type.inner_name.upper_camel_case }}.from_c_struct(result_ptr[i]) for i in range(size.value)]
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.return_type.inner_name.lower_snake_case }}_destroy(result_ptr)
        return py_result
          {% else %}
            {% if method.return_type.is_primitive %}
        return result_out.value
            {% elif method.return_type.is_enum %}
        {# Convert C enum to Python enum #}
        return {{ method.return_type.inner_name.lower_snake_case }}(result_out.value)
            {% else %}
        {# Convert to pure Python object #}
        py_result = {{ method.return_type.inner_name.upper_camel_case }}.from_c_struct(result_out)
        self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.return_type.inner_name.lower_snake_case }}_destroy(ctypes.byref(result_out))
        return py_result
            {% endif %}
          {% endif %}
        {% elif method.has_result %}
        return result
        {% endif %}
    {% endif %}

    {% endfor %}

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_{{ plugin_name.lower_snake_case }}_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()

# ===== Callback Types =====
{% for method in methods %}
  {% if method.is_async %}
{{ method.name.upper_camel_case }}Callback = ctypes.CFUNCTYPE(
    None,
    {% if method.has_result %}
    ctypes.c_int,
    {% endif %}
    {% if method.return_type %}
      {% if method.return_type.is_primitive %}
    ctypes.{{ method.return_type.name }},
      {% elif method.return_type.is_enum %}
    ctypes.c_int,
      {% else %}
        {% if method.return_type.is_repeated %}
    ctypes.POINTER({{ method.return_type.inner_name.upper_camel_case }}CStruct),
    ctypes.c_size_t,
        {% else %}
    {{ method.return_type.inner_name.upper_camel_case }}CStruct,
        {% endif %}
      {% endif %}
    {% endif %}
    ctypes.c_void_p
)
  {% endif %}
{% endfor %}

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_destroy.restype = None

{% for struct in structs %}
  {% if not struct.name.upper_camel_case.endswith('Result') %}
_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_destroy.argtypes = [
    ctypes.POINTER({{ struct.name.upper_camel_case }}CStruct)
]
_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ struct.name.lower_snake_case }}_destroy.restype = None

  {% endif %}
{% endfor %}

{% for method in methods %}
  {% if method.is_async %}
_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}{% if method.is_stream and not method.is_finite %}_subscribe{% endif %}_{{ method.name.lower_snake_case }}{% if not method.is_stream or method.is_finite %}_async{% endif %}.argtypes = [
    ctypes.c_void_p,
    {% for param in method.params %}
      {% if param.type_info.is_repeated %}
        {% if param.type_info.is_primitive %}
    ctypes.POINTER(ctypes.{{ param.type_info.inner_name }}),
        {% else %}
    ctypes.POINTER({{ param.type_info.inner_name.upper_camel_case }}CStruct),
        {% endif %}
    ctypes.c_size_t,
      {% elif param.type_info.is_primitive %}
    ctypes.{{ param.type_info.name }},
      {% elif param.type_info.is_enum %}
    ctypes.c_int,
      {% elif param.type_info.parent_type %}
    ctypes.c_int,
      {% else %}
    {{ param.type_info.name.upper_camel_case }}CStruct,
      {% endif %}
    {% endfor %}
    {{ method.name.upper_camel_case }}Callback,
    ctypes.c_void_p
]

_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}{% if method.is_stream and not method.is_finite %}_subscribe{% endif %}_{{ method.name.lower_snake_case }}{% if not method.is_stream or method.is_finite %}_async{% endif %}.restype = {% if method.is_stream and not method.is_finite %}ctypes.c_void_p{% else %}None{% endif %}

  {% if method.is_stream and not method.is_finite %}
# Unsubscribe
_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_unsubscribe_{{ method.name.lower_snake_case }}.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p
]

_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_unsubscribe_{{ method.name.lower_snake_case }}.restype = None
  {% endif %}
{% endif %}

{% if method.is_sync %}
_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}.argtypes = [
    ctypes.c_void_p,
    {% for param in method.params %}
      {% if param.type_info.is_repeated %}
        {% if param.type_info.is_primitive %}
    ctypes.POINTER(ctypes.{{ param.type_info.inner_name }}),
        {% else %}
    ctypes.POINTER({{ param.type_info.inner_name.upper_camel_case }}CStruct),
        {% endif %}
    ctypes.c_size_t,
      {% elif param.type_info.is_primitive %}
    ctypes.{{ param.type_info.name }},
      {% elif param.type_info.is_enum %}
    ctypes.c_int,
      {% elif param.type_info.parent_type %}
    ctypes.c_int,
      {% else %}
    {{ param.type_info.name.upper_camel_case }}CStruct,
      {% endif %}
    {% endfor %}
    {% if method.return_name %}
      {% if method.return_type.is_repeated %}
    ctypes.POINTER(ctypes.POINTER({{ method.return_type.inner_name.upper_camel_case }}CStruct)),
    ctypes.POINTER(ctypes.c_size_t)
      {% elif method.return_type.is_primitive %}
    ctypes.POINTER(ctypes.{{ method.return_type.name }})
      {% elif method.return_type.is_enum %}
    ctypes.POINTER(ctypes.c_int)
      {% else %}
    ctypes.POINTER({{ method.return_type.inner_name.upper_camel_case }}CStruct)
      {% endif %}
    {% endif %}
]

_cmavsdk_lib.mavsdk_{{ plugin_name.lower_snake_case }}_{{ method.name.lower_snake_case }}.restype = {% if method.has_result %}ctypes.c_int{% else %}None{% endif %}

  {% endif %}
{% endfor %}

