# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/failure/failure.proto)

"""
Inject failures into system to test failsafes.
"""

import atexit
import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====
class FailureUnit(IntEnum):
    """A failure unit."""

    SENSOR_GYRO = 0
    SENSOR_ACCEL = 1
    SENSOR_MAG = 2
    SENSOR_BARO = 3
    SENSOR_GPS = 4
    SENSOR_OPTICAL_FLOW = 5
    SENSOR_VIO = 6
    SENSOR_DISTANCE_SENSOR = 7
    SENSOR_AIRSPEED = 8
    SYSTEM_BATTERY = 9
    SYSTEM_MOTOR = 10
    SYSTEM_SERVO = 11
    SYSTEM_AVOIDANCE = 12
    SYSTEM_RC_SIGNAL = 13
    SYSTEM_MAVLINK_SIGNAL = 14


class FailureType(IntEnum):
    """A failure type"""

    OK = 0
    OFF = 1
    STUCK = 2
    GARBAGE = 3
    WRONG = 4
    SLOW = 5
    DELAYED = 6
    INTERMITTENT = 7


# ===== Result Enums =====
class FailureResult(IntEnum):
    """Possible results returned for failure requests."""

    UNKNOWN = 0
    SUCCESS = 1
    NO_SYSTEM = 2
    CONNECTION_ERROR = 3
    UNSUPPORTED = 4
    DENIED = 5
    DISABLED = 6
    TIMEOUT = 7


# ===== Internal C Structures =====

# ===== Structures =====


# ===== Plugin =====
class Failure:
    """Inject failures into system to test failsafes."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_failure_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create Failure plugin - C function returned null handle"
            )

        atexit.register(self.destroy)

    def inject(self, failure_unit, failure_type, instance):
        """Get inject (blocking)"""

        result_code = self._lib.mavsdk_failure_inject(
            self._handle,
            failure_unit,
            failure_type,
            instance,
        )
        result = FailureResult(result_code)
        if result != FailureResult.SUCCESS:
            raise Exception(f"inject failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_failure_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_failure_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_failure_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_failure_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_failure_destroy.restype = None


_cmavsdk_lib.mavsdk_failure_inject.argtypes = [
    ctypes.c_void_p,
    ctypes.c_int,
    ctypes.c_int,
    ctypes.c_int32,
]

_cmavsdk_lib.mavsdk_failure_inject.restype = ctypes.c_int
