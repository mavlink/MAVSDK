# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/tune/tune.proto)

"""
Enable creating and sending a tune to be played on the system.
"""

import atexit
import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====
class SongElement(IntEnum):
    """An element of the tune"""

    STYLE_LEGATO = 0
    STYLE_NORMAL = 1
    STYLE_STACCATO = 2
    DURATION_1 = 3
    DURATION_2 = 4
    DURATION_4 = 5
    DURATION_8 = 6
    DURATION_16 = 7
    DURATION_32 = 8
    NOTE_A = 9
    NOTE_B = 10
    NOTE_C = 11
    NOTE_D = 12
    NOTE_E = 13
    NOTE_F = 14
    NOTE_G = 15
    NOTE_PAUSE = 16
    SHARP = 17
    FLAT = 18
    OCTAVE_UP = 19
    OCTAVE_DOWN = 20


# ===== Result Enums =====
class TuneResult(IntEnum):
    """Possible results returned for tune requests."""

    UNKNOWN = 0
    SUCCESS = 1
    INVALID_TEMPO = 2
    TUNE_TOO_LONG = 3
    ERROR = 4
    NO_SYSTEM = 5


# ===== Internal C Structures =====
class TuneDescriptionCStruct(ctypes.Structure):
    """
    Internal C structure for TuneDescription.
    Used only for C library communication.
    """

    _fields_ = [
        ("song_elements", ctypes.c_int),
        ("tempo", ctypes.c_int32),
    ]


# ===== Structures =====
class TuneDescription:
    """
    Tune description, containing song elements and tempo.
    """

    def __init__(self, song_elements=None, tempo=None):
        self.song_elements = song_elements or []
        self.tempo = tempo

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.song_elements = c_struct.song_elements
        instance.tempo = c_struct.tempo
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = TuneDescriptionCStruct()
        c_struct.song_elements = int(self.song_elements)
        c_struct.tempo = self.tempo
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"song_elements={self.song_elements}")
        fields.append(f"tempo={self.tempo}")
        return f"TuneDescription({', '.join(fields)})"


# ===== Plugin =====
class Tune:
    """Enable creating and sending a tune to be played on the system."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_tune_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create Tune plugin - C function returned null handle"
            )

        atexit.register(self.destroy)

    def play_tune_async(
        self, tune_description, callback: Callable, user_data: Any = None
    ):
        """Send a tune to be played by the system."""

        def c_callback(result, ud):
            try:
                py_result = TuneResult(result)

                callback(py_result, user_data)

            except Exception as e:
                print(f"Error in play_tune callback: {e}")

        cb = PlayTuneCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_tune_play_tune_async(self._handle, tune_description, cb, None)

    def play_tune(self, tune_description):
        """Get play_tune (blocking)"""

        result_code = self._lib.mavsdk_tune_play_tune(
            self._handle,
            tune_description.to_c_struct(),
        )
        result = TuneResult(result_code)
        if result != TuneResult.SUCCESS:
            raise Exception(f"play_tune failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_tune_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
PlayTuneCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_void_p)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_tune_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_tune_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_tune_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_tune_destroy.restype = None

_cmavsdk_lib.mavsdk_tune_tune_description_destroy.argtypes = [
    ctypes.POINTER(TuneDescriptionCStruct)
]
_cmavsdk_lib.mavsdk_tune_tune_description_destroy.restype = None


_cmavsdk_lib.mavsdk_tune_play_tune_async.argtypes = [
    ctypes.c_void_p,
    TuneDescriptionCStruct,
    PlayTuneCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_tune_play_tune_async.restype = None

_cmavsdk_lib.mavsdk_tune_play_tune.argtypes = [
    ctypes.c_void_p,
    TuneDescriptionCStruct,
]

_cmavsdk_lib.mavsdk_tune_play_tune.restype = ctypes.c_int
