# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/info/info.proto)

"""
Provide information about the hardware and/or software of a system.
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====


# ===== Result Enums =====
class InfoResult(IntEnum):
    """Possible results returned for info requests."""

    UNKNOWN = 0
    SUCCESS = 1
    INFORMATION_NOT_RECEIVED_YET = 2
    NO_SYSTEM = 3


# ===== Internal C Structures =====
class FlightInfoCStruct(ctypes.Structure):
    """
    Internal C structure for FlightInfo.
    Used only for C library communication.
    """

    _fields_ = [
        ("time_boot_ms", ctypes.c_uint32),
        ("flight_uid", ctypes.c_uint64),
        ("duration_since_arming_ms", ctypes.c_uint32),
        ("duration_since_takeoff_ms", ctypes.c_uint32),
    ]


class IdentificationCStruct(ctypes.Structure):
    """
    Internal C structure for Identification.
    Used only for C library communication.
    """

    _fields_ = [
        ("hardware_uid", ctypes.c_char_p),
        ("legacy_uid", ctypes.c_uint64),
    ]


class ProductCStruct(ctypes.Structure):
    """
    Internal C structure for Product.
    Used only for C library communication.
    """

    _fields_ = [
        ("vendor_id", ctypes.c_int32),
        ("vendor_name", ctypes.c_char_p),
        ("product_id", ctypes.c_int32),
        ("product_name", ctypes.c_char_p),
    ]


class VersionCStruct(ctypes.Structure):
    """
    Internal C structure for Version.
    Used only for C library communication.
    """

    _fields_ = [
        ("flight_sw_major", ctypes.c_int32),
        ("flight_sw_minor", ctypes.c_int32),
        ("flight_sw_patch", ctypes.c_int32),
        ("flight_sw_vendor_major", ctypes.c_int32),
        ("flight_sw_vendor_minor", ctypes.c_int32),
        ("flight_sw_vendor_patch", ctypes.c_int32),
        ("os_sw_major", ctypes.c_int32),
        ("os_sw_minor", ctypes.c_int32),
        ("os_sw_patch", ctypes.c_int32),
        ("flight_sw_git_hash", ctypes.c_char_p),
        ("os_sw_git_hash", ctypes.c_char_p),
        ("flight_sw_version_type", ctypes.c_int),
    ]


# ===== Structures =====
class FlightInfo:
    """
    System flight information.
    """

    def __init__(
        self,
        time_boot_ms=None,
        flight_uid=None,
        duration_since_arming_ms=None,
        duration_since_takeoff_ms=None,
    ):
        self.time_boot_ms = time_boot_ms
        self.flight_uid = flight_uid
        self.duration_since_arming_ms = duration_since_arming_ms
        self.duration_since_takeoff_ms = duration_since_takeoff_ms

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.time_boot_ms = c_struct.time_boot_ms
        instance.flight_uid = c_struct.flight_uid
        instance.duration_since_arming_ms = c_struct.duration_since_arming_ms
        instance.duration_since_takeoff_ms = c_struct.duration_since_takeoff_ms
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = FlightInfoCStruct()
        c_struct.time_boot_ms = self.time_boot_ms
        c_struct.flight_uid = self.flight_uid
        c_struct.duration_since_arming_ms = self.duration_since_arming_ms
        c_struct.duration_since_takeoff_ms = self.duration_since_takeoff_ms
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"time_boot_ms={self.time_boot_ms}")
        fields.append(f"flight_uid={self.flight_uid}")
        fields.append(f"duration_since_arming_ms={self.duration_since_arming_ms}")
        fields.append(f"duration_since_takeoff_ms={self.duration_since_takeoff_ms}")
        return f"FlightInfo({', '.join(fields)})"


class Identification:
    """
    System identification.
    """

    def __init__(self, hardware_uid=None, legacy_uid=None):
        self.hardware_uid = hardware_uid
        self.legacy_uid = legacy_uid

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.hardware_uid = c_struct.hardware_uid.decode("utf-8")
        instance.legacy_uid = c_struct.legacy_uid
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = IdentificationCStruct()
        c_struct.hardware_uid = self.hardware_uid.encode("utf-8")
        c_struct.legacy_uid = self.legacy_uid
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"hardware_uid={self.hardware_uid}")
        fields.append(f"legacy_uid={self.legacy_uid}")
        return f"Identification({', '.join(fields)})"


class Product:
    """
    System product information.
    """

    def __init__(
        self, vendor_id=None, vendor_name=None, product_id=None, product_name=None
    ):
        self.vendor_id = vendor_id
        self.vendor_name = vendor_name
        self.product_id = product_id
        self.product_name = product_name

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.vendor_id = c_struct.vendor_id
        instance.vendor_name = c_struct.vendor_name.decode("utf-8")
        instance.product_id = c_struct.product_id
        instance.product_name = c_struct.product_name.decode("utf-8")
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = ProductCStruct()
        c_struct.vendor_id = self.vendor_id
        c_struct.vendor_name = self.vendor_name.encode("utf-8")
        c_struct.product_id = self.product_id
        c_struct.product_name = self.product_name.encode("utf-8")
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"vendor_id={self.vendor_id}")
        fields.append(f"vendor_name={self.vendor_name}")
        fields.append(f"product_id={self.product_id}")
        fields.append(f"product_name={self.product_name}")
        return f"Product({', '.join(fields)})"


class Version:
    """
    System version information.
    """

    class FlightSoftwareVersionType(IntEnum):
        """These values define the type of firmware/flight software release"""

        UNKNOWN = 0
        DEV = 1
        ALPHA = 2
        BETA = 3
        RC = 4
        RELEASE = 5

    def __init__(
        self,
        flight_sw_major=None,
        flight_sw_minor=None,
        flight_sw_patch=None,
        flight_sw_vendor_major=None,
        flight_sw_vendor_minor=None,
        flight_sw_vendor_patch=None,
        os_sw_major=None,
        os_sw_minor=None,
        os_sw_patch=None,
        flight_sw_git_hash=None,
        os_sw_git_hash=None,
        flight_sw_version_type=None,
    ):
        self.flight_sw_major = flight_sw_major
        self.flight_sw_minor = flight_sw_minor
        self.flight_sw_patch = flight_sw_patch
        self.flight_sw_vendor_major = flight_sw_vendor_major
        self.flight_sw_vendor_minor = flight_sw_vendor_minor
        self.flight_sw_vendor_patch = flight_sw_vendor_patch
        self.os_sw_major = os_sw_major
        self.os_sw_minor = os_sw_minor
        self.os_sw_patch = os_sw_patch
        self.flight_sw_git_hash = flight_sw_git_hash
        self.os_sw_git_hash = os_sw_git_hash
        self.flight_sw_version_type = flight_sw_version_type

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.flight_sw_major = c_struct.flight_sw_major
        instance.flight_sw_minor = c_struct.flight_sw_minor
        instance.flight_sw_patch = c_struct.flight_sw_patch
        instance.flight_sw_vendor_major = c_struct.flight_sw_vendor_major
        instance.flight_sw_vendor_minor = c_struct.flight_sw_vendor_minor
        instance.flight_sw_vendor_patch = c_struct.flight_sw_vendor_patch
        instance.os_sw_major = c_struct.os_sw_major
        instance.os_sw_minor = c_struct.os_sw_minor
        instance.os_sw_patch = c_struct.os_sw_patch
        instance.flight_sw_git_hash = c_struct.flight_sw_git_hash.decode("utf-8")
        instance.os_sw_git_hash = c_struct.os_sw_git_hash.decode("utf-8")
        instance.flight_sw_version_type = Version.FlightSoftwareVersionType(
            c_struct.flight_sw_version_type
        )
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = VersionCStruct()
        c_struct.flight_sw_major = self.flight_sw_major
        c_struct.flight_sw_minor = self.flight_sw_minor
        c_struct.flight_sw_patch = self.flight_sw_patch
        c_struct.flight_sw_vendor_major = self.flight_sw_vendor_major
        c_struct.flight_sw_vendor_minor = self.flight_sw_vendor_minor
        c_struct.flight_sw_vendor_patch = self.flight_sw_vendor_patch
        c_struct.os_sw_major = self.os_sw_major
        c_struct.os_sw_minor = self.os_sw_minor
        c_struct.os_sw_patch = self.os_sw_patch
        c_struct.flight_sw_git_hash = self.flight_sw_git_hash.encode("utf-8")
        c_struct.os_sw_git_hash = self.os_sw_git_hash.encode("utf-8")
        c_struct.flight_sw_version_type = int(self.flight_sw_version_type)
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"flight_sw_major={self.flight_sw_major}")
        fields.append(f"flight_sw_minor={self.flight_sw_minor}")
        fields.append(f"flight_sw_patch={self.flight_sw_patch}")
        fields.append(f"flight_sw_vendor_major={self.flight_sw_vendor_major}")
        fields.append(f"flight_sw_vendor_minor={self.flight_sw_vendor_minor}")
        fields.append(f"flight_sw_vendor_patch={self.flight_sw_vendor_patch}")
        fields.append(f"os_sw_major={self.os_sw_major}")
        fields.append(f"os_sw_minor={self.os_sw_minor}")
        fields.append(f"os_sw_patch={self.os_sw_patch}")
        fields.append(f"flight_sw_git_hash={self.flight_sw_git_hash}")
        fields.append(f"os_sw_git_hash={self.os_sw_git_hash}")
        fields.append(f"flight_sw_version_type={self.flight_sw_version_type}")
        return f"Version({', '.join(fields)})"


# ===== Plugin =====
class Info:
    """Provide information about the hardware and/or software of a system."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_info_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create Info plugin - C function returned null handle"
            )

    def get_flight_information(self):
        """Get get_flight_information (blocking)"""

        result_out = FlightInfoCStruct()

        result_code = self._lib.mavsdk_info_get_flight_information(
            self._handle, ctypes.byref(result_out)
        )
        result = InfoResult(result_code)
        if result != InfoResult.SUCCESS:
            raise Exception(f"get_flight_information failed: {result}")

        py_result = FlightInfo.from_c_struct(result_out)
        self._lib.mavsdk_info_flight_info_destroy(ctypes.byref(result_out))
        return py_result

    def get_identification(self):
        """Get get_identification (blocking)"""

        result_out = IdentificationCStruct()

        result_code = self._lib.mavsdk_info_get_identification(
            self._handle, ctypes.byref(result_out)
        )
        result = InfoResult(result_code)
        if result != InfoResult.SUCCESS:
            raise Exception(f"get_identification failed: {result}")

        py_result = Identification.from_c_struct(result_out)
        self._lib.mavsdk_info_identification_destroy(ctypes.byref(result_out))
        return py_result

    def get_product(self):
        """Get get_product (blocking)"""

        result_out = ProductCStruct()

        result_code = self._lib.mavsdk_info_get_product(
            self._handle, ctypes.byref(result_out)
        )
        result = InfoResult(result_code)
        if result != InfoResult.SUCCESS:
            raise Exception(f"get_product failed: {result}")

        py_result = Product.from_c_struct(result_out)
        self._lib.mavsdk_info_product_destroy(ctypes.byref(result_out))
        return py_result

    def get_version(self):
        """Get get_version (blocking)"""

        result_out = VersionCStruct()

        result_code = self._lib.mavsdk_info_get_version(
            self._handle, ctypes.byref(result_out)
        )
        result = InfoResult(result_code)
        if result != InfoResult.SUCCESS:
            raise Exception(f"get_version failed: {result}")

        py_result = Version.from_c_struct(result_out)
        self._lib.mavsdk_info_version_destroy(ctypes.byref(result_out))
        return py_result

    def get_speed_factor(self):
        """Get get_speed_factor (blocking)"""

        result_out = ctypes.c_double()

        result_code = self._lib.mavsdk_info_get_speed_factor(
            self._handle, ctypes.byref(result_out)
        )
        result = InfoResult(result_code)
        if result != InfoResult.SUCCESS:
            raise Exception(f"get_speed_factor failed: {result}")

        return result_out.value

    def subscribe_flight_information(self, callback: Callable, user_data: Any = None):
        """Subscribe to 'flight information' updates."""

        def c_callback(c_data, ud):
            try:
                py_data = FlightInfo.from_c_struct(c_data)

                self._lib.mavsdk_info_flight_info_destroy(ctypes.byref(c_data))

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in flight_information callback: {e}")

        cb = FlightInformationCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_info_subscribe_flight_information(
            self._handle, cb, None
        )

    def unsubscribe_flight_information(self, handle: ctypes.c_void_p):
        """Unsubscribe from flight_information"""
        self._lib.mavsdk_info_unsubscribe_flight_information(self._handle, handle)

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_info_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
FlightInformationCallback = ctypes.CFUNCTYPE(None, FlightInfoCStruct, ctypes.c_void_p)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_info_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_info_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_info_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_info_destroy.restype = None

_cmavsdk_lib.mavsdk_info_flight_info_destroy.argtypes = [
    ctypes.POINTER(FlightInfoCStruct)
]
_cmavsdk_lib.mavsdk_info_flight_info_destroy.restype = None

_cmavsdk_lib.mavsdk_info_identification_destroy.argtypes = [
    ctypes.POINTER(IdentificationCStruct)
]
_cmavsdk_lib.mavsdk_info_identification_destroy.restype = None

_cmavsdk_lib.mavsdk_info_product_destroy.argtypes = [ctypes.POINTER(ProductCStruct)]
_cmavsdk_lib.mavsdk_info_product_destroy.restype = None

_cmavsdk_lib.mavsdk_info_version_destroy.argtypes = [ctypes.POINTER(VersionCStruct)]
_cmavsdk_lib.mavsdk_info_version_destroy.restype = None


_cmavsdk_lib.mavsdk_info_get_flight_information.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(FlightInfoCStruct),
]

_cmavsdk_lib.mavsdk_info_get_flight_information.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_info_get_identification.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(IdentificationCStruct),
]

_cmavsdk_lib.mavsdk_info_get_identification.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_info_get_product.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(ProductCStruct),
]

_cmavsdk_lib.mavsdk_info_get_product.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_info_get_version.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(VersionCStruct),
]

_cmavsdk_lib.mavsdk_info_get_version.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_info_get_speed_factor.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(ctypes.c_double),
]

_cmavsdk_lib.mavsdk_info_get_speed_factor.restype = ctypes.c_int
_cmavsdk_lib.mavsdk_info_subscribe_flight_information.argtypes = [
    ctypes.c_void_p,
    FlightInformationCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_info_subscribe_flight_information.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_info_unsubscribe_flight_information.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_info_unsubscribe_flight_information.restype = None
