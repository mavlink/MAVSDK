# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/param_server/param_server.proto)

"""
Provide raw access to retrieve and provide server parameters.
"""

import atexit
import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====


# ===== Result Enums =====
class ParamServerResult(IntEnum):
    """Possible results returned for param requests."""

    UNKNOWN = 0
    SUCCESS = 1
    NOT_FOUND = 2
    WRONG_TYPE = 3
    PARAM_NAME_TOO_LONG = 4
    NO_SYSTEM = 5
    PARAM_VALUE_TOO_LONG = 6
    PARAM_PROVIDED_TOO_LATE = 7


# ===== Internal C Structures =====
class IntParamCStruct(ctypes.Structure):
    """
    Internal C structure for IntParam.
    Used only for C library communication.
    """

    _fields_ = [
        ("name", ctypes.c_char_p),
        ("value", ctypes.c_int32),
    ]


class FloatParamCStruct(ctypes.Structure):
    """
    Internal C structure for FloatParam.
    Used only for C library communication.
    """

    _fields_ = [
        ("name", ctypes.c_char_p),
        ("value", ctypes.c_float),
    ]


class CustomParamCStruct(ctypes.Structure):
    """
    Internal C structure for CustomParam.
    Used only for C library communication.
    """

    _fields_ = [
        ("name", ctypes.c_char_p),
        ("value", ctypes.c_char_p),
    ]


class AllParamsCStruct(ctypes.Structure):
    """
    Internal C structure for AllParams.
    Used only for C library communication.
    """

    _fields_ = [
        ("int_params", ctypes.POINTER(IntParamCStruct)),
        ("int_params_size", ctypes.c_size_t),
        ("float_params", ctypes.POINTER(FloatParamCStruct)),
        ("float_params_size", ctypes.c_size_t),
        ("custom_params", ctypes.POINTER(CustomParamCStruct)),
        ("custom_params_size", ctypes.c_size_t),
    ]


# ===== Structures =====
class IntParam:
    """
    Type for integer parameters.
    """

    def __init__(self, name=None, value=None):
        self.name = name
        self.value = value

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.name = c_struct.name.decode("utf-8")
        instance.value = c_struct.value
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = IntParamCStruct()
        c_struct.name = self.name.encode("utf-8")
        c_struct.value = self.value
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"name={self.name}")
        fields.append(f"value={self.value}")
        return f"IntParam({', '.join(fields)})"


class FloatParam:
    """
    Type for float parameters.
    """

    def __init__(self, name=None, value=None):
        self.name = name
        self.value = value

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.name = c_struct.name.decode("utf-8")
        instance.value = c_struct.value
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = FloatParamCStruct()
        c_struct.name = self.name.encode("utf-8")
        c_struct.value = self.value
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"name={self.name}")
        fields.append(f"value={self.value}")
        return f"FloatParam({', '.join(fields)})"


class CustomParam:
    """
    Type for float parameters.
    """

    def __init__(self, name=None, value=None):
        self.name = name
        self.value = value

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.name = c_struct.name.decode("utf-8")
        instance.value = c_struct.value.decode("utf-8")
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = CustomParamCStruct()
        c_struct.name = self.name.encode("utf-8")
        c_struct.value = self.value.encode("utf-8")
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"name={self.name}")
        fields.append(f"value={self.value}")
        return f"CustomParam({', '.join(fields)})"


class AllParams:
    """
    Type collecting all integer, float, and custom parameters.
    """

    def __init__(self, int_params=None, float_params=None, custom_params=None):
        self.int_params = int_params or []
        self.float_params = float_params or []
        self.custom_params = custom_params or []

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        if c_struct.int_params_size > 0:
            instance.int_params = [
                IntParam.from_c_struct(c_struct.int_params[i])
                for i in range(c_struct.int_params_size)
            ]
        else:
            instance.int_params = []
        if c_struct.float_params_size > 0:
            instance.float_params = [
                FloatParam.from_c_struct(c_struct.float_params[i])
                for i in range(c_struct.float_params_size)
            ]
        else:
            instance.float_params = []
        if c_struct.custom_params_size > 0:
            instance.custom_params = [
                CustomParam.from_c_struct(c_struct.custom_params[i])
                for i in range(c_struct.custom_params_size)
            ]
        else:
            instance.custom_params = []
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = AllParamsCStruct()
        array_type = IntParamCStruct * len(self.int_params)
        c_array = array_type()
        for i, item in enumerate(self.int_params):
            c_array[i] = item.to_c_struct()
        c_struct.int_params = ctypes.cast(c_array, ctypes.POINTER(IntParamCStruct))
        c_struct.int_params_size = len(self.int_params)
        array_type = FloatParamCStruct * len(self.float_params)
        c_array = array_type()
        for i, item in enumerate(self.float_params):
            c_array[i] = item.to_c_struct()
        c_struct.float_params = ctypes.cast(c_array, ctypes.POINTER(FloatParamCStruct))
        c_struct.float_params_size = len(self.float_params)
        array_type = CustomParamCStruct * len(self.custom_params)
        c_array = array_type()
        for i, item in enumerate(self.custom_params):
            c_array[i] = item.to_c_struct()
        c_struct.custom_params = ctypes.cast(
            c_array, ctypes.POINTER(CustomParamCStruct)
        )
        c_struct.custom_params_size = len(self.custom_params)
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"int_params={self.int_params}")
        fields.append(f"float_params={self.float_params}")
        fields.append(f"custom_params={self.custom_params}")
        return f"AllParams({', '.join(fields)})"


# ===== Plugin =====
class ParamServer:
    """Provide raw access to retrieve and provide server parameters."""

    def __init__(self, server_component):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if server_component is None:
            raise ValueError("server_component cannot be None")

        component_handle = server_component._handle

        if not component_handle:
            raise ValueError("server_component handle is null")

        self._handle = self._lib.mavsdk_param_server_create(component_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create ParamServer plugin - C function returned null handle"
            )

        atexit.register(self.destroy)

    def set_protocol(self, extended_protocol):
        """Get set_protocol (blocking)"""

        result_code = self._lib.mavsdk_param_server_set_protocol(
            self._handle,
            extended_protocol,
        )
        result = ParamServerResult(result_code)
        if result != ParamServerResult.SUCCESS:
            raise Exception(f"set_protocol failed: {result}")

        return result

    def retrieve_param_int(self, name):
        """Get retrieve_param_int (blocking)"""

        result_out = ctypes.c_int32()

        result_code = self._lib.mavsdk_param_server_retrieve_param_int(
            self._handle,
            name.encode("utf-8") if isinstance(name, str) else name,
            ctypes.byref(result_out),
        )
        result = ParamServerResult(result_code)
        if result != ParamServerResult.SUCCESS:
            raise Exception(f"retrieve_param_int failed: {result}")

        return result_out.value

    def provide_param_int(self, name, value):
        """Get provide_param_int (blocking)"""

        result_code = self._lib.mavsdk_param_server_provide_param_int(
            self._handle,
            name.encode("utf-8") if isinstance(name, str) else name,
            value,
        )
        result = ParamServerResult(result_code)
        if result != ParamServerResult.SUCCESS:
            raise Exception(f"provide_param_int failed: {result}")

        return result

    def retrieve_param_float(self, name):
        """Get retrieve_param_float (blocking)"""

        result_out = ctypes.c_float()

        result_code = self._lib.mavsdk_param_server_retrieve_param_float(
            self._handle,
            name.encode("utf-8") if isinstance(name, str) else name,
            ctypes.byref(result_out),
        )
        result = ParamServerResult(result_code)
        if result != ParamServerResult.SUCCESS:
            raise Exception(f"retrieve_param_float failed: {result}")

        return result_out.value

    def provide_param_float(self, name, value):
        """Get provide_param_float (blocking)"""

        result_code = self._lib.mavsdk_param_server_provide_param_float(
            self._handle,
            name.encode("utf-8") if isinstance(name, str) else name,
            value,
        )
        result = ParamServerResult(result_code)
        if result != ParamServerResult.SUCCESS:
            raise Exception(f"provide_param_float failed: {result}")

        return result

    def retrieve_param_custom(self, name):
        """Get retrieve_param_custom (blocking)"""

        result_out = ctypes.c_char_p()

        result_code = self._lib.mavsdk_param_server_retrieve_param_custom(
            self._handle,
            name.encode("utf-8") if isinstance(name, str) else name,
            ctypes.byref(result_out),
        )
        result = ParamServerResult(result_code)
        if result != ParamServerResult.SUCCESS:
            raise Exception(f"retrieve_param_custom failed: {result}")

        return result_out.value

    def provide_param_custom(self, name, value):
        """Get provide_param_custom (blocking)"""

        result_code = self._lib.mavsdk_param_server_provide_param_custom(
            self._handle,
            name.encode("utf-8") if isinstance(name, str) else name,
            value.encode("utf-8") if isinstance(value, str) else value,
        )
        result = ParamServerResult(result_code)
        if result != ParamServerResult.SUCCESS:
            raise Exception(f"provide_param_custom failed: {result}")

        return result

    def retrieve_all_params(self):
        """Get retrieve_all_params (blocking)"""

        result_out = AllParamsCStruct()

        self._lib.mavsdk_param_server_retrieve_all_params(
            self._handle, ctypes.byref(result_out)
        )

        py_result = AllParams.from_c_struct(result_out)
        self._lib.mavsdk_param_server_all_params_destroy(ctypes.byref(result_out))
        return py_result

    def subscribe_changed_param_int(self, callback: Callable, user_data: Any = None):
        """Subscribe to changed int param."""

        def c_callback(c_data, ud):
            try:
                py_data = IntParam.from_c_struct(c_data)

                self._lib.mavsdk_param_server_int_param_destroy(ctypes.byref(c_data))

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in changed_param_int callback: {e}")

        cb = ChangedParamIntCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_param_server_subscribe_changed_param_int(
            self._handle, cb, None
        )

    def unsubscribe_changed_param_int(self, handle: ctypes.c_void_p):
        """Unsubscribe from changed_param_int"""
        self._lib.mavsdk_param_server_unsubscribe_changed_param_int(
            self._handle, handle
        )

    def subscribe_changed_param_float(self, callback: Callable, user_data: Any = None):
        """Subscribe to changed float param."""

        def c_callback(c_data, ud):
            try:
                py_data = FloatParam.from_c_struct(c_data)

                self._lib.mavsdk_param_server_float_param_destroy(ctypes.byref(c_data))

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in changed_param_float callback: {e}")

        cb = ChangedParamFloatCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_param_server_subscribe_changed_param_float(
            self._handle, cb, None
        )

    def unsubscribe_changed_param_float(self, handle: ctypes.c_void_p):
        """Unsubscribe from changed_param_float"""
        self._lib.mavsdk_param_server_unsubscribe_changed_param_float(
            self._handle, handle
        )

    def subscribe_changed_param_custom(self, callback: Callable, user_data: Any = None):
        """Subscribe to changed custom param."""

        def c_callback(c_data, ud):
            try:
                py_data = CustomParam.from_c_struct(c_data)

                self._lib.mavsdk_param_server_custom_param_destroy(ctypes.byref(c_data))

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in changed_param_custom callback: {e}")

        cb = ChangedParamCustomCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_param_server_subscribe_changed_param_custom(
            self._handle, cb, None
        )

    def unsubscribe_changed_param_custom(self, handle: ctypes.c_void_p):
        """Unsubscribe from changed_param_custom"""
        self._lib.mavsdk_param_server_unsubscribe_changed_param_custom(
            self._handle, handle
        )

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_param_server_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
ChangedParamIntCallback = ctypes.CFUNCTYPE(None, IntParamCStruct, ctypes.c_void_p)
ChangedParamFloatCallback = ctypes.CFUNCTYPE(None, FloatParamCStruct, ctypes.c_void_p)
ChangedParamCustomCallback = ctypes.CFUNCTYPE(None, CustomParamCStruct, ctypes.c_void_p)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_param_server_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_param_server_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_param_server_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_param_server_destroy.restype = None

_cmavsdk_lib.mavsdk_param_server_int_param_destroy.argtypes = [
    ctypes.POINTER(IntParamCStruct)
]
_cmavsdk_lib.mavsdk_param_server_int_param_destroy.restype = None

_cmavsdk_lib.mavsdk_param_server_float_param_destroy.argtypes = [
    ctypes.POINTER(FloatParamCStruct)
]
_cmavsdk_lib.mavsdk_param_server_float_param_destroy.restype = None

_cmavsdk_lib.mavsdk_param_server_custom_param_destroy.argtypes = [
    ctypes.POINTER(CustomParamCStruct)
]
_cmavsdk_lib.mavsdk_param_server_custom_param_destroy.restype = None

_cmavsdk_lib.mavsdk_param_server_all_params_destroy.argtypes = [
    ctypes.POINTER(AllParamsCStruct)
]
_cmavsdk_lib.mavsdk_param_server_all_params_destroy.restype = None


_cmavsdk_lib.mavsdk_param_server_set_protocol.argtypes = [
    ctypes.c_void_p,
    ctypes.c_bool,
]

_cmavsdk_lib.mavsdk_param_server_set_protocol.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_param_server_retrieve_param_int.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.POINTER(ctypes.c_int32),
]

_cmavsdk_lib.mavsdk_param_server_retrieve_param_int.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_param_server_provide_param_int.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.c_int32,
]

_cmavsdk_lib.mavsdk_param_server_provide_param_int.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_param_server_retrieve_param_float.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.POINTER(ctypes.c_float),
]

_cmavsdk_lib.mavsdk_param_server_retrieve_param_float.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_param_server_provide_param_float.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.c_float,
]

_cmavsdk_lib.mavsdk_param_server_provide_param_float.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_param_server_retrieve_param_custom.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.POINTER(ctypes.c_char_p),
]

_cmavsdk_lib.mavsdk_param_server_retrieve_param_custom.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_param_server_provide_param_custom.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.c_char_p,
]

_cmavsdk_lib.mavsdk_param_server_provide_param_custom.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_param_server_retrieve_all_params.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(AllParamsCStruct),
]

_cmavsdk_lib.mavsdk_param_server_retrieve_all_params.restype = None
_cmavsdk_lib.mavsdk_param_server_subscribe_changed_param_int.argtypes = [
    ctypes.c_void_p,
    ChangedParamIntCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_param_server_subscribe_changed_param_int.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_param_server_unsubscribe_changed_param_int.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_param_server_unsubscribe_changed_param_int.restype = None

_cmavsdk_lib.mavsdk_param_server_subscribe_changed_param_float.argtypes = [
    ctypes.c_void_p,
    ChangedParamFloatCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_param_server_subscribe_changed_param_float.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_param_server_unsubscribe_changed_param_float.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_param_server_unsubscribe_changed_param_float.restype = None

_cmavsdk_lib.mavsdk_param_server_subscribe_changed_param_custom.argtypes = [
    ctypes.c_void_p,
    ChangedParamCustomCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_param_server_subscribe_changed_param_custom.restype = (
    ctypes.c_void_p
)
# Unsubscribe
_cmavsdk_lib.mavsdk_param_server_unsubscribe_changed_param_custom.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_param_server_unsubscribe_changed_param_custom.restype = None
