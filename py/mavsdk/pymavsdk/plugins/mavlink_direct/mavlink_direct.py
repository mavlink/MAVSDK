# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/mavlink_direct/mavlink_direct.proto)

"""
Enable direct MAVLink communication using libmav.
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====


# ===== Result Enums =====
class MavlinkDirectResult(IntEnum):
    """Possible results returned for action requests."""

    UNKNOWN = 0
    SUCCESS = 1
    ERROR = 2
    INVALID_MESSAGE = 3
    INVALID_FIELD = 4
    CONNECTION_ERROR = 5
    NO_SYSTEM = 6
    TIMEOUT = 7


# ===== Internal C Structures =====
class MavlinkMessageCStruct(ctypes.Structure):
    """
    Internal C structure for MavlinkMessage.
    Used only for C library communication.
    """

    _fields_ = [
        ("message_name", ctypes.c_char_p),
        ("system_id", ctypes.c_uint32),
        ("component_id", ctypes.c_uint32),
        ("target_system_id", ctypes.c_uint32),
        ("target_component_id", ctypes.c_uint32),
        ("fields_json", ctypes.c_char_p),
    ]


# ===== Structures =====
class MavlinkMessage:
    """
    A complete MAVLink message with all header information and fields
    """

    def __init__(
        self,
        message_name=None,
        system_id=None,
        component_id=None,
        target_system_id=None,
        target_component_id=None,
        fields_json=None,
    ):
        self.message_name = message_name
        self.system_id = system_id
        self.component_id = component_id
        self.target_system_id = target_system_id
        self.target_component_id = target_component_id
        self.fields_json = fields_json

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.message_name = c_struct.message_name.decode("utf-8")
        instance.system_id = c_struct.system_id
        instance.component_id = c_struct.component_id
        instance.target_system_id = c_struct.target_system_id
        instance.target_component_id = c_struct.target_component_id
        instance.fields_json = c_struct.fields_json.decode("utf-8")
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = MavlinkMessageCStruct()
        c_struct.message_name = self.message_name.encode("utf-8")
        c_struct.system_id = self.system_id
        c_struct.component_id = self.component_id
        c_struct.target_system_id = self.target_system_id
        c_struct.target_component_id = self.target_component_id
        c_struct.fields_json = self.fields_json.encode("utf-8")
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"message_name={self.message_name}")
        fields.append(f"system_id={self.system_id}")
        fields.append(f"component_id={self.component_id}")
        fields.append(f"target_system_id={self.target_system_id}")
        fields.append(f"target_component_id={self.target_component_id}")
        fields.append(f"fields_json={self.fields_json}")
        return f"MavlinkMessage({', '.join(fields)})"


# ===== Plugin =====
class MavlinkDirect:
    """Enable direct MAVLink communication using libmav."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_mavlink_direct_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create MavlinkDirect plugin - C function returned null handle"
            )

    def send_message(self, message):
        """Get send_message (blocking)"""

        result_code = self._lib.mavsdk_mavlink_direct_send_message(
            self._handle,
            message.to_c_struct(),
        )
        result = MavlinkDirectResult(result_code)
        if result != MavlinkDirectResult.SUCCESS:
            raise Exception(f"send_message failed: {result}")

        return result

    def subscribe_message(
        self, message_name, callback: Callable, user_data: Any = None
    ):
        """Subscribe to incoming MAVLink messages.

        This provides direct access to incoming MAVLink messages. Use an empty string
        in message_name to subscribe to all messages, or specify a message name
        (e.g., "HEARTBEAT") to filter for specific message types."""

        def c_callback(c_data, ud):
            try:
                py_data = MavlinkMessage.from_c_struct(c_data)

                self._lib.mavsdk_mavlink_direct_mavlink_message_destroy(
                    ctypes.byref(c_data)
                )

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in message callback: {e}")

        cb = MessageCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_mavlink_direct_subscribe_message(
            self._handle, message_name, cb, None
        )

    def unsubscribe_message(self, handle: ctypes.c_void_p):
        """Unsubscribe from message"""
        self._lib.mavsdk_mavlink_direct_unsubscribe_message(self._handle, handle)

    def load_custom_xml(self, xml_content):
        """Get load_custom_xml (blocking)"""

        result_code = self._lib.mavsdk_mavlink_direct_load_custom_xml(
            self._handle,
            xml_content,
        )
        result = MavlinkDirectResult(result_code)
        if result != MavlinkDirectResult.SUCCESS:
            raise Exception(f"load_custom_xml failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_mavlink_direct_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
MessageCallback = ctypes.CFUNCTYPE(None, MavlinkMessageCStruct, ctypes.c_void_p)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_mavlink_direct_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_mavlink_direct_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_mavlink_direct_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_mavlink_direct_destroy.restype = None

_cmavsdk_lib.mavsdk_mavlink_direct_mavlink_message_destroy.argtypes = [
    ctypes.POINTER(MavlinkMessageCStruct)
]
_cmavsdk_lib.mavsdk_mavlink_direct_mavlink_message_destroy.restype = None


_cmavsdk_lib.mavsdk_mavlink_direct_send_message.argtypes = [
    ctypes.c_void_p,
    MavlinkMessageCStruct,
]

_cmavsdk_lib.mavsdk_mavlink_direct_send_message.restype = ctypes.c_int
_cmavsdk_lib.mavsdk_mavlink_direct_subscribe_message.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    MessageCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_mavlink_direct_subscribe_message.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_mavlink_direct_unsubscribe_message.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_mavlink_direct_unsubscribe_message.restype = None


_cmavsdk_lib.mavsdk_mavlink_direct_load_custom_xml.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
]

_cmavsdk_lib.mavsdk_mavlink_direct_load_custom_xml.restype = ctypes.c_int
