# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/ftp/ftp.proto)

"""
Implements file transfer functionality using MAVLink FTP.
"""

import atexit
import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====


# ===== Result Enums =====
class FtpResult(IntEnum):
    """Possible results returned for FTP commands"""

    UNKNOWN = 0
    SUCCESS = 1
    NEXT = 2
    TIMEOUT = 3
    BUSY = 4
    FILE_IO_ERROR = 5
    FILE_EXISTS = 6
    FILE_DOES_NOT_EXIST = 7
    FILE_PROTECTED = 8
    INVALID_PARAMETER = 9
    UNSUPPORTED = 10
    PROTOCOL_ERROR = 11
    NO_SYSTEM = 12


# ===== Internal C Structures =====
class ListDirectoryDataCStruct(ctypes.Structure):
    """
    Internal C structure for ListDirectoryData.
    Used only for C library communication.
    """

    _fields_ = [
        ("dirs", ctypes.POINTER(ctypes.c_char_p)),
        ("dirs_size", ctypes.c_size_t),
        ("files", ctypes.POINTER(ctypes.c_char_p)),
        ("files_size", ctypes.c_size_t),
    ]


class ProgressDataCStruct(ctypes.Structure):
    """
    Internal C structure for ProgressData.
    Used only for C library communication.
    """

    _fields_ = [
        ("bytes_transferred", ctypes.c_uint32),
        ("total_bytes", ctypes.c_uint32),
    ]


# ===== Structures =====
class ListDirectoryData:
    """
    The output of a directory list
    """

    def __init__(self, dirs=None, files=None):
        self.dirs = dirs or []
        self.files = files or []

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.dirs = c_struct.dirs.decode("utf-8")
        instance.files = c_struct.files.decode("utf-8")
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = ListDirectoryDataCStruct()
        c_struct.dirs = self.dirs.encode("utf-8")
        c_struct.files = self.files.encode("utf-8")
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"dirs=[{len(self.dirs)} items]")
        fields.append(f"files=[{len(self.files)} items]")
        return f"ListDirectoryData({', '.join(fields)})"


class ProgressData:
    """
    Progress data type for file transfer.
    """

    def __init__(self, bytes_transferred=None, total_bytes=None):
        self.bytes_transferred = bytes_transferred
        self.total_bytes = total_bytes

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.bytes_transferred = c_struct.bytes_transferred
        instance.total_bytes = c_struct.total_bytes
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = ProgressDataCStruct()
        c_struct.bytes_transferred = self.bytes_transferred
        c_struct.total_bytes = self.total_bytes
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"bytes_transferred={self.bytes_transferred}")
        fields.append(f"total_bytes={self.total_bytes}")
        return f"ProgressData({', '.join(fields)})"


# ===== Plugin =====
class Ftp:
    """Implements file transfer functionality using MAVLink FTP."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_ftp_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create Ftp plugin - C function returned null handle"
            )

        atexit.register(self.destroy)

    def download_async(
        self,
        remote_file_path,
        local_dir,
        use_burst,
        callback: Callable,
        user_data: Any = None,
    ):
        """Downloads a file to local directory."""

        def c_callback(result, c_data, ud):
            try:
                py_result = FtpResult(result)

                py_data = ProgressData.from_c_struct(c_data)

                self._lib.mavsdk_ftp_progress_data_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in download callback: {e}")

        cb = DownloadCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_ftp_download_async(
            self._handle,
            remote_file_path.encode("utf-8")
            if isinstance(remote_file_path, str)
            else remote_file_path,
            local_dir.encode("utf-8") if isinstance(local_dir, str) else local_dir,
            use_burst,
            cb,
            None,
        )

    def upload_async(
        self, local_file_path, remote_dir, callback: Callable, user_data: Any = None
    ):
        """Uploads local file to remote directory."""

        def c_callback(result, c_data, ud):
            try:
                py_result = FtpResult(result)

                py_data = ProgressData.from_c_struct(c_data)

                self._lib.mavsdk_ftp_progress_data_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in upload callback: {e}")

        cb = UploadCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_ftp_upload_async(
            self._handle,
            local_file_path.encode("utf-8")
            if isinstance(local_file_path, str)
            else local_file_path,
            remote_dir.encode("utf-8") if isinstance(remote_dir, str) else remote_dir,
            cb,
            None,
        )

    def list_directory_async(
        self, remote_dir, callback: Callable, user_data: Any = None
    ):
        """Lists items from a remote directory."""

        def c_callback(result, c_data, ud):
            try:
                py_result = FtpResult(result)

                py_data = ListDirectoryData.from_c_struct(c_data)

                self._lib.mavsdk_ftp_list_directory_data_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in list_directory callback: {e}")

        cb = ListDirectoryCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_ftp_list_directory_async(
            self._handle,
            remote_dir.encode("utf-8") if isinstance(remote_dir, str) else remote_dir,
            cb,
            None,
        )

    def list_directory(self, remote_dir):
        """Get list_directory (blocking)"""

        result_out = ListDirectoryDataCStruct()

        result_code = self._lib.mavsdk_ftp_list_directory(
            self._handle,
            remote_dir.encode("utf-8") if isinstance(remote_dir, str) else remote_dir,
            ctypes.byref(result_out),
        )
        result = FtpResult(result_code)
        if result != FtpResult.SUCCESS:
            raise Exception(f"list_directory failed: {result}")

        py_result = ListDirectoryData.from_c_struct(result_out)
        self._lib.mavsdk_ftp_list_directory_data_destroy(ctypes.byref(result_out))
        return py_result

    def create_directory_async(
        self, remote_dir, callback: Callable, user_data: Any = None
    ):
        """Creates a remote directory."""

        def c_callback(result, ud):
            try:
                py_result = FtpResult(result)

                callback(py_result, user_data)

            except Exception as e:
                print(f"Error in create_directory callback: {e}")

        cb = CreateDirectoryCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_ftp_create_directory_async(
            self._handle,
            remote_dir.encode("utf-8") if isinstance(remote_dir, str) else remote_dir,
            cb,
            None,
        )

    def create_directory(self, remote_dir):
        """Get create_directory (blocking)"""

        result_code = self._lib.mavsdk_ftp_create_directory(
            self._handle,
            remote_dir.encode("utf-8") if isinstance(remote_dir, str) else remote_dir,
        )
        result = FtpResult(result_code)
        if result != FtpResult.SUCCESS:
            raise Exception(f"create_directory failed: {result}")

        return result

    def remove_directory_async(
        self, remote_dir, callback: Callable, user_data: Any = None
    ):
        """Removes a remote directory."""

        def c_callback(result, ud):
            try:
                py_result = FtpResult(result)

                callback(py_result, user_data)

            except Exception as e:
                print(f"Error in remove_directory callback: {e}")

        cb = RemoveDirectoryCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_ftp_remove_directory_async(
            self._handle,
            remote_dir.encode("utf-8") if isinstance(remote_dir, str) else remote_dir,
            cb,
            None,
        )

    def remove_directory(self, remote_dir):
        """Get remove_directory (blocking)"""

        result_code = self._lib.mavsdk_ftp_remove_directory(
            self._handle,
            remote_dir.encode("utf-8") if isinstance(remote_dir, str) else remote_dir,
        )
        result = FtpResult(result_code)
        if result != FtpResult.SUCCESS:
            raise Exception(f"remove_directory failed: {result}")

        return result

    def remove_file_async(
        self, remote_file_path, callback: Callable, user_data: Any = None
    ):
        """Removes a remote file."""

        def c_callback(result, ud):
            try:
                py_result = FtpResult(result)

                callback(py_result, user_data)

            except Exception as e:
                print(f"Error in remove_file callback: {e}")

        cb = RemoveFileCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_ftp_remove_file_async(
            self._handle,
            remote_file_path.encode("utf-8")
            if isinstance(remote_file_path, str)
            else remote_file_path,
            cb,
            None,
        )

    def remove_file(self, remote_file_path):
        """Get remove_file (blocking)"""

        result_code = self._lib.mavsdk_ftp_remove_file(
            self._handle,
            remote_file_path.encode("utf-8")
            if isinstance(remote_file_path, str)
            else remote_file_path,
        )
        result = FtpResult(result_code)
        if result != FtpResult.SUCCESS:
            raise Exception(f"remove_file failed: {result}")

        return result

    def rename_async(
        self,
        remote_from_path,
        remote_to_path,
        callback: Callable,
        user_data: Any = None,
    ):
        """Renames a remote file or remote directory."""

        def c_callback(result, ud):
            try:
                py_result = FtpResult(result)

                callback(py_result, user_data)

            except Exception as e:
                print(f"Error in rename callback: {e}")

        cb = RenameCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_ftp_rename_async(
            self._handle,
            remote_from_path.encode("utf-8")
            if isinstance(remote_from_path, str)
            else remote_from_path,
            remote_to_path.encode("utf-8")
            if isinstance(remote_to_path, str)
            else remote_to_path,
            cb,
            None,
        )

    def rename(self, remote_from_path, remote_to_path):
        """Get rename (blocking)"""

        result_code = self._lib.mavsdk_ftp_rename(
            self._handle,
            remote_from_path.encode("utf-8")
            if isinstance(remote_from_path, str)
            else remote_from_path,
            remote_to_path.encode("utf-8")
            if isinstance(remote_to_path, str)
            else remote_to_path,
        )
        result = FtpResult(result_code)
        if result != FtpResult.SUCCESS:
            raise Exception(f"rename failed: {result}")

        return result

    def are_files_identical_async(
        self,
        local_file_path,
        remote_file_path,
        callback: Callable,
        user_data: Any = None,
    ):
        """Compares a local file to a remote file using a CRC32 checksum."""

        def c_callback(result, c_data, ud):
            try:
                py_result = FtpResult(result)

                py_data = c_data

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in are_files_identical callback: {e}")

        cb = AreFilesIdenticalCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_ftp_are_files_identical_async(
            self._handle,
            local_file_path.encode("utf-8")
            if isinstance(local_file_path, str)
            else local_file_path,
            remote_file_path.encode("utf-8")
            if isinstance(remote_file_path, str)
            else remote_file_path,
            cb,
            None,
        )

    def are_files_identical(self, local_file_path, remote_file_path):
        """Get are_files_identical (blocking)"""

        result_out = ctypes.c_bool()

        result_code = self._lib.mavsdk_ftp_are_files_identical(
            self._handle,
            local_file_path.encode("utf-8")
            if isinstance(local_file_path, str)
            else local_file_path,
            remote_file_path.encode("utf-8")
            if isinstance(remote_file_path, str)
            else remote_file_path,
            ctypes.byref(result_out),
        )
        result = FtpResult(result_code)
        if result != FtpResult.SUCCESS:
            raise Exception(f"are_files_identical failed: {result}")

        return result_out.value

    def set_target_compid(self, compid):
        """Get set_target_compid (blocking)"""

        result_code = self._lib.mavsdk_ftp_set_target_compid(
            self._handle,
            compid,
        )
        result = FtpResult(result_code)
        if result != FtpResult.SUCCESS:
            raise Exception(f"set_target_compid failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_ftp_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
DownloadCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ProgressDataCStruct, ctypes.c_void_p
)
UploadCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ProgressDataCStruct, ctypes.c_void_p
)
ListDirectoryCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ListDirectoryDataCStruct, ctypes.c_void_p
)
CreateDirectoryCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_void_p)
RemoveDirectoryCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_void_p)
RemoveFileCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_void_p)
RenameCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_void_p)
AreFilesIdenticalCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ctypes.c_bool, ctypes.c_void_p
)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_ftp_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_ftp_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_ftp_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_ftp_destroy.restype = None

_cmavsdk_lib.mavsdk_ftp_list_directory_data_destroy.argtypes = [
    ctypes.POINTER(ListDirectoryDataCStruct)
]
_cmavsdk_lib.mavsdk_ftp_list_directory_data_destroy.restype = None

_cmavsdk_lib.mavsdk_ftp_progress_data_destroy.argtypes = [
    ctypes.POINTER(ProgressDataCStruct)
]
_cmavsdk_lib.mavsdk_ftp_progress_data_destroy.restype = None


_cmavsdk_lib.mavsdk_ftp_download_async.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.c_char_p,
    ctypes.c_bool,
    DownloadCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_ftp_download_async.restype = None

_cmavsdk_lib.mavsdk_ftp_upload_async.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.c_char_p,
    UploadCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_ftp_upload_async.restype = None

_cmavsdk_lib.mavsdk_ftp_list_directory_async.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ListDirectoryCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_ftp_list_directory_async.restype = None

_cmavsdk_lib.mavsdk_ftp_list_directory.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.POINTER(ListDirectoryDataCStruct),
]

_cmavsdk_lib.mavsdk_ftp_list_directory.restype = ctypes.c_int
_cmavsdk_lib.mavsdk_ftp_create_directory_async.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    CreateDirectoryCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_ftp_create_directory_async.restype = None

_cmavsdk_lib.mavsdk_ftp_create_directory.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
]

_cmavsdk_lib.mavsdk_ftp_create_directory.restype = ctypes.c_int
_cmavsdk_lib.mavsdk_ftp_remove_directory_async.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    RemoveDirectoryCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_ftp_remove_directory_async.restype = None

_cmavsdk_lib.mavsdk_ftp_remove_directory.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
]

_cmavsdk_lib.mavsdk_ftp_remove_directory.restype = ctypes.c_int
_cmavsdk_lib.mavsdk_ftp_remove_file_async.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    RemoveFileCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_ftp_remove_file_async.restype = None

_cmavsdk_lib.mavsdk_ftp_remove_file.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
]

_cmavsdk_lib.mavsdk_ftp_remove_file.restype = ctypes.c_int
_cmavsdk_lib.mavsdk_ftp_rename_async.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.c_char_p,
    RenameCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_ftp_rename_async.restype = None

_cmavsdk_lib.mavsdk_ftp_rename.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.c_char_p,
]

_cmavsdk_lib.mavsdk_ftp_rename.restype = ctypes.c_int
_cmavsdk_lib.mavsdk_ftp_are_files_identical_async.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.c_char_p,
    AreFilesIdenticalCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_ftp_are_files_identical_async.restype = None

_cmavsdk_lib.mavsdk_ftp_are_files_identical.argtypes = [
    ctypes.c_void_p,
    ctypes.c_char_p,
    ctypes.c_char_p,
    ctypes.POINTER(ctypes.c_bool),
]

_cmavsdk_lib.mavsdk_ftp_are_files_identical.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_ftp_set_target_compid.argtypes = [
    ctypes.c_void_p,
    ctypes.c_uint32,
]

_cmavsdk_lib.mavsdk_ftp_set_target_compid.restype = ctypes.c_int
