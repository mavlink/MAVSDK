# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/log_files/log_files.proto)

"""
Allow to download log files from the vehicle after a flight is complete.
 For log streaming during flight check the logging plugin.
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====


# ===== Result Enums =====
class LogFilesResult(IntEnum):
    """Possible results returned for calibration commands"""

    UNKNOWN = 0
    SUCCESS = 1
    NEXT = 2
    NO_LOGFILES = 3
    TIMEOUT = 4
    INVALID_ARGUMENT = 5
    FILE_OPEN_FAILED = 6
    NO_SYSTEM = 7


# ===== Internal C Structures =====
class ProgressDataCStruct(ctypes.Structure):
    """
    Internal C structure for ProgressData.
    Used only for C library communication.
    """

    _fields_ = [
        ("progress", ctypes.c_float),
    ]


class EntryCStruct(ctypes.Structure):
    """
    Internal C structure for Entry.
    Used only for C library communication.
    """

    _fields_ = [
        ("id", ctypes.c_uint32),
        ("date", ctypes.c_char_p),
        ("size_bytes", ctypes.c_uint32),
    ]


# ===== Structures =====
class ProgressData:
    """
    Progress data coming when downloading a log file.
    """

    def __init__(self, progress=None):
        self.progress = progress

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.progress = c_struct.progress
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = ProgressDataCStruct()
        c_struct.progress = self.progress
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"progress={self.progress}")
        return f"ProgressData({', '.join(fields)})"


class Entry:
    """
    Log file entry type.
    """

    def __init__(self, id=None, date=None, size_bytes=None):
        self.id = id
        self.date = date
        self.size_bytes = size_bytes

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.id = c_struct.id
        instance.date = c_struct.date.decode("utf-8")
        instance.size_bytes = c_struct.size_bytes
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = EntryCStruct()
        c_struct.id = self.id
        c_struct.date = self.date.encode("utf-8")
        c_struct.size_bytes = self.size_bytes
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"id={self.id}")
        fields.append(f"date={self.date}")
        fields.append(f"size_bytes={self.size_bytes}")
        return f"Entry({', '.join(fields)})"


# ===== Plugin =====
class LogFiles:
    """Allow to download log files from the vehicle after a flight is complete.
    For log streaming during flight check the logging plugin."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_log_files_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create LogFiles plugin - C function returned null handle"
            )

    def get_entries_async(self, callback: Callable, user_data: Any = None):
        """Get List of log files."""

        def c_callback(result, c_data, size, ud):
            try:
                py_result = LogFilesResult(result)

                py_data = []
                if c_data and size.value > 0:
                    for i in range(size.value):
                        py_data.append(Entry.from_c_struct(c_data[i]))

                self._lib.mavsdk_log_files_entry_destroy(c_data)

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in get_entries callback: {e}")

        cb = GetEntriesCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_log_files_get_entries_async(self._handle, cb, None)

    def get_entries(self):
        """Get get_entries (blocking)"""

        result_ptr = ctypes.POINTER(EntryCStruct)()
        size = ctypes.c_size_t()

        result_code = self._lib.mavsdk_log_files_get_entries(
            self._handle, ctypes.byref(result_ptr), ctypes.byref(size)
        )
        result = LogFilesResult(result_code)
        if result != LogFilesResult.SUCCESS:
            raise Exception(f"get_entries failed: {result}")

        py_result = [Entry.from_c_struct(result_ptr[i]) for i in range(size.value)]
        self._lib.mavsdk_log_files_entry_destroy(result_ptr)
        return py_result

    def download_log_file_async(
        self, entry, path, callback: Callable, user_data: Any = None
    ):
        """Download log file."""

        def c_callback(result, c_data, ud):
            try:
                py_result = LogFilesResult(result)

                py_data = ProgressData.from_c_struct(c_data)

                self._lib.mavsdk_log_files_progress_data_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in download_log_file callback: {e}")

        cb = DownloadLogFileCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_log_files_download_log_file_async(
            self._handle, entry, path, cb, None
        )

    def erase_all_log_files(self):
        """Get erase_all_log_files (blocking)"""

        result_code = self._lib.mavsdk_log_files_erase_all_log_files(
            self._handle,
        )
        result = LogFilesResult(result_code)
        if result != LogFilesResult.SUCCESS:
            raise Exception(f"erase_all_log_files failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_log_files_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
GetEntriesCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ctypes.POINTER(EntryCStruct), ctypes.c_size_t, ctypes.c_void_p
)
DownloadLogFileCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ProgressDataCStruct, ctypes.c_void_p
)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_log_files_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_log_files_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_log_files_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_log_files_destroy.restype = None

_cmavsdk_lib.mavsdk_log_files_progress_data_destroy.argtypes = [
    ctypes.POINTER(ProgressDataCStruct)
]
_cmavsdk_lib.mavsdk_log_files_progress_data_destroy.restype = None

_cmavsdk_lib.mavsdk_log_files_entry_destroy.argtypes = [ctypes.POINTER(EntryCStruct)]
_cmavsdk_lib.mavsdk_log_files_entry_destroy.restype = None


_cmavsdk_lib.mavsdk_log_files_get_entries_async.argtypes = [
    ctypes.c_void_p,
    GetEntriesCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_log_files_get_entries_async.restype = None

_cmavsdk_lib.mavsdk_log_files_get_entries.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(ctypes.POINTER(EntryCStruct)),
    ctypes.POINTER(ctypes.c_size_t),
]

_cmavsdk_lib.mavsdk_log_files_get_entries.restype = ctypes.c_int
_cmavsdk_lib.mavsdk_log_files_download_log_file_async.argtypes = [
    ctypes.c_void_p,
    EntryCStruct,
    ctypes.c_char_p,
    DownloadLogFileCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_log_files_download_log_file_async.restype = None


_cmavsdk_lib.mavsdk_log_files_erase_all_log_files.argtypes = [
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_log_files_erase_all_log_files.restype = ctypes.c_int
