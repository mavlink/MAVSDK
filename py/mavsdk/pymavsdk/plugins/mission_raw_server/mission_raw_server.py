# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/mission_raw_server/mission_raw_server.proto)

"""
Acts as a vehicle and receives incoming missions from GCS (in raw MAVLINK format).
 Provides current mission item state, so the server can progress through missions.
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====


# ===== Result Enums =====
class MissionRawServerResult(IntEnum):
    """Possible results returned for action requests."""

    UNKNOWN = 0
    SUCCESS = 1
    ERROR = 2
    TOO_MANY_MISSION_ITEMS = 3
    BUSY = 4
    TIMEOUT = 5
    INVALID_ARGUMENT = 6
    UNSUPPORTED = 7
    NO_MISSION_AVAILABLE = 8
    UNSUPPORTED_MISSION_CMD = 9
    TRANSFER_CANCELLED = 10
    NO_SYSTEM = 11
    NEXT = 12


# ===== Internal C Structures =====
class MissionItemCStruct(ctypes.Structure):
    """
    Internal C structure for MissionItem.
    Used only for C library communication.
    """

    _fields_ = [
        ("seq", ctypes.c_uint32),
        ("frame", ctypes.c_uint32),
        ("command", ctypes.c_uint32),
        ("current", ctypes.c_uint32),
        ("autocontinue", ctypes.c_uint32),
        ("param1", ctypes.c_float),
        ("param2", ctypes.c_float),
        ("param3", ctypes.c_float),
        ("param4", ctypes.c_float),
        ("x", ctypes.c_int32),
        ("y", ctypes.c_int32),
        ("z", ctypes.c_float),
        ("mission_type", ctypes.c_uint32),
    ]


class MissionPlanCStruct(ctypes.Structure):
    """
    Internal C structure for MissionPlan.
    Used only for C library communication.
    """

    _fields_ = [
        ("mission_items", ctypes.POINTER(MissionItemCStruct)),
        ("mission_items_size", ctypes.c_size_t),
    ]


class MissionProgressCStruct(ctypes.Structure):
    """
    Internal C structure for MissionProgress.
    Used only for C library communication.
    """

    _fields_ = [
        ("current", ctypes.c_int32),
        ("total", ctypes.c_int32),
    ]


# ===== Structures =====
class MissionItem:
    """
    Mission item exactly identical to MAVLink MISSION_ITEM_INT.
    """

    def __init__(
        self,
        seq=None,
        frame=None,
        command=None,
        current=None,
        autocontinue=None,
        param1=None,
        param2=None,
        param3=None,
        param4=None,
        x=None,
        y=None,
        z=None,
        mission_type=None,
    ):
        self.seq = seq
        self.frame = frame
        self.command = command
        self.current = current
        self.autocontinue = autocontinue
        self.param1 = param1
        self.param2 = param2
        self.param3 = param3
        self.param4 = param4
        self.x = x
        self.y = y
        self.z = z
        self.mission_type = mission_type

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.seq = c_struct.seq
        instance.frame = c_struct.frame
        instance.command = c_struct.command
        instance.current = c_struct.current
        instance.autocontinue = c_struct.autocontinue
        instance.param1 = c_struct.param1
        instance.param2 = c_struct.param2
        instance.param3 = c_struct.param3
        instance.param4 = c_struct.param4
        instance.x = c_struct.x
        instance.y = c_struct.y
        instance.z = c_struct.z
        instance.mission_type = c_struct.mission_type
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = MissionItemCStruct()
        c_struct.seq = self.seq
        c_struct.frame = self.frame
        c_struct.command = self.command
        c_struct.current = self.current
        c_struct.autocontinue = self.autocontinue
        c_struct.param1 = self.param1
        c_struct.param2 = self.param2
        c_struct.param3 = self.param3
        c_struct.param4 = self.param4
        c_struct.x = self.x
        c_struct.y = self.y
        c_struct.z = self.z
        c_struct.mission_type = self.mission_type
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"seq={self.seq}")
        fields.append(f"frame={self.frame}")
        fields.append(f"command={self.command}")
        fields.append(f"current={self.current}")
        fields.append(f"autocontinue={self.autocontinue}")
        fields.append(f"param1={self.param1}")
        fields.append(f"param2={self.param2}")
        fields.append(f"param3={self.param3}")
        fields.append(f"param4={self.param4}")
        fields.append(f"x={self.x}")
        fields.append(f"y={self.y}")
        fields.append(f"z={self.z}")
        fields.append(f"mission_type={self.mission_type}")
        return f"MissionItem({', '.join(fields)})"


class MissionPlan:
    """
    Mission plan type
    """

    def __init__(self, mission_items=None):
        self.mission_items = mission_items or []

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        if c_struct.mission_items_size > 0:
            instance.mission_items = [
                MissionItem.from_c_struct(c_struct.mission_items[i])
                for i in range(c_struct.mission_items_size)
            ]
        else:
            instance.mission_items = []
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = MissionPlanCStruct()
        array_type = MissionItemCStruct * len(self.mission_items)
        c_array = array_type()
        for i, item in enumerate(self.mission_items):
            c_array[i] = item.to_c_struct()
        c_struct.mission_items = ctypes.cast(
            c_array, ctypes.POINTER(MissionItemCStruct)
        )
        c_struct.mission_items_size = len(self.mission_items)
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"mission_items={self.mission_items}")
        return f"MissionPlan({', '.join(fields)})"


class MissionProgress:
    """
    Mission progress type.
    """

    def __init__(self, current=None, total=None):
        self.current = current
        self.total = total

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.current = c_struct.current
        instance.total = c_struct.total
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = MissionProgressCStruct()
        c_struct.current = self.current
        c_struct.total = self.total
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"current={self.current}")
        fields.append(f"total={self.total}")
        return f"MissionProgress({', '.join(fields)})"


# ===== Plugin =====
class MissionRawServer:
    """Acts as a vehicle and receives incoming missions from GCS (in raw MAVLINK format).
    Provides current mission item state, so the server can progress through missions."""

    def __init__(self, server_component):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if server_component is None:
            raise ValueError("server_component cannot be None")

        component_handle = server_component._handle

        if not component_handle:
            raise ValueError("server_component handle is null")

        self._handle = self._lib.mavsdk_mission_raw_server_create(component_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create MissionRawServer plugin - C function returned null handle"
            )

    def subscribe_incoming_mission(self, callback: Callable, user_data: Any = None):
        """Subscribe to when a new mission is uploaded (asynchronous)."""

        def c_callback(result, c_data, ud):
            try:
                py_result = MissionRawServerResult(result)

                py_data = MissionPlan.from_c_struct(c_data)

                self._lib.mavsdk_mission_raw_server_mission_plan_destroy(
                    ctypes.byref(c_data)
                )

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in incoming_mission callback: {e}")

        cb = IncomingMissionCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_mission_raw_server_subscribe_incoming_mission(
            self._handle, cb, None
        )

    def unsubscribe_incoming_mission(self, handle: ctypes.c_void_p):
        """Unsubscribe from incoming_mission"""
        self._lib.mavsdk_mission_raw_server_unsubscribe_incoming_mission(
            self._handle, handle
        )

    def subscribe_current_item_changed(self, callback: Callable, user_data: Any = None):
        """Subscribe to when a new current item is set"""

        def c_callback(c_data, ud):
            try:
                py_data = MissionItem.from_c_struct(c_data)

                self._lib.mavsdk_mission_raw_server_mission_item_destroy(
                    ctypes.byref(c_data)
                )

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in current_item_changed callback: {e}")

        cb = CurrentItemChangedCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_mission_raw_server_subscribe_current_item_changed(
            self._handle, cb, None
        )

    def unsubscribe_current_item_changed(self, handle: ctypes.c_void_p):
        """Unsubscribe from current_item_changed"""
        self._lib.mavsdk_mission_raw_server_unsubscribe_current_item_changed(
            self._handle, handle
        )

    def set_current_item_complete(self):
        """Get set_current_item_complete (blocking)"""

        self._lib.mavsdk_mission_raw_server_set_current_item_complete(
            self._handle,
        )

    def subscribe_clear_all(self, callback: Callable, user_data: Any = None):
        """Subscribe when a MISSION_CLEAR_ALL is received"""

        def c_callback(c_data, ud):
            try:
                py_data = c_data

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in clear_all callback: {e}")

        cb = ClearAllCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_mission_raw_server_subscribe_clear_all(
            self._handle, cb, None
        )

    def unsubscribe_clear_all(self, handle: ctypes.c_void_p):
        """Unsubscribe from clear_all"""
        self._lib.mavsdk_mission_raw_server_unsubscribe_clear_all(self._handle, handle)

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_mission_raw_server_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
IncomingMissionCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, MissionPlanCStruct, ctypes.c_void_p
)
CurrentItemChangedCallback = ctypes.CFUNCTYPE(None, MissionItemCStruct, ctypes.c_void_p)
ClearAllCallback = ctypes.CFUNCTYPE(None, ctypes.c_uint32, ctypes.c_void_p)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_mission_raw_server_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_mission_raw_server_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_mission_raw_server_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_mission_raw_server_destroy.restype = None

_cmavsdk_lib.mavsdk_mission_raw_server_mission_item_destroy.argtypes = [
    ctypes.POINTER(MissionItemCStruct)
]
_cmavsdk_lib.mavsdk_mission_raw_server_mission_item_destroy.restype = None

_cmavsdk_lib.mavsdk_mission_raw_server_mission_plan_destroy.argtypes = [
    ctypes.POINTER(MissionPlanCStruct)
]
_cmavsdk_lib.mavsdk_mission_raw_server_mission_plan_destroy.restype = None

_cmavsdk_lib.mavsdk_mission_raw_server_mission_progress_destroy.argtypes = [
    ctypes.POINTER(MissionProgressCStruct)
]
_cmavsdk_lib.mavsdk_mission_raw_server_mission_progress_destroy.restype = None


_cmavsdk_lib.mavsdk_mission_raw_server_subscribe_incoming_mission.argtypes = [
    ctypes.c_void_p,
    IncomingMissionCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_mission_raw_server_subscribe_incoming_mission.restype = (
    ctypes.c_void_p
)
# Unsubscribe
_cmavsdk_lib.mavsdk_mission_raw_server_unsubscribe_incoming_mission.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_mission_raw_server_unsubscribe_incoming_mission.restype = None

_cmavsdk_lib.mavsdk_mission_raw_server_subscribe_current_item_changed.argtypes = [
    ctypes.c_void_p,
    CurrentItemChangedCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_mission_raw_server_subscribe_current_item_changed.restype = (
    ctypes.c_void_p
)
# Unsubscribe
_cmavsdk_lib.mavsdk_mission_raw_server_unsubscribe_current_item_changed.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_mission_raw_server_unsubscribe_current_item_changed.restype = None


_cmavsdk_lib.mavsdk_mission_raw_server_set_current_item_complete.argtypes = [
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_mission_raw_server_set_current_item_complete.restype = None
_cmavsdk_lib.mavsdk_mission_raw_server_subscribe_clear_all.argtypes = [
    ctypes.c_void_p,
    ClearAllCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_mission_raw_server_subscribe_clear_all.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_mission_raw_server_unsubscribe_clear_all.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_mission_raw_server_unsubscribe_clear_all.restype = None
