# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/calibration/calibration.proto)

"""
Enable to calibrate sensors of a drone such as gyro, accelerometer, and magnetometer.
"""

import atexit
import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====


# ===== Result Enums =====
class CalibrationResult(IntEnum):
    """Possible results returned for calibration commands"""

    UNKNOWN = 0
    SUCCESS = 1
    NEXT = 2
    FAILED = 3
    NO_SYSTEM = 4
    CONNECTION_ERROR = 5
    BUSY = 6
    COMMAND_DENIED = 7
    TIMEOUT = 8
    CANCELLED = 9
    FAILED_ARMED = 10
    UNSUPPORTED = 11


# ===== Internal C Structures =====
class ProgressDataCStruct(ctypes.Structure):
    """
    Internal C structure for ProgressData.
    Used only for C library communication.
    """

    _fields_ = [
        ("has_progress", ctypes.c_bool),
        ("progress", ctypes.c_float),
        ("has_status_text", ctypes.c_bool),
        ("status_text", ctypes.c_char_p),
    ]


# ===== Structures =====
class ProgressData:
    """
       Progress data coming from calibration.

    Can be a progress percentage, or an instruction text.
    """

    def __init__(
        self, has_progress=None, progress=None, has_status_text=None, status_text=None
    ):
        self.has_progress = has_progress
        self.progress = progress
        self.has_status_text = has_status_text
        self.status_text = status_text

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.has_progress = c_struct.has_progress
        instance.progress = c_struct.progress
        instance.has_status_text = c_struct.has_status_text
        instance.status_text = c_struct.status_text.decode("utf-8")
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = ProgressDataCStruct()
        c_struct.has_progress = self.has_progress
        c_struct.progress = self.progress
        c_struct.has_status_text = self.has_status_text
        c_struct.status_text = self.status_text.encode("utf-8")
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"has_progress={self.has_progress}")
        fields.append(f"progress={self.progress}")
        fields.append(f"has_status_text={self.has_status_text}")
        fields.append(f"status_text={self.status_text}")
        return f"ProgressData({', '.join(fields)})"


# ===== Plugin =====
class Calibration:
    """Enable to calibrate sensors of a drone such as gyro, accelerometer, and magnetometer."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_calibration_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create Calibration plugin - C function returned null handle"
            )

        atexit.register(self.destroy)

    def calibrate_gyro_async(self, callback: Callable, user_data: Any = None):
        """Perform gyro calibration."""

        def c_callback(result, c_data, ud):
            try:
                py_result = CalibrationResult(result)

                py_data = ProgressData.from_c_struct(c_data)

                self._lib.mavsdk_calibration_progress_data_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in calibrate_gyro callback: {e}")

        cb = CalibrateGyroCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_calibration_calibrate_gyro_async(self._handle, cb, None)

    def calibrate_accelerometer_async(self, callback: Callable, user_data: Any = None):
        """Perform accelerometer calibration."""

        def c_callback(result, c_data, ud):
            try:
                py_result = CalibrationResult(result)

                py_data = ProgressData.from_c_struct(c_data)

                self._lib.mavsdk_calibration_progress_data_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in calibrate_accelerometer callback: {e}")

        cb = CalibrateAccelerometerCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_calibration_calibrate_accelerometer_async(
            self._handle, cb, None
        )

    def calibrate_magnetometer_async(self, callback: Callable, user_data: Any = None):
        """Perform magnetometer calibration."""

        def c_callback(result, c_data, ud):
            try:
                py_result = CalibrationResult(result)

                py_data = ProgressData.from_c_struct(c_data)

                self._lib.mavsdk_calibration_progress_data_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in calibrate_magnetometer callback: {e}")

        cb = CalibrateMagnetometerCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_calibration_calibrate_magnetometer_async(
            self._handle, cb, None
        )

    def calibrate_level_horizon_async(self, callback: Callable, user_data: Any = None):
        """Perform board level horizon calibration."""

        def c_callback(result, c_data, ud):
            try:
                py_result = CalibrationResult(result)

                py_data = ProgressData.from_c_struct(c_data)

                self._lib.mavsdk_calibration_progress_data_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in calibrate_level_horizon callback: {e}")

        cb = CalibrateLevelHorizonCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_calibration_calibrate_level_horizon_async(
            self._handle, cb, None
        )

    def calibrate_gimbal_accelerometer_async(
        self, callback: Callable, user_data: Any = None
    ):
        """Perform gimbal accelerometer calibration."""

        def c_callback(result, c_data, ud):
            try:
                py_result = CalibrationResult(result)

                py_data = ProgressData.from_c_struct(c_data)

                self._lib.mavsdk_calibration_progress_data_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in calibrate_gimbal_accelerometer callback: {e}")

        cb = CalibrateGimbalAccelerometerCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_calibration_calibrate_gimbal_accelerometer_async(
            self._handle, cb, None
        )

    def cancel(self):
        """Get cancel (blocking)"""

        result_code = self._lib.mavsdk_calibration_cancel(
            self._handle,
        )
        result = CalibrationResult(result_code)
        if result != CalibrationResult.SUCCESS:
            raise Exception(f"cancel failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_calibration_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
CalibrateGyroCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ProgressDataCStruct, ctypes.c_void_p
)
CalibrateAccelerometerCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ProgressDataCStruct, ctypes.c_void_p
)
CalibrateMagnetometerCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ProgressDataCStruct, ctypes.c_void_p
)
CalibrateLevelHorizonCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ProgressDataCStruct, ctypes.c_void_p
)
CalibrateGimbalAccelerometerCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ProgressDataCStruct, ctypes.c_void_p
)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_calibration_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_calibration_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_calibration_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_calibration_destroy.restype = None

_cmavsdk_lib.mavsdk_calibration_progress_data_destroy.argtypes = [
    ctypes.POINTER(ProgressDataCStruct)
]
_cmavsdk_lib.mavsdk_calibration_progress_data_destroy.restype = None


_cmavsdk_lib.mavsdk_calibration_calibrate_gyro_async.argtypes = [
    ctypes.c_void_p,
    CalibrateGyroCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_calibration_calibrate_gyro_async.restype = None

_cmavsdk_lib.mavsdk_calibration_calibrate_accelerometer_async.argtypes = [
    ctypes.c_void_p,
    CalibrateAccelerometerCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_calibration_calibrate_accelerometer_async.restype = None

_cmavsdk_lib.mavsdk_calibration_calibrate_magnetometer_async.argtypes = [
    ctypes.c_void_p,
    CalibrateMagnetometerCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_calibration_calibrate_magnetometer_async.restype = None

_cmavsdk_lib.mavsdk_calibration_calibrate_level_horizon_async.argtypes = [
    ctypes.c_void_p,
    CalibrateLevelHorizonCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_calibration_calibrate_level_horizon_async.restype = None

_cmavsdk_lib.mavsdk_calibration_calibrate_gimbal_accelerometer_async.argtypes = [
    ctypes.c_void_p,
    CalibrateGimbalAccelerometerCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_calibration_calibrate_gimbal_accelerometer_async.restype = None


_cmavsdk_lib.mavsdk_calibration_cancel.argtypes = [
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_calibration_cancel.restype = ctypes.c_int
