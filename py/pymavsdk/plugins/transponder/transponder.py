# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/transponder/transponder.proto)

"""
Allow users to get ADS-B information
 and set ADS-B update rates.
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====
class AdsbEmitterType(IntEnum):
    """ADSB classification for the type of vehicle emitting the transponder signal."""

    NO_INFO = 0
    LIGHT = 1
    SMALL = 2
    LARGE = 3
    HIGH_VORTEX_LARGE = 4
    HEAVY = 5
    HIGHLY_MANUV = 6
    ROTOCRAFT = 7
    UNASSIGNED = 8
    GLIDER = 9
    LIGHTER_AIR = 10
    PARACHUTE = 11
    ULTRA_LIGHT = 12
    UNASSIGNED2 = 13
    UAV = 14
    SPACE = 15
    UNASSGINED3 = 16
    EMERGENCY_SURFACE = 17
    SERVICE_SURFACE = 18
    POINT_OBSTACLE = 19


class AdsbAltitudeType(IntEnum):
    """Altitude type used in AdsbVehicle message"""

    PRESSURE_QNH = 0
    GEOMETRIC = 1


# ===== Result Enums =====
class TransponderResult(IntEnum):
    """Possible results returned for transponder requests."""

    UNKNOWN = 0
    SUCCESS = 1
    NO_SYSTEM = 2
    CONNECTION_ERROR = 3
    BUSY = 4
    COMMAND_DENIED = 5
    TIMEOUT = 6


# ===== Internal C Structures =====
class AdsbVehicleCStruct(ctypes.Structure):
    """
    Internal C structure for AdsbVehicle.
    Used only for C library communication.
    """

    _fields_ = [
        ("icao_address", ctypes.c_uint32),
        ("latitude_deg", ctypes.c_double),
        ("longitude_deg", ctypes.c_double),
        ("altitude_type", ctypes.c_int),
        ("absolute_altitude_m", ctypes.c_float),
        ("heading_deg", ctypes.c_float),
        ("horizontal_velocity_m_s", ctypes.c_float),
        ("vertical_velocity_m_s", ctypes.c_float),
        ("callsign", ctypes.c_char_p),
        ("emitter_type", ctypes.c_int),
        ("squawk", ctypes.c_uint32),
        ("tslc_s", ctypes.c_uint32),
    ]


# ===== Structures =====
class AdsbVehicle:
    """
    ADSB Vehicle type.
    """

    def __init__(
        self,
        icao_address=None,
        latitude_deg=None,
        longitude_deg=None,
        altitude_type=None,
        absolute_altitude_m=None,
        heading_deg=None,
        horizontal_velocity_m_s=None,
        vertical_velocity_m_s=None,
        callsign=None,
        emitter_type=None,
        squawk=None,
        tslc_s=None,
    ):
        self.icao_address = icao_address
        self.latitude_deg = latitude_deg
        self.longitude_deg = longitude_deg
        self.altitude_type = altitude_type
        self.absolute_altitude_m = absolute_altitude_m
        self.heading_deg = heading_deg
        self.horizontal_velocity_m_s = horizontal_velocity_m_s
        self.vertical_velocity_m_s = vertical_velocity_m_s
        self.callsign = callsign
        self.emitter_type = emitter_type
        self.squawk = squawk
        self.tslc_s = tslc_s

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.icao_address = c_struct.icao_address
        instance.latitude_deg = c_struct.latitude_deg
        instance.longitude_deg = c_struct.longitude_deg
        instance.altitude_type = AdsbAltitudeType(c_struct.altitude_type)
        instance.absolute_altitude_m = c_struct.absolute_altitude_m
        instance.heading_deg = c_struct.heading_deg
        instance.horizontal_velocity_m_s = c_struct.horizontal_velocity_m_s
        instance.vertical_velocity_m_s = c_struct.vertical_velocity_m_s
        instance.callsign = c_struct.callsign.decode("utf-8")
        instance.emitter_type = AdsbEmitterType(c_struct.emitter_type)
        instance.squawk = c_struct.squawk
        instance.tslc_s = c_struct.tslc_s
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = AdsbVehicleCStruct()
        c_struct.icao_address = self.icao_address
        c_struct.latitude_deg = self.latitude_deg
        c_struct.longitude_deg = self.longitude_deg
        c_struct.altitude_type = int(self.altitude_type)
        c_struct.absolute_altitude_m = self.absolute_altitude_m
        c_struct.heading_deg = self.heading_deg
        c_struct.horizontal_velocity_m_s = self.horizontal_velocity_m_s
        c_struct.vertical_velocity_m_s = self.vertical_velocity_m_s
        c_struct.callsign = self.callsign.encode("utf-8")
        c_struct.emitter_type = int(self.emitter_type)
        c_struct.squawk = self.squawk
        c_struct.tslc_s = self.tslc_s
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"icao_address={self.icao_address}")
        fields.append(f"latitude_deg={self.latitude_deg}")
        fields.append(f"longitude_deg={self.longitude_deg}")
        fields.append(f"altitude_type={self.altitude_type}")
        fields.append(f"absolute_altitude_m={self.absolute_altitude_m}")
        fields.append(f"heading_deg={self.heading_deg}")
        fields.append(f"horizontal_velocity_m_s={self.horizontal_velocity_m_s}")
        fields.append(f"vertical_velocity_m_s={self.vertical_velocity_m_s}")
        fields.append(f"callsign={self.callsign}")
        fields.append(f"emitter_type={self.emitter_type}")
        fields.append(f"squawk={self.squawk}")
        fields.append(f"tslc_s={self.tslc_s}")
        return f"AdsbVehicle({', '.join(fields)})"


# ===== Plugin =====
class Transponder:
    """Allow users to get ADS-B information
    and set ADS-B update rates."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_transponder_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create Transponder plugin - C function returned null handle"
            )

    def subscribe_transponder(self, callback: Callable, user_data: Any = None):
        """Subscribe to 'transponder' updates."""

        def c_callback(c_data, ud):
            try:
                py_data = AdsbVehicle.from_c_struct(c_data)

                self._lib.mavsdk_transponder_adsb_vehicle_destroy(ctypes.byref(c_data))

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in transponder callback: {e}")

        cb = TransponderCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_transponder_subscribe_transponder(
            self._handle, cb, None
        )

    def unsubscribe_transponder(self, handle: ctypes.c_void_p):
        """Unsubscribe from transponder"""
        self._lib.mavsdk_transponder_unsubscribe_transponder(self._handle, handle)

    def transponder(self):
        """Get transponder (blocking)"""

        result_out = AdsbVehicleCStruct()

        self._lib.mavsdk_transponder_transponder(self._handle, ctypes.byref(result_out))

        py_result = AdsbVehicle.from_c_struct(result_out)
        self._lib.mavsdk_transponder_adsb_vehicle_destroy(ctypes.byref(result_out))
        return py_result

    def set_rate_transponder_async(
        self, rate_hz, callback: Callable, user_data: Any = None
    ):
        """Set rate to 'transponder' updates."""

        def c_callback(result, ud):
            try:
                py_result = TransponderResult(result)

                callback(py_result, user_data)

            except Exception as e:
                print(f"Error in set_rate_transponder callback: {e}")

        cb = SetRateTransponderCallback(c_callback)
        self._callbacks.append(cb)

        self._lib.mavsdk_transponder_set_rate_transponder_async(
            self._handle, rate_hz, cb, None
        )

    def set_rate_transponder(self, rate_hz):
        """Get set_rate_transponder (blocking)"""

        result_code = self._lib.mavsdk_transponder_set_rate_transponder(
            self._handle,
            rate_hz,
        )
        result = TransponderResult(result_code)
        if result != TransponderResult.SUCCESS:
            raise Exception(f"set_rate_transponder failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_transponder_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
TransponderCallback = ctypes.CFUNCTYPE(None, AdsbVehicleCStruct, ctypes.c_void_p)
SetRateTransponderCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_void_p)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_transponder_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_transponder_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_transponder_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_transponder_destroy.restype = None

_cmavsdk_lib.mavsdk_transponder_adsb_vehicle_destroy.argtypes = [
    ctypes.POINTER(AdsbVehicleCStruct)
]
_cmavsdk_lib.mavsdk_transponder_adsb_vehicle_destroy.restype = None


_cmavsdk_lib.mavsdk_transponder_subscribe_transponder.argtypes = [
    ctypes.c_void_p,
    TransponderCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_transponder_subscribe_transponder.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_transponder_unsubscribe_transponder.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_transponder_unsubscribe_transponder.restype = None

_cmavsdk_lib.mavsdk_transponder_transponder.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(AdsbVehicleCStruct),
]

_cmavsdk_lib.mavsdk_transponder_transponder.restype = None
_cmavsdk_lib.mavsdk_transponder_set_rate_transponder_async.argtypes = [
    ctypes.c_void_p,
    ctypes.c_double,
    SetRateTransponderCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_transponder_set_rate_transponder_async.restype = None

_cmavsdk_lib.mavsdk_transponder_set_rate_transponder.argtypes = [
    ctypes.c_void_p,
    ctypes.c_double,
]

_cmavsdk_lib.mavsdk_transponder_set_rate_transponder.restype = ctypes.c_int
