# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/action_server/action_server.proto)

"""
Provide vehicle actions (as a server) such as arming, taking off, and landing.
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====
class FlightMode(IntEnum):
    """Flight modes.

    For more information about flight modes, check out
    https://docs.px4.io/main/en/config/flight_mode.html."""

    UNKNOWN = 0
    READY = 1
    TAKEOFF = 2
    HOLD = 3
    MISSION = 4
    RETURN_TO_LAUNCH = 5
    LAND = 6
    OFFBOARD = 7
    FOLLOW_ME = 8
    MANUAL = 9
    ALTCTL = 10
    POSCTL = 11
    ACRO = 12
    STABILIZED = 13


# ===== Result Enums =====
class ActionServerResult(IntEnum):
    """Possible results returned for action requests."""

    UNKNOWN = 0
    SUCCESS = 1
    NO_SYSTEM = 2
    CONNECTION_ERROR = 3
    BUSY = 4
    COMMAND_DENIED = 5
    COMMAND_DENIED_LANDED_STATE_UNKNOWN = 6
    COMMAND_DENIED_NOT_LANDED = 7
    TIMEOUT = 8
    VTOL_TRANSITION_SUPPORT_UNKNOWN = 9
    NO_VTOL_TRANSITION_SUPPORT = 10
    PARAMETER_ERROR = 11
    NEXT = 12


# ===== Internal C Structures =====
class AllowableFlightModesCStruct(ctypes.Structure):
    """
    Internal C structure for AllowableFlightModes.
    Used only for C library communication.
    """

    _fields_ = [
        ("can_auto_mode", ctypes.c_bool),
        ("can_guided_mode", ctypes.c_bool),
        ("can_stabilize_mode", ctypes.c_bool),
        ("can_auto_rtl_mode", ctypes.c_bool),
        ("can_auto_takeoff_mode", ctypes.c_bool),
        ("can_auto_land_mode", ctypes.c_bool),
        ("can_auto_loiter_mode", ctypes.c_bool),
    ]


class ArmDisarmCStruct(ctypes.Structure):
    """
    Internal C structure for ArmDisarm.
    Used only for C library communication.
    """

    _fields_ = [
        ("arm", ctypes.c_bool),
        ("force", ctypes.c_bool),
    ]


# ===== Structures =====
class AllowableFlightModes:
    """
       State to check if the vehicle can transition to
    respective flightmodes
    """

    def __init__(
        self,
        can_auto_mode=None,
        can_guided_mode=None,
        can_stabilize_mode=None,
        can_auto_rtl_mode=None,
        can_auto_takeoff_mode=None,
        can_auto_land_mode=None,
        can_auto_loiter_mode=None,
    ):
        self.can_auto_mode = can_auto_mode
        self.can_guided_mode = can_guided_mode
        self.can_stabilize_mode = can_stabilize_mode
        self.can_auto_rtl_mode = can_auto_rtl_mode
        self.can_auto_takeoff_mode = can_auto_takeoff_mode
        self.can_auto_land_mode = can_auto_land_mode
        self.can_auto_loiter_mode = can_auto_loiter_mode

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.can_auto_mode = c_struct.can_auto_mode
        instance.can_guided_mode = c_struct.can_guided_mode
        instance.can_stabilize_mode = c_struct.can_stabilize_mode
        instance.can_auto_rtl_mode = c_struct.can_auto_rtl_mode
        instance.can_auto_takeoff_mode = c_struct.can_auto_takeoff_mode
        instance.can_auto_land_mode = c_struct.can_auto_land_mode
        instance.can_auto_loiter_mode = c_struct.can_auto_loiter_mode
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = AllowableFlightModesCStruct()
        c_struct.can_auto_mode = self.can_auto_mode
        c_struct.can_guided_mode = self.can_guided_mode
        c_struct.can_stabilize_mode = self.can_stabilize_mode
        c_struct.can_auto_rtl_mode = self.can_auto_rtl_mode
        c_struct.can_auto_takeoff_mode = self.can_auto_takeoff_mode
        c_struct.can_auto_land_mode = self.can_auto_land_mode
        c_struct.can_auto_loiter_mode = self.can_auto_loiter_mode
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"can_auto_mode={self.can_auto_mode}")
        fields.append(f"can_guided_mode={self.can_guided_mode}")
        fields.append(f"can_stabilize_mode={self.can_stabilize_mode}")
        fields.append(f"can_auto_rtl_mode={self.can_auto_rtl_mode}")
        fields.append(f"can_auto_takeoff_mode={self.can_auto_takeoff_mode}")
        fields.append(f"can_auto_land_mode={self.can_auto_land_mode}")
        fields.append(f"can_auto_loiter_mode={self.can_auto_loiter_mode}")
        return f"AllowableFlightModes({', '.join(fields)})"


class ArmDisarm:
    """
    Arming message type
    """

    def __init__(self, arm=None, force=None):
        self.arm = arm
        self.force = force

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.arm = c_struct.arm
        instance.force = c_struct.force
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = ArmDisarmCStruct()
        c_struct.arm = self.arm
        c_struct.force = self.force
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"arm={self.arm}")
        fields.append(f"force={self.force}")
        return f"ArmDisarm({', '.join(fields)})"


# ===== Plugin =====
class ActionServer:
    """Provide vehicle actions (as a server) such as arming, taking off, and landing."""

    def __init__(self, server_component):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if server_component is None:
            raise ValueError("server_component cannot be None")

        component_handle = server_component._handle

        if not component_handle:
            raise ValueError("server_component handle is null")

        self._handle = self._lib.mavsdk_action_server_create(component_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create ActionServer plugin - C function returned null handle"
            )

    def subscribe_arm_disarm(self, callback: Callable, user_data: Any = None):
        """Subscribe to ARM/DISARM commands"""

        def c_callback(result, c_data, ud):
            try:
                py_result = ActionServerResult(result)

                py_data = ArmDisarm.from_c_struct(c_data)

                self._lib.mavsdk_action_server_arm_disarm_destroy(ctypes.byref(c_data))

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in arm_disarm callback: {e}")

        cb = ArmDisarmCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_action_server_subscribe_arm_disarm(
            self._handle, cb, None
        )

    def unsubscribe_arm_disarm(self, handle: ctypes.c_void_p):
        """Unsubscribe from arm_disarm"""
        self._lib.mavsdk_action_server_unsubscribe_arm_disarm(self._handle, handle)

    def subscribe_flight_mode_change(self, callback: Callable, user_data: Any = None):
        """Subscribe to DO_SET_MODE"""

        def c_callback(result, c_data, ud):
            try:
                py_result = ActionServerResult(result)

                py_data = FlightMode(c_data)

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in flight_mode_change callback: {e}")

        cb = FlightModeChangeCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_action_server_subscribe_flight_mode_change(
            self._handle, cb, None
        )

    def unsubscribe_flight_mode_change(self, handle: ctypes.c_void_p):
        """Unsubscribe from flight_mode_change"""
        self._lib.mavsdk_action_server_unsubscribe_flight_mode_change(
            self._handle, handle
        )

    def subscribe_takeoff(self, callback: Callable, user_data: Any = None):
        """Subscribe to takeoff command"""

        def c_callback(result, c_data, ud):
            try:
                py_result = ActionServerResult(result)

                py_data = c_data

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in takeoff callback: {e}")

        cb = TakeoffCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_action_server_subscribe_takeoff(self._handle, cb, None)

    def unsubscribe_takeoff(self, handle: ctypes.c_void_p):
        """Unsubscribe from takeoff"""
        self._lib.mavsdk_action_server_unsubscribe_takeoff(self._handle, handle)

    def subscribe_land(self, callback: Callable, user_data: Any = None):
        """Subscribe to land command"""

        def c_callback(result, c_data, ud):
            try:
                py_result = ActionServerResult(result)

                py_data = c_data

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in land callback: {e}")

        cb = LandCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_action_server_subscribe_land(self._handle, cb, None)

    def unsubscribe_land(self, handle: ctypes.c_void_p):
        """Unsubscribe from land"""
        self._lib.mavsdk_action_server_unsubscribe_land(self._handle, handle)

    def subscribe_reboot(self, callback: Callable, user_data: Any = None):
        """Subscribe to reboot command"""

        def c_callback(result, c_data, ud):
            try:
                py_result = ActionServerResult(result)

                py_data = c_data

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in reboot callback: {e}")

        cb = RebootCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_action_server_subscribe_reboot(self._handle, cb, None)

    def unsubscribe_reboot(self, handle: ctypes.c_void_p):
        """Unsubscribe from reboot"""
        self._lib.mavsdk_action_server_unsubscribe_reboot(self._handle, handle)

    def subscribe_shutdown(self, callback: Callable, user_data: Any = None):
        """Subscribe to shutdown command"""

        def c_callback(result, c_data, ud):
            try:
                py_result = ActionServerResult(result)

                py_data = c_data

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in shutdown callback: {e}")

        cb = ShutdownCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_action_server_subscribe_shutdown(self._handle, cb, None)

    def unsubscribe_shutdown(self, handle: ctypes.c_void_p):
        """Unsubscribe from shutdown"""
        self._lib.mavsdk_action_server_unsubscribe_shutdown(self._handle, handle)

    def subscribe_terminate(self, callback: Callable, user_data: Any = None):
        """Subscribe to terminate command"""

        def c_callback(result, c_data, ud):
            try:
                py_result = ActionServerResult(result)

                py_data = c_data

                callback(py_result, py_data, user_data)

            except Exception as e:
                print(f"Error in terminate callback: {e}")

        cb = TerminateCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_action_server_subscribe_terminate(
            self._handle, cb, None
        )

    def unsubscribe_terminate(self, handle: ctypes.c_void_p):
        """Unsubscribe from terminate"""
        self._lib.mavsdk_action_server_unsubscribe_terminate(self._handle, handle)

    def set_allow_takeoff(self, allow_takeoff):
        """Get set_allow_takeoff (blocking)"""

        result_code = self._lib.mavsdk_action_server_set_allow_takeoff(
            self._handle,
            allow_takeoff,
        )
        result = ActionServerResult(result_code)
        if result != ActionServerResult.SUCCESS:
            raise Exception(f"set_allow_takeoff failed: {result}")

        return result

    def set_armable(self, armable, force_armable):
        """Get set_armable (blocking)"""

        result_code = self._lib.mavsdk_action_server_set_armable(
            self._handle,
            armable,
            force_armable,
        )
        result = ActionServerResult(result_code)
        if result != ActionServerResult.SUCCESS:
            raise Exception(f"set_armable failed: {result}")

        return result

    def set_disarmable(self, disarmable, force_disarmable):
        """Get set_disarmable (blocking)"""

        result_code = self._lib.mavsdk_action_server_set_disarmable(
            self._handle,
            disarmable,
            force_disarmable,
        )
        result = ActionServerResult(result_code)
        if result != ActionServerResult.SUCCESS:
            raise Exception(f"set_disarmable failed: {result}")

        return result

    def set_allowable_flight_modes(self, flight_modes):
        """Get set_allowable_flight_modes (blocking)"""

        result_code = self._lib.mavsdk_action_server_set_allowable_flight_modes(
            self._handle,
            flight_modes.to_c_struct(),
        )
        result = ActionServerResult(result_code)
        if result != ActionServerResult.SUCCESS:
            raise Exception(f"set_allowable_flight_modes failed: {result}")

        return result

    def get_allowable_flight_modes(self):
        """Get get_allowable_flight_modes (blocking)"""

        result_out = AllowableFlightModesCStruct()

        self._lib.mavsdk_action_server_get_allowable_flight_modes(
            self._handle, ctypes.byref(result_out)
        )

        py_result = AllowableFlightModes.from_c_struct(result_out)
        self._lib.mavsdk_action_server_allowable_flight_modes_destroy(
            ctypes.byref(result_out)
        )
        return py_result

    def set_armed_state(self, is_armed):
        """Get set_armed_state (blocking)"""

        result_code = self._lib.mavsdk_action_server_set_armed_state(
            self._handle,
            is_armed,
        )
        result = ActionServerResult(result_code)
        if result != ActionServerResult.SUCCESS:
            raise Exception(f"set_armed_state failed: {result}")

        return result

    def set_flight_mode(self, flight_mode):
        """Get set_flight_mode (blocking)"""

        result_code = self._lib.mavsdk_action_server_set_flight_mode(
            self._handle,
            flight_mode,
        )
        result = ActionServerResult(result_code)
        if result != ActionServerResult.SUCCESS:
            raise Exception(f"set_flight_mode failed: {result}")

        return result

    def set_flight_mode_internal(self, flight_mode):
        """Get set_flight_mode_internal (blocking)"""

        result_code = self._lib.mavsdk_action_server_set_flight_mode_internal(
            self._handle,
            flight_mode,
        )
        result = ActionServerResult(result_code)
        if result != ActionServerResult.SUCCESS:
            raise Exception(f"set_flight_mode_internal failed: {result}")

        return result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_action_server_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
ArmDisarmCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ArmDisarmCStruct, ctypes.c_void_p
)
FlightModeChangeCallback = ctypes.CFUNCTYPE(
    None, ctypes.c_int, ctypes.c_int, ctypes.c_void_p
)
TakeoffCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_bool, ctypes.c_void_p)
LandCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_bool, ctypes.c_void_p)
RebootCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_bool, ctypes.c_void_p)
ShutdownCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_bool, ctypes.c_void_p)
TerminateCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_bool, ctypes.c_void_p)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_action_server_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_action_server_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_action_server_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_action_server_destroy.restype = None

_cmavsdk_lib.mavsdk_action_server_allowable_flight_modes_destroy.argtypes = [
    ctypes.POINTER(AllowableFlightModesCStruct)
]
_cmavsdk_lib.mavsdk_action_server_allowable_flight_modes_destroy.restype = None

_cmavsdk_lib.mavsdk_action_server_arm_disarm_destroy.argtypes = [
    ctypes.POINTER(ArmDisarmCStruct)
]
_cmavsdk_lib.mavsdk_action_server_arm_disarm_destroy.restype = None


_cmavsdk_lib.mavsdk_action_server_subscribe_arm_disarm.argtypes = [
    ctypes.c_void_p,
    ArmDisarmCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_subscribe_arm_disarm.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_action_server_unsubscribe_arm_disarm.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_unsubscribe_arm_disarm.restype = None

_cmavsdk_lib.mavsdk_action_server_subscribe_flight_mode_change.argtypes = [
    ctypes.c_void_p,
    FlightModeChangeCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_subscribe_flight_mode_change.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_action_server_unsubscribe_flight_mode_change.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_unsubscribe_flight_mode_change.restype = None

_cmavsdk_lib.mavsdk_action_server_subscribe_takeoff.argtypes = [
    ctypes.c_void_p,
    TakeoffCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_subscribe_takeoff.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_action_server_unsubscribe_takeoff.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_unsubscribe_takeoff.restype = None

_cmavsdk_lib.mavsdk_action_server_subscribe_land.argtypes = [
    ctypes.c_void_p,
    LandCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_subscribe_land.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_action_server_unsubscribe_land.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_unsubscribe_land.restype = None

_cmavsdk_lib.mavsdk_action_server_subscribe_reboot.argtypes = [
    ctypes.c_void_p,
    RebootCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_subscribe_reboot.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_action_server_unsubscribe_reboot.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_unsubscribe_reboot.restype = None

_cmavsdk_lib.mavsdk_action_server_subscribe_shutdown.argtypes = [
    ctypes.c_void_p,
    ShutdownCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_subscribe_shutdown.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_action_server_unsubscribe_shutdown.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_unsubscribe_shutdown.restype = None

_cmavsdk_lib.mavsdk_action_server_subscribe_terminate.argtypes = [
    ctypes.c_void_p,
    TerminateCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_subscribe_terminate.restype = ctypes.c_void_p
# Unsubscribe
_cmavsdk_lib.mavsdk_action_server_unsubscribe_terminate.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_action_server_unsubscribe_terminate.restype = None


_cmavsdk_lib.mavsdk_action_server_set_allow_takeoff.argtypes = [
    ctypes.c_void_p,
    ctypes.c_bool,
]

_cmavsdk_lib.mavsdk_action_server_set_allow_takeoff.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_action_server_set_armable.argtypes = [
    ctypes.c_void_p,
    ctypes.c_bool,
    ctypes.c_bool,
]

_cmavsdk_lib.mavsdk_action_server_set_armable.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_action_server_set_disarmable.argtypes = [
    ctypes.c_void_p,
    ctypes.c_bool,
    ctypes.c_bool,
]

_cmavsdk_lib.mavsdk_action_server_set_disarmable.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_action_server_set_allowable_flight_modes.argtypes = [
    ctypes.c_void_p,
    AllowableFlightModesCStruct,
]

_cmavsdk_lib.mavsdk_action_server_set_allowable_flight_modes.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_action_server_get_allowable_flight_modes.argtypes = [
    ctypes.c_void_p,
    ctypes.POINTER(AllowableFlightModesCStruct),
]

_cmavsdk_lib.mavsdk_action_server_get_allowable_flight_modes.restype = None

_cmavsdk_lib.mavsdk_action_server_set_armed_state.argtypes = [
    ctypes.c_void_p,
    ctypes.c_bool,
]

_cmavsdk_lib.mavsdk_action_server_set_armed_state.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_action_server_set_flight_mode.argtypes = [
    ctypes.c_void_p,
    ctypes.c_int,
]

_cmavsdk_lib.mavsdk_action_server_set_flight_mode.restype = ctypes.c_int

_cmavsdk_lib.mavsdk_action_server_set_flight_mode_internal.argtypes = [
    ctypes.c_void_p,
    ctypes.c_int,
]

_cmavsdk_lib.mavsdk_action_server_set_flight_mode_internal.restype = ctypes.c_int
