# ruff: noqa: F401

# WARNING: THIS FILE IS AUTOGENERATED! As such, it should not be edited.
# Edits need to be made to the proto files
# (see https://github.com/mavlink/MAVSDK-Proto/blob/main/protos/component_metadata/component_metadata.proto)

"""
Access component metadata json definitions, such as parameters.
"""

import ctypes

from typing import Callable, Any
from enum import IntEnum

from ...cmavsdk_loader import _cmavsdk_lib


# ===== Enums =====
class MetadataType(IntEnum):
    """The metadata type"""

    ALL_COMPLETED = 0
    PARAMETER = 1
    EVENTS = 2
    ACTUATORS = 3


# ===== Result Enums =====
class ComponentMetadataResult(IntEnum):
    """Possible results returned"""

    SUCCESS = 0
    NOT_AVAILABLE = 1
    CONNECTION_ERROR = 2
    UNSUPPORTED = 3
    DENIED = 4
    FAILED = 5
    TIMEOUT = 6
    NO_SYSTEM = 7
    NOT_REQUESTED = 8


# ===== Internal C Structures =====
class MetadataDataCStruct(ctypes.Structure):
    """
    Internal C structure for MetadataData.
    Used only for C library communication.
    """

    _fields_ = [
        ("json_metadata", ctypes.c_char_p),
    ]


class MetadataUpdateCStruct(ctypes.Structure):
    """
    Internal C structure for MetadataUpdate.
    Used only for C library communication.
    """

    _fields_ = [
        ("compid", ctypes.c_uint32),
        ("type", ctypes.c_int),
        ("json_metadata", ctypes.c_char_p),
    ]


# ===== Structures =====
class MetadataData:
    """
    Metadata response
    """

    def __init__(self, json_metadata=None):
        self.json_metadata = json_metadata

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.json_metadata = c_struct.json_metadata.decode("utf-8")
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = MetadataDataCStruct()
        c_struct.json_metadata = self.json_metadata.encode("utf-8")
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"json_metadata={self.json_metadata}")
        return f"MetadataData({', '.join(fields)})"


class MetadataUpdate:
    """
    Metadata for a given component and type
    """

    def __init__(self, compid=None, type=None, json_metadata=None):
        self.compid = compid
        self.type = type
        self.json_metadata = json_metadata

    @classmethod
    def from_c_struct(cls, c_struct):
        """Convert from C structure to Python object"""
        instance = cls()
        instance.compid = c_struct.compid
        instance.type = MetadataType(c_struct.type)
        instance.json_metadata = c_struct.json_metadata.decode("utf-8")
        return instance

    def to_c_struct(self):
        """Convert to C structure for C library calls"""
        c_struct = MetadataUpdateCStruct()
        c_struct.compid = self.compid
        c_struct.type = int(self.type)
        c_struct.json_metadata = self.json_metadata.encode("utf-8")
        return c_struct

    def __str__(self):
        fields = []
        fields.append(f"compid={self.compid}")
        fields.append(f"type={self.type}")
        fields.append(f"json_metadata={self.json_metadata}")
        return f"MetadataUpdate({', '.join(fields)})"


# ===== Plugin =====
class ComponentMetadata:
    """Access component metadata json definitions, such as parameters."""

    def __init__(self, system):
        self._lib = _cmavsdk_lib
        self._handle = None
        self._callbacks = []  # Keep references to prevent GC

        if system is None:
            raise ValueError("system cannot be None")

        system_handle = system._handle

        if not system_handle:
            raise ValueError("system handle is null")

        self._handle = self._lib.mavsdk_component_metadata_create(system_handle)

        if not self._handle:
            raise RuntimeError(
                "Failed to create ComponentMetadata plugin - C function returned null handle"
            )

    def request_component(self, compid):
        """Get request_component (blocking)"""

        self._lib.mavsdk_component_metadata_request_component(
            self._handle,
            compid,
        )

    def request_autopilot_component(self):
        """Get request_autopilot_component (blocking)"""

        self._lib.mavsdk_component_metadata_request_autopilot_component(
            self._handle,
        )

    def subscribe_metadata_available(self, callback: Callable, user_data: Any = None):
        """Register a callback that gets called when metadata is available"""

        def c_callback(c_data, ud):
            try:
                py_data = MetadataUpdate.from_c_struct(c_data)

                self._lib.mavsdk_component_metadata_metadata_update_destroy(
                    ctypes.byref(c_data)
                )

                callback(py_data, user_data)

            except Exception as e:
                print(f"Error in metadata_available callback: {e}")

        cb = MetadataAvailableCallback(c_callback)
        self._callbacks.append(cb)

        return self._lib.mavsdk_component_metadata_subscribe_metadata_available(
            self._handle, cb, None
        )

    def unsubscribe_metadata_available(self, handle: ctypes.c_void_p):
        """Unsubscribe from metadata_available"""
        self._lib.mavsdk_component_metadata_unsubscribe_metadata_available(
            self._handle, handle
        )

    def get_metadata(self, compid, metadata_type):
        """Get get_metadata (blocking)"""

        result_out = MetadataDataCStruct()

        result_code = self._lib.mavsdk_component_metadata_get_metadata(
            self._handle, compid, metadata_type, ctypes.byref(result_out)
        )
        result = ComponentMetadataResult(result_code)
        if result != ComponentMetadataResult.SUCCESS:
            raise Exception(f"get_metadata failed: {result}")

        py_result = MetadataData.from_c_struct(result_out)
        self._lib.mavsdk_component_metadata_metadata_data_destroy(
            ctypes.byref(result_out)
        )
        return py_result

    def destroy(self):
        """Destroy the plugin instance"""
        if self._handle:
            self._lib.mavsdk_component_metadata_destroy(self._handle)
            self._handle = None

    def __del__(self):
        self.destroy()


# ===== Callback Types =====
MetadataAvailableCallback = ctypes.CFUNCTYPE(
    None, MetadataUpdateCStruct, ctypes.c_void_p
)

# ===== Setup Functions =====
_cmavsdk_lib.mavsdk_component_metadata_create.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_component_metadata_create.restype = ctypes.c_void_p

_cmavsdk_lib.mavsdk_component_metadata_destroy.argtypes = [ctypes.c_void_p]
_cmavsdk_lib.mavsdk_component_metadata_destroy.restype = None

_cmavsdk_lib.mavsdk_component_metadata_metadata_data_destroy.argtypes = [
    ctypes.POINTER(MetadataDataCStruct)
]
_cmavsdk_lib.mavsdk_component_metadata_metadata_data_destroy.restype = None

_cmavsdk_lib.mavsdk_component_metadata_metadata_update_destroy.argtypes = [
    ctypes.POINTER(MetadataUpdateCStruct)
]
_cmavsdk_lib.mavsdk_component_metadata_metadata_update_destroy.restype = None


_cmavsdk_lib.mavsdk_component_metadata_request_component.argtypes = [
    ctypes.c_void_p,
    ctypes.c_uint32,
]

_cmavsdk_lib.mavsdk_component_metadata_request_component.restype = None

_cmavsdk_lib.mavsdk_component_metadata_request_autopilot_component.argtypes = [
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_component_metadata_request_autopilot_component.restype = None
_cmavsdk_lib.mavsdk_component_metadata_subscribe_metadata_available.argtypes = [
    ctypes.c_void_p,
    MetadataAvailableCallback,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_component_metadata_subscribe_metadata_available.restype = (
    ctypes.c_void_p
)
# Unsubscribe
_cmavsdk_lib.mavsdk_component_metadata_unsubscribe_metadata_available.argtypes = [
    ctypes.c_void_p,
    ctypes.c_void_p,
]

_cmavsdk_lib.mavsdk_component_metadata_unsubscribe_metadata_available.restype = None


_cmavsdk_lib.mavsdk_component_metadata_get_metadata.argtypes = [
    ctypes.c_void_p,
    ctypes.c_uint32,
    ctypes.c_int,
    ctypes.POINTER(MetadataDataCStruct),
]

_cmavsdk_lib.mavsdk_component_metadata_get_metadata.restype = ctypes.c_int
